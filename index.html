<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Tu compa√±ero personal de entrenamientos - Seguimiento de volumen, PRs, y progreso">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GymMate - Tu Compa√±ero de Entrenamiento</title>

    <link rel="manifest" href="manifest.json">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#0f172a',
                        'dark-surface': '#1e293b',
                        'accent-blue': '#2563eb',
                        'accent-purple': '#7c3aed',
                        'accent-cyan': '#22d3ee',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'display': ['Oswald', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lottie-web/build/player/lottie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #7c3aed;
            --danger-color: #EF4444;
            --dark-bg: #0f172a;
            --dark-surface: #1e293b;
            --accent-cyan: #22d3ee;
        }

        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--dark-bg);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }

        /* Glass Card Effect */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
        }

        /* Glow Effect */
        .glow-bg {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(37, 99, 235, 0.2), transparent 70%);
            filter: blur(40px);
            z-index: -1;
        }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Avatar Ring Gradient */
        .ring-gradient {
            position: relative;
        }

        .ring-gradient::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            z-index: -1;
        }

        .input-error {
            border: 2px solid #EF4444;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .progress-bar-fill {
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input:focus, select:focus, button:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .timer-active {
            animation: pulse-glow 2s infinite;
        }

        /* Mobile-first touch targets */
        @media (max-width: 768px) {
            input, button, select {
                min-height: 44px;
                font-size: 16px; /* Prevents iOS zoom */
            }

            .exercise-card {
                padding: 1rem;
            }

            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* Swipe indicator */
        .swipe-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .swipe-indicator.show {
            opacity: 1;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .pr-badge {
            display: inline-block;
            background: #F59E0B;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        /* Bottom navigation for mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0.75rem 0 1.5rem 0;
            padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
            z-index: 100;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: #9ca3af;
            cursor: pointer;
            flex: 1;
            padding: 0.5rem;
        }

        .bottom-nav-item.active {
            color: var(--accent-cyan);
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
        }

        /* FAB - Floating Action Button */
        .fab {
            position: relative;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);
            margin-top: -32px;
            cursor: pointer;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            opacity: 0.5;
            filter: blur(8px);
            z-index: -1;
        }

        /* Hide scrollbar but keep functionality */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-dark-bg min-h-screen pb-32 font-sans">
    <!-- Header with Profile -->
    <header class="px-6 pt-8 pb-6">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-gray-400 text-sm mb-1">üí™ Tu compa√±ero de entrenamiento</p>
                <h1 class="text-3xl font-display font-bold uppercase tracking-wide">GymMate</h1>
            </div>
            <div class="flex items-center gap-3">
                <!-- Hidden buttons for JS compatibility -->
                <button id="darkModeToggle" class="hidden"></button>
                <button id="statsBtn" class="glass-card px-4 py-2 rounded-lg text-cyan-400 font-semibold text-sm border border-cyan-500/30 active:scale-95 transition-transform">
                    üìä Stats
                </button>
                <div class="ring-gradient">
                    <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-2xl">
                        üèãÔ∏è
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="px-6 space-y-6">
        <!-- Hero Section - Estado Actual -->
        <section class="relative glass-card p-6 overflow-hidden">
            <div class="glow-bg"></div>
            <div class="relative z-10">
                <p class="text-gray-400 text-sm mb-2">HOY TOCA</p>
                <h2 class="text-2xl font-display font-bold mb-1 gradient-text">PIERNAS + GL√öTEOS</h2>
                <p class="text-sm text-gray-400 mb-6">√öltima vez: hace 3 d√≠as</p>
                <button id="startWorkoutBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-4 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform">
                    COMENZAR ENTRENAMIENTO
                </button>
            </div>
        </section>

        <!-- Grid de Herramientas - Quick Actions -->
        <section class="grid grid-cols-2 gap-4">
            <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform cursor-pointer" data-action="calculators">
                <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center">
                    <i class="ph-bold ph-calculator text-purple-400 text-2xl"></i>
                </div>
                <span class="text-sm font-medium">1RM Calc</span>
            </div>
            <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform cursor-pointer" data-action="history">
                <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center">
                    <i class="ph-bold ph-clock-counter-clockwise text-cyan-400 text-2xl"></i>
                </div>
                <span class="text-sm font-medium">Historial</span>
            </div>
            <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform cursor-pointer" data-action="charts">
                <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center">
                    <i class="ph-bold ph-chart-line text-blue-400 text-2xl"></i>
                </div>
                <span class="text-sm font-medium">Progreso</span>
            </div>
            <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform cursor-pointer" data-action="prs">
                <div class="w-12 h-12 rounded-xl bg-yellow-500/10 flex items-center justify-center">
                    <i class="ph-bold ph-trophy text-yellow-400 text-2xl"></i>
                </div>
                <span class="text-sm font-medium">PRs</span>
            </div>
        </section>

        <!-- Selector de Rutinas (Sin <select>) -->
        <section>
            <h3 class="text-lg font-display font-bold uppercase mb-4 tracking-wide">RUTINAS DISPONIBLES</h3>

            <!-- Select oculto para mantener compatibilidad con JavaScript -->
            <select id="grupoSelect" class="hidden">
                <option value="">-- Elige tu entrenamiento --</option>
                <option value="grupo1">ü¶µ GRUPO 1 - Piernas + Gl√∫teos</option>
                <option value="grupo2">üí™ GRUPO 2 - Upper Push</option>
                <option value="grupo3">üèãÔ∏è GRUPO 3 - Piernas Quad Dominante</option>
                <option value="grupo4">üî± GRUPO 4 - Espalda + B√≠ceps</option>
                <option value="grupo5">üèÜ GRUPO 5 - Hombro + Tr√≠ceps</option>
            </select>

            <div class="space-y-3">
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo1">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-pink-500/10 flex items-center justify-center text-2xl">
                            ü¶µ
                        </div>
                        <div>
                            <p class="font-semibold">Piernas + Gl√∫teos</p>
                            <p class="text-xs text-gray-400">4 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo2">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center text-2xl">
                            üí™
                        </div>
                        <div>
                            <p class="font-semibold">Upper Push</p>
                            <p class="text-xs text-gray-400">3 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo3">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center text-2xl">
                            üèãÔ∏è
                        </div>
                        <div>
                            <p class="font-semibold">Piernas Quad Dominante</p>
                            <p class="text-xs text-gray-400">2 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center text-2xl">
                            üî±
                        </div>
                        <div>
                            <p class="font-semibold">Espalda + B√≠ceps</p>
                            <p class="text-xs text-gray-400">3 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo5">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-orange-500/10 flex items-center justify-center text-2xl">
                            üèÜ
                        </div>
                        <div>
                            <p class="font-semibold">Hombro + Tr√≠ceps</p>
                            <p class="text-xs text-gray-400">2 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
            </div>
        </section>

        <!-- Hidden sections from original (kept for functionality) -->
        <div id="tabContainer" class="hidden"></div>
        <div id="aiSuggestionsBanner" class="hidden"></div>
        <div id="workoutTab" class="tab-content active">
            <div id="restTimerBanner" class="hidden"></div>
            <div id="trainingInfo" class="hidden"></div>

            <!-- Quick Stats Cards -->
            <div id="quickStats" class="hidden grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div class="stat-card">
                    <p class="text-xs opacity-90">Volumen Total</p>
                    <p class="text-2xl font-bold" id="statVolume">0</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <p class="text-xs opacity-90">Ejercicios</p>
                    <p class="text-2xl font-bold" id="statExercises">0</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <p class="text-xs opacity-90">Sets Totales</p>
                    <p class="text-2xl font-bold" id="statSets">0</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <p class="text-xs opacity-90">Completados</p>
                    <p class="text-2xl font-bold" id="statCompleted">0</p>
                </div>
            </div>

            <!-- Exercises Container -->
            <section id="ejerciciosContainer" class="hidden">
                <div id="ejerciciosList" class="space-y-3 md:space-y-4"></div>

                <!-- Optional Exercises Section -->
                <div class="mt-6 md:mt-8 bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 md:p-6">
                    <h3 class="text-lg md:text-xl font-bold text-gray-900 mb-4">üìå Ejercicios Opcionales</h3>
                    <div id="opcionalesList" class="space-y-3 md:space-y-4"></div>
                </div>
            </section>

            <!-- Volume Summary -->
            <section id="volumeSummary" class="hidden mt-6 md:mt-8 bg-white rounded-xl shadow-lg p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-900 mb-6">üìä Resumen de Volumen</h2>
                <div id="volumeBars" class="space-y-4"></div>
                <div class="mt-6 pt-6 border-t-2 border-gray-200">
                    <p class="text-lg md:text-xl font-bold text-gray-900">Volumen Total: <span id="totalVolume" class="text-blue-600">0</span></p>
                </div>
            </section>

            <!-- Save Button -->
            <div id="saveSection" class="hidden mt-6 md:mt-8">
                <button id="saveButton" class="btn-primary w-full text-lg">
                    üíæ Guardar Entrenamiento
                </button>
                <p id="saveMessage" class="mt-4 text-green-600 font-semibold text-center hidden"></p>
            </div>
        </div>

        <!-- Calculators Tab -->
        <div id="calculatorsTab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- 1RM Calculator -->
                <div class="glass-card p-4 md:p-6">
                    <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-2">üí™ Calculadora de 1RM</h2>
                    <p class="text-sm text-gray-400 mb-4">Estima tu m√°ximo para 1 repetici√≥n bas√°ndose en tu mejor rendimiento reciente</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Selecciona Ejercicio:</label>
                            <select id="rm1ExerciseSelect" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-blue-500">
                                <option value="">-- Elige un ejercicio --</option>
                            </select>
                        </div>
                    </div>

                    <div id="rm1Results" class="hidden">
                        <div class="bg-blue-500/10 border-l-4 border-blue-500 p-4 rounded-lg backdrop-blur-sm">
                            <p class="text-sm text-gray-300 mb-2"><strong>Mejor registro:</strong> <span id="rm1BestRecord"></span></p>
                            <div class="grid grid-cols-3 gap-3 mt-4">
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Epley</p>
                                    <p class="text-2xl font-bold gradient-text" id="rm1Epley">-</p>
                                    <p class="text-xs text-gray-500">kg</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Brzycki</p>
                                    <p class="text-2xl font-bold gradient-text" id="rm1Brzycki">-</p>
                                    <p class="text-xs text-gray-500">kg</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Lombardi</p>
                                    <p class="text-2xl font-bold gradient-text" id="rm1Lombardi">-</p>
                                    <p class="text-xs text-gray-500">kg</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-3 text-center">Promedio de 3 f√≥rmulas cient√≠ficas basadas en tu mejor rendimiento</p>
                        </div>
                    </div>
                </div>

                <!-- Calories Calculator -->
                <div class="glass-card p-4 md:p-6">
                    <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-2">üî• Calculadora de Calor√≠as</h2>
                    <p class="text-sm text-gray-400 mb-4">Calcula tu gasto cal√≥rico diario y requerimientos nutricionales</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Edad:</label>
                            <input type="number" id="caloriesAge" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500" placeholder="Ej: 25">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Sexo:</label>
                            <select id="caloriesGender" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500">
                                <option value="male">Hombre</option>
                                <option value="female">Mujer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Peso (kg):</label>
                            <input type="number" id="caloriesWeight" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500" placeholder="Ej: 70">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Altura (cm):</label>
                            <input type="number" id="caloriesHeight" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500" placeholder="Ej: 175">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Nivel de Actividad:</label>
                            <select id="caloriesActivity" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500">
                                <option value="1.2">Sedentario (poco o ning√∫n ejercicio)</option>
                                <option value="1.375">Ligero (1-3 d√≠as/semana)</option>
                                <option value="1.55" selected>Moderado (3-5 d√≠as/semana)</option>
                                <option value="1.725">Activo (6-7 d√≠as/semana)</option>
                                <option value="1.9">Muy Activo (2 veces al d√≠a)</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="calculateCalories()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-semibold py-3 rounded-xl shadow-lg shadow-orange-500/30 active:scale-95 transition-transform mb-4">
                        Calcular
                    </button>

                    <div id="caloriesResults" class="hidden">
                        <div class="bg-orange-500/10 border-l-4 border-orange-500 p-4 rounded-lg backdrop-blur-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-400">BMR (Metabolismo Basal)</p>
                                    <p class="text-2xl font-bold text-orange-400" id="bmrResult">-</p>
                                    <p class="text-xs text-gray-500">kcal/d√≠a</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">TDEE (Gasto Total)</p>
                                    <p class="text-2xl font-bold text-orange-400" id="tdeeResult">-</p>
                                    <p class="text-xs text-gray-500">kcal/d√≠a</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mt-4 pt-4 border-t border-orange-500/20">
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">D√©ficit (-20%)</p>
                                    <p class="text-lg font-bold text-red-400" id="deficitResult">-</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Mantenimiento</p>
                                    <p class="text-lg font-bold text-green-400" id="maintenanceResult">-</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Super√°vit (+20%)</p>
                                    <p class="text-lg font-bold text-blue-400" id="surplusResult">-</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-3 text-center">Basado en f√≥rmula de Mifflin-St Jeor y tu nivel de actividad</p>
                        </div>
                    </div>
                </div>

                <!-- Progressive Weight Calculator -->
                <div class="glass-card p-4 md:p-6">
                    <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-2">üìà Calculadora de Peso Progresivo</h2>
                    <p class="text-sm text-gray-400 mb-4">Planifica tu pr√≥ximo incremento de peso bas√°ndote en tu historial</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Selecciona Ejercicio:</label>
                            <select id="progressiveExerciseSelect" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-green-500">
                                <option value="">-- Elige un ejercicio --</option>
                            </select>
                        </div>
                    </div>

                    <div id="progressiveResults" class="hidden">
                        <div class="bg-green-500/10 border-l-4 border-green-500 p-4 rounded-lg backdrop-blur-sm">
                            <p class="text-sm text-gray-300 mb-3"><strong>Peso actual:</strong> <span id="progressiveCurrentWeight"></span></p>

                            <div class="space-y-3">
                                <div class="bg-dark-surface/50 rounded-lg p-3 border border-green-500/20">
                                    <p class="text-sm font-semibold text-gray-200">Opci√≥n 1: Incremento Conservador</p>
                                    <p class="text-xl font-bold text-green-400 mt-1" id="progressiveConservative">-</p>
                                    <p class="text-xs text-gray-500">+2.5kg - Ideal para principiantes</p>
                                </div>

                                <div class="bg-dark-surface/50 rounded-lg p-3 border border-blue-500/20">
                                    <p class="text-sm font-semibold text-gray-200">Opci√≥n 2: Incremento Moderado</p>
                                    <p class="text-xl font-bold text-blue-400 mt-1" id="progressiveModerate">-</p>
                                    <p class="text-xs text-gray-500">+5kg - Para intermedios</p>
                                </div>

                                <div class="bg-dark-surface/50 rounded-lg p-3 border border-purple-500/20">
                                    <p class="text-sm font-semibold text-gray-200">Opci√≥n 3: Incremento Agresivo</p>
                                    <p class="text-xl font-bold text-purple-400 mt-1" id="progressiveAggressive">-</p>
                                    <p class="text-xs text-gray-500">+10kg - Para avanzados</p>
                                </div>
                            </div>

                            <p class="text-xs text-gray-500 mt-3 text-center">Basado en tu mejor rendimiento registrado</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Tab -->
        <div id="chartsTab" class="tab-content hidden">
            <div class="space-y-6">
                <!-- Export Button -->
                <div class="glass-card p-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-display font-bold uppercase">üìä An√°lisis de Progreso</h2>
                        <button id="exportToExcelBtn" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-lg shadow-green-500/30 active:scale-95 transition-transform">
                            üì• Exportar a Excel
                        </button>
                    </div>
                </div>

                <!-- Volume Trend Chart -->
                <div class="glass-card p-4 md:p-6">
                    <h3 class="text-lg font-bold text-white mb-2">Tendencia de Volumen (√öltimos 30 d√≠as)</h3>
                    <p class="text-xs text-gray-400 mb-4">Visualiza tu progreso de volumen total a lo largo del tiempo</p>
                    <canvas id="volumeTrendChart" class="w-full" style="max-height: 300px;"></canvas>
                </div>

                <!-- Muscle Group Distribution -->
                <div class="glass-card p-4 md:p-6">
                    <h3 class="text-lg font-bold text-white mb-2">Distribuci√≥n por Grupo Muscular</h3>
                    <p class="text-xs text-gray-400 mb-4">Identifica qu√© grupos musculares has entrenado m√°s en tu historial</p>
                    <canvas id="muscleDistributionChart" class="w-full" style="max-height: 300px;"></canvas>
                </div>

                <!-- Weight Progress by Exercise -->
                <div class="glass-card p-4 md:p-6">
                    <h3 class="text-lg font-bold text-white mb-2">Progresi√≥n de Peso por Ejercicio</h3>
                    <p class="text-xs text-gray-400 mb-4">Rastrea tu evoluci√≥n de fuerza en cada ejercicio espec√≠fico</p>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Selecciona Ejercicio:</label>
                        <select id="exerciseChartSelect" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-blue-500">
                            <option value="">-- Elige un ejercicio --</option>
                        </select>
                    </div>
                    <canvas id="weightProgressChart" class="w-full" style="max-height: 300px;"></canvas>
                </div>

                <!-- Weekly Volume Comparison -->
                <div class="glass-card p-4 md:p-6">
                    <h3 class="text-lg font-bold text-white mb-2">Comparativa Semanal</h3>
                    <p class="text-xs text-gray-400 mb-4">Compara tu volumen total acumulado por semana</p>
                    <canvas id="weeklyComparisonChart" class="w-full" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content hidden">
            <div class="glass-card p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-4">üìÖ Historial de Entrenamientos</h2>
                <div id="historyList" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">No hay entrenamientos guardados a√∫n</p>
                </div>
            </div>
        </div>

        <!-- PRs Tab -->
        <div id="prsTab" class="tab-content hidden">
            <div class="glass-card p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-4">üèÜ Personal Records</h2>
                <div id="prsList" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">Registra tus primeros entrenamientos para ver tus PRs</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation Bar with FAB -->
    <nav class="bottom-nav">
        <div class="bottom-nav-item active" data-nav="home">
            <i class="ph-bold ph-house text-xl"></i>
            <span>Inicio</span>
        </div>
        <div class="bottom-nav-item" data-nav="charts">
            <i class="ph-bold ph-chart-line text-xl"></i>
            <span>Gr√°ficos</span>
        </div>
        <div class="fab" id="fabButton">
            <i class="ph-bold ph-plus text-white text-3xl"></i>
        </div>
        <div class="bottom-nav-item" data-nav="history">
            <i class="ph-bold ph-clock-counter-clockwise text-xl"></i>
            <span>Historial</span>
        </div>
        <div class="bottom-nav-item" data-nav="profile">
            <i class="ph-bold ph-user text-xl"></i>
            <span>Perfil</span>
        </div>
    </nav>

    <!-- Animation Modal -->
    <div id="animationModal" class="modal">
        <div class="glass-card p-4 md:p-6 max-w-2xl w-full mx-4 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-lg md:text-2xl font-display font-bold uppercase text-white"></h3>
                <button id="closeModal" class="text-gray-400 hover:text-white text-3xl font-bold transition-colors">&times;</button>
            </div>
            <div id="animationContainer" class="bg-dark-surface rounded-xl p-4 min-h-[300px] md:min-h-[400px] flex items-center justify-center border border-white/10">
                <p class="text-gray-400">Cargando animaci√≥n...</p>
            </div>
        </div>
    </div>

    <!-- Rest Timer Modal -->
    <div id="restTimerModal" class="modal">
        <div class="glass-card p-6 max-w-md w-full mx-4">
            <h3 class="text-2xl font-display font-bold uppercase mb-4">‚è±Ô∏è Tiempo de Descanso</h3>
            <p class="text-gray-400 mb-4">¬øCu√°nto tiempo quieres descansar?</p>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="60">1 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="90">1.5 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="120">2 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="180">3 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="240">4 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="300">5 min</button>
            </div>
            <button id="closeRestModal" class="w-full bg-dark-surface border border-white/10 hover:bg-dark-surface/80 text-gray-300 font-bold py-3 rounded-xl active:scale-95 transition-transform">
                Cancelar
            </button>
        </div>
    </div>

    <script>
        // ==========================================
        // EXERCISE GIF MAPPING (ExerciseDB API)
        // ==========================================
        const exerciseGifs = {
            // Using royalty-free exercise GIFs from ExerciseDB
            "Hip Thrust (core lift)": "https://v2.exercisedb.io/image/ZKKb6Z4EGfvjjt",
            "RDL": "https://v2.exercisedb.io/image/dKO2KpmNxnSzA8",
            "Prensa": "https://v2.exercisedb.io/image/yS6X5TtfxGUTc5",
            "Abducciones": "https://v2.exercisedb.io/image/zzgAAGg97d9JXR",
            "Aducciones": "https://v2.exercisedb.io/image/OAOqDpCw5ck0Sf",
            "Extensi√≥n de cu√°driceps": "https://v2.exercisedb.io/image/iJaSj1CpvL0HrM",
            "Press militar": "https://v2.exercisedb.io/image/qcDSkbQrRbJ-WG",
            "Elevaci√≥n lateral": "https://v2.exercisedb.io/image/o4M0r8zJMpUFZ5",
            "Press de pecho": "https://v2.exercisedb.io/image/xV3AFOKp73FXBD",
            "Elevaci√≥n frontal / Y-Raise": "https://v2.exercisedb.io/image/tVwcF-w-JzpUqb",
            "Tr√≠ceps cuerda": "https://v2.exercisedb.io/image/KjV4JdQn-iSCar",
            "Extensi√≥n o fondos": "https://v2.exercisedb.io/image/UItWB8wKvO09ym",
            "Face pull (opcional)": "https://v2.exercisedb.io/image/vHqvRdO9TgNYPb",
            "Hack squat": "https://v2.exercisedb.io/image/kqeXy9u9r0PEqB",
            "Zancada estacionaria": "https://v2.exercisedb.io/image/2-5kfvlGI3nN0p",
            "Prensa quad-dominante": "https://v2.exercisedb.io/image/yS6X5TtfxGUTc5",
            "Jal√≥n pecho": "https://v2.exercisedb.io/image/4wPc8Y4m0jF5l6",
            "Remo sentado": "https://v2.exercisedb.io/image/Fc64ZUEJh4mU1C",
            "Remo mancuerna": "https://v2.exercisedb.io/image/DPwPVGFmHdNPKM",
            "Curl barra": "https://v2.exercisedb.io/image/bZ7Wi5SJgFJ5Jm",
            "Curl martillo": "https://v2.exercisedb.io/image/1oqh7xzIU2t0Cg",
            "Curl martillo cross-body": "https://v2.exercisedb.io/image/PwgVqy3k5O6Bev",
            "Tr√≠ceps aislado": "https://v2.exercisedb.io/image/TN8xBxkVYfQ5e9",
            "Hip Thrust ligero": "https://v2.exercisedb.io/image/ZKKb6Z4EGfvjjt",
            "Abs en m√°quina": "https://v2.exercisedb.io/image/QE-5xfWhjuWVj7"
        };

        // ==========================================
        // DATA STRUCTURE - All Training Groups
        // ==========================================
        const trainingGroups = {
            grupo1: {
                nombre: "GRUPO 1 - Piernas + Gl√∫teos",
                ejercicios: [
                    { nombre: "Hip Thrust (core lift)", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "RDL", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Prensa", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Abducciones", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Aducciones", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Extensi√≥n de cu√°driceps", esMancuerna: false, grupoMuscular: "Piernas" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            },
            grupo2: {
                nombre: "GRUPO 2 - Upper Push",
                ejercicios: [
                    { nombre: "Press militar", esMancuerna: false, grupoMuscular: "Hombros" },
                    { nombre: "Elevaci√≥n lateral", esMancuerna: true, grupoMuscular: "Hombros" },
                    { nombre: "Press de pecho", esMancuerna: false, grupoMuscular: "Pecho" },
                    { nombre: "Elevaci√≥n frontal / Y-Raise", esMancuerna: true, grupoMuscular: "Hombros" },
                    { nombre: "Tr√≠ceps cuerda", esMancuerna: false, grupoMuscular: "Tr√≠ceps" },
                    { nombre: "Extensi√≥n o fondos", esMancuerna: false, grupoMuscular: "Tr√≠ceps" },
                    { nombre: "Face pull (opcional)", esMancuerna: false, grupoMuscular: "Hombros" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            },
            grupo3: {
                nombre: "GRUPO 3 - Piernas Quad Dominante",
                ejercicios: [
                    { nombre: "Hack squat", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Extensi√≥n de cu√°driceps", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Zancada estacionaria", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Prensa quad-dominante", esMancuerna: false, grupoMuscular: "Piernas" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            },
            grupo4: {
                nombre: "GRUPO 4 - Espalda + B√≠ceps",
                ejercicios: [
                    { nombre: "Jal√≥n pecho", esMancuerna: false, grupoMuscular: "Espalda" },
                    { nombre: "Remo sentado", esMancuerna: false, grupoMuscular: "Espalda" },
                    { nombre: "Remo mancuerna", esMancuerna: true, grupoMuscular: "Espalda" },
                    { nombre: "Curl barra", esMancuerna: false, grupoMuscular: "B√≠ceps" },
                    { nombre: "Curl martillo", esMancuerna: true, grupoMuscular: "B√≠ceps" },
                    { nombre: "Curl martillo cross-body", esMancuerna: true, grupoMuscular: "B√≠ceps" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            },
            grupo5: {
                nombre: "GRUPO 5 - Hombro + Tr√≠ceps (aislamiento)",
                ejercicios: [
                    { nombre: "Elevaci√≥n lateral", esMancuerna: true, grupoMuscular: "Hombros" },
                    { nombre: "Elevaci√≥n frontal", esMancuerna: true, grupoMuscular: "Hombros" },
                    { nombre: "Press ligero o m√°quinas", esMancuerna: false, grupoMuscular: "Hombros" },
                    { nombre: "Tr√≠ceps aislado", esMancuerna: false, grupoMuscular: "Tr√≠ceps" },
                    { nombre: "Finisher hombro (30-20-10): Lateral ‚Üí Frontal ‚Üí Press", esMancuerna: false, grupoMuscular: "Hombros" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            }
        };

        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        let currentGroup = null;
        let sessionData = {
            date: new Date().toISOString().split('T')[0],
            grupo: "",
            ejercicios: [],
            volumenTotal: 0,
            volumenPorGrupo: {}
        };

        let restTimer = null;
        let restTimeRemaining = 0;
        let isPaused = false;

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================

        function calculateVolume(sets, reps, peso, esMancuerna) {
            const pesoFinal = esMancuerna ? peso * 2 : peso;
            return sets * reps * pesoFinal;
        }

        function validateDecimalInput(input) {
            const value = input.value;
            if (value.includes(',')) {
                input.classList.add('input-error');
                showError(input, 'Usa punto (.) para decimales');
                return false;
            } else {
                input.classList.remove('input-error');
                hideError(input);
                return true;
            }
        }

        function showError(input, message) {
            let errorDiv = input.parentElement.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message text-red-500 text-sm mt-1';
                input.parentElement.appendChild(errorDiv);
            }
            errorDiv.textContent = message;
        }

        function hideError(input) {
            const errorDiv = input.parentElement.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        function calculateVolumenPorGrupo() {
            const volumenPorGrupo = {};

            sessionData.ejercicios.forEach(ej => {
                // Only count exercises with actual volume
                if (ej.volumen > 0) {
                    const grupo = ej.grupoMuscular;
                    if (!volumenPorGrupo[grupo]) {
                        volumenPorGrupo[grupo] = 0;
                    }
                    volumenPorGrupo[grupo] += ej.volumen;
                }
            });

            sessionData.volumenPorGrupo = volumenPorGrupo;
            return volumenPorGrupo;
        }

        function updateVolumeDisplay() {
            const volumenPorGrupo = calculateVolumenPorGrupo();
            const volumeBarsContainer = document.getElementById('volumeBars');

            // Only show if there are muscle groups with volume
            if (Object.keys(volumenPorGrupo).length === 0) {
                volumeBarsContainer.innerHTML = '<p class="text-gray-600 text-center py-4">Ingresa datos para ver el resumen de volumen</p>';
                return;
            }

            const maxVolume = Math.max(...Object.values(volumenPorGrupo));

            let html = '';
            for (const [grupo, volumen] of Object.entries(volumenPorGrupo)) {
                const percentage = maxVolume > 0 ? (volumen / maxVolume) * 100 : 0;
                html += `
                    <div class="mb-4">
                        <div class="flex justify-between mb-2">
                            <span class="font-semibold text-gray-900">${grupo}</span>
                            <span class="text-gray-700">${volumen.toFixed(0)} (${percentage.toFixed(0)}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div class="progress-bar-fill bg-blue-500 h-6 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }

            volumeBarsContainer.innerHTML = html;

            const totalVolume = Object.values(volumenPorGrupo).reduce((sum, vol) => sum + vol, 0);
            sessionData.volumenTotal = totalVolume;
            document.getElementById('totalVolume').textContent = totalVolume.toFixed(0);

            // Update quick stats
            updateQuickStats();
        }

        function updateQuickStats() {
            const completedCount = sessionData.ejercicios.filter(ej => ej.completado && ej.volumen > 0).length;
            const totalSets = sessionData.ejercicios.reduce((sum, ej) => sum + ej.sets, 0);
            const exercisesWithData = sessionData.ejercicios.filter(ej => ej.volumen > 0).length;

            document.getElementById('statVolume').textContent = sessionData.volumenTotal.toFixed(0);
            document.getElementById('statExercises').textContent = exercisesWithData;
            document.getElementById('statSets').textContent = totalSets;
            document.getElementById('statCompleted').textContent = completedCount;
        }

        function renderEjercicio(ejercicio, index, esOpcional = false) {
            const ejercicioData = sessionData.ejercicios[index] || {
                nombre: ejercicio.nombre,
                sets: 0,
                reps: 0,
                peso: 0,
                esMancuerna: ejercicio.esMancuerna,
                grupoMuscular: ejercicio.grupoMuscular,
                volumen: 0,
                completado: false
            };

            if (!sessionData.ejercicios[index]) {
                sessionData.ejercicios[index] = ejercicioData;
            }

            const volumen = ejercicioData.volumen || 0;
            const gifUrl = exerciseGifs[ejercicio.nombre] || '';

            return `
                <div class="exercise-card bg-white rounded-xl shadow-md p-4 md:p-6 ${esOpcional ? 'border-2 border-yellow-400' : ''}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-start gap-3 flex-1">
                            <input type="checkbox"
                                   id="completado-${index}"
                                   class="w-6 h-6 text-blue-600 rounded mt-1"
                                   ${ejercicioData.completado ? 'checked' : ''}
                                   onchange="toggleCompletado(${index})">
                            <div class="flex-1">
                                <h3 class="text-base md:text-xl font-bold text-gray-900 leading-tight">${ejercicio.nombre}</h3>
                                <p class="text-xs md:text-sm text-gray-600 mt-1">
                                    ${ejercicio.grupoMuscular}
                                    ${ejercicio.esMancuerna ? ' ‚Ä¢ <span class="text-blue-600 font-semibold">üí™ √ó2</span>' : ''}
                                </p>
                            </div>
                        </div>
                        <button onclick="showAnimation('${ejercicio.nombre}', '${gifUrl}')"
                                class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-2 rounded-lg text-xs md:text-sm font-semibold whitespace-nowrap ml-2">
                            üé¨ Ver
                        </button>
                    </div>

                    <div class="grid grid-cols-3 gap-2 md:gap-4 mb-4">
                        <div>
                            <label class="block text-xs md:text-sm font-semibold text-gray-700 mb-2">Sets</label>
                            <input type="number"
                                   id="sets-${index}"
                                   value="${ejercicioData.sets}"
                                   min="0"
                                   class="w-full px-2 md:px-3 py-2 border-2 border-gray-300 rounded-lg text-center"
                                   oninput="updateEjercicio(${index})">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-semibold text-gray-700 mb-2">Reps</label>
                            <input type="number"
                                   id="reps-${index}"
                                   value="${ejercicioData.reps}"
                                   min="0"
                                   class="w-full px-2 md:px-3 py-2 border-2 border-gray-300 rounded-lg text-center"
                                   oninput="updateEjercicio(${index})">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-semibold text-gray-700 mb-2">Peso (kg)</label>
                            <input type="text"
                                   id="peso-${index}"
                                   value="${ejercicioData.peso}"
                                   class="w-full px-2 md:px-3 py-2 border-2 border-gray-300 rounded-lg text-center"
                                   oninput="updateEjercicio(${index})"
                                   onblur="validateDecimalInput(this)">
                        </div>
                    </div>

                    <div class="flex justify-between items-center flex-wrap gap-2">
                        <div class="flex gap-2">
                            <button onclick="addSet(${index})"
                                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                                + Set
                            </button>
                            <button onclick="startRestTimer()"
                                    class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-semibold text-sm">
                                ‚è±Ô∏è
                            </button>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-600">Volumen</p>
                            <p class="text-xl md:text-2xl font-bold text-blue-600" id="volumen-${index}">${volumen.toFixed(0)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadTrainingGroup(grupoId) {
            currentGroup = grupoId;
            const grupo = trainingGroups[grupoId];

            sessionData.grupo = grupo.nombre;
            sessionData.ejercicios = [];

            document.getElementById('trainingInfo').classList.remove('hidden');
            document.getElementById('currentTraining').textContent = grupo.nombre;
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES');

            let html = '';
            grupo.ejercicios.forEach((ej, index) => {
                html += renderEjercicio(ej, index, false);
            });
            document.getElementById('ejerciciosList').innerHTML = html;

            let opcionalesHtml = '';
            const opcionalesStartIndex = grupo.ejercicios.length;
            grupo.opcionales.forEach((ej, index) => {
                opcionalesHtml += renderEjercicio(ej, opcionalesStartIndex + index, true);
            });
            document.getElementById('opcionalesList').innerHTML = opcionalesHtml;

            document.getElementById('ejerciciosContainer').classList.remove('hidden');
            document.getElementById('volumeSummary').classList.remove('hidden');
            document.getElementById('saveSection').classList.remove('hidden');
            document.getElementById('quickStats').classList.remove('hidden');

            updateVolumeDisplay();
        }

        function updateEjercicio(index) {
            const sets = parseFloat(document.getElementById(`sets-${index}`).value) || 0;
            const reps = parseFloat(document.getElementById(`reps-${index}`).value) || 0;
            const pesoInput = document.getElementById(`peso-${index}`);

            if (!validateDecimalInput(pesoInput)) {
                return;
            }

            const peso = parseFloat(pesoInput.value) || 0;
            const esMancuerna = sessionData.ejercicios[index].esMancuerna;

            const volumen = calculateVolume(sets, reps, peso, esMancuerna);

            sessionData.ejercicios[index].sets = sets;
            sessionData.ejercicios[index].reps = reps;
            sessionData.ejercicios[index].peso = peso;
            sessionData.ejercicios[index].volumen = volumen;

            document.getElementById(`volumen-${index}`).textContent = volumen.toFixed(0);

            // Check for PR
            checkForPR(sessionData.ejercicios[index]);

            updateVolumeDisplay();
        }

        function addSet(index) {
            const setsInput = document.getElementById(`sets-${index}`);
            setsInput.value = (parseFloat(setsInput.value) || 0) + 1;
            updateEjercicio(index);
        }

        function toggleCompletado(index) {
            const checked = document.getElementById(`completado-${index}`).checked;
            sessionData.ejercicios[index].completado = checked;
            updateQuickStats();
        }

        function showAnimation(nombre, gifUrl) {
            document.getElementById('modalTitle').textContent = nombre;
            const container = document.getElementById('animationContainer');

            if (gifUrl) {
                container.innerHTML = `<img src="${gifUrl}" alt="${nombre}" class="w-full max-w-md rounded-lg" onerror="this.parentElement.innerHTML='<p class=&quot;text-gray-600&quot;>Error al cargar la animaci√≥n</p>'">`;
            } else {
                container.innerHTML = '<p class="text-gray-600">Animaci√≥n no disponible.</p>';
            }

            document.getElementById('animationModal').classList.add('active');
        }

        function closeAnimationModal() {
            document.getElementById('animationModal').classList.remove('active');
            document.getElementById('animationContainer').innerHTML = '<p class="text-gray-600">Cargando animaci√≥n...</p>';
        }

        // ==========================================
        // REST TIMER FUNCTIONS
        // ==========================================

        function startRestTimer() {
            document.getElementById('restTimerModal').classList.add('active');
        }

        function initializeTimer(seconds) {
            restTimeRemaining = seconds;
            isPaused = false;

            document.getElementById('restTimerModal').classList.remove('active');
            document.getElementById('restTimerBanner').classList.remove('hidden');

            updateTimerDisplay();

            if (restTimer) clearInterval(restTimer);

            restTimer = setInterval(() => {
                if (!isPaused) {
                    restTimeRemaining--;
                    updateTimerDisplay();

                    if (restTimeRemaining <= 0) {
                        clearInterval(restTimer);
                        playNotificationSound();
                        showNotification('¬°Tiempo de descanso terminado! üí™');
                        document.getElementById('restTimerBanner').classList.add('hidden');
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(restTimeRemaining / 60);
            const seconds = restTimeRemaining % 60;
            document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function pauseTimer() {
            isPaused = !isPaused;
            document.getElementById('pauseTimer').textContent = isPaused ? '‚ñ∂Ô∏è Reanudar' : '‚è∏ Pausar';
        }

        function stopTimer() {
            if (restTimer) clearInterval(restTimer);
            document.getElementById('restTimerBanner').classList.add('hidden');
            restTimeRemaining = 0;
        }

        function playNotificationSound() {
            // Simple beep using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio notification not available');
            }
        }

        function showNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('GymMate', {
                    body: message,
                    icon: '/icon-192.png'
                });
            } else {
                alert(message);
            }
        }

        // ==========================================
        // PR TRACKING
        // ==========================================

        function checkForPR(ejercicioData) {
            if (ejercicioData.volumen === 0) return;

            const prs = JSON.parse(localStorage.getItem('gymmate_prs') || '{}');
            const ejercicioNombre = ejercicioData.nombre;

            if (!prs[ejercicioNombre] || ejercicioData.peso > prs[ejercicioNombre].peso) {
                prs[ejercicioNombre] = {
                    peso: ejercicioData.peso,
                    sets: ejercicioData.sets,
                    reps: ejercicioData.reps,
                    volumen: ejercicioData.volumen,
                    date: new Date().toISOString()
                };
                localStorage.setItem('gymmate_prs', JSON.stringify(prs));

                // Silent PR tracking - no notification to avoid interrupting input
                // PR will update dynamically in the PRs tab
            }
        }

        function loadPRs() {
            const prs = JSON.parse(localStorage.getItem('gymmate_prs') || '{}');
            const prsList = document.getElementById('prsList');

            if (Object.keys(prs).length === 0) {
                prsList.innerHTML = '<p class="text-gray-600 text-center py-8">Registra tus primeros entrenamientos para ver tus PRs</p>';
                return;
            }

            let html = '';
            for (const [nombre, data] of Object.entries(prs)) {
                html += `
                    <div class="bg-gradient-to-r from-yellow-100 to-yellow-200 rounded-xl p-4 border-2 border-yellow-400">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-gray-900">${nombre}</h3>
                                <p class="text-sm text-gray-700 mt-1">
                                    <strong class="text-2xl text-yellow-700">${data.peso}kg</strong> ‚Ä¢ ${data.sets}√ó${data.reps}
                                </p>
                                <p class="text-xs text-gray-600 mt-2">
                                    ${new Date(data.date).toLocaleDateString('es-ES')}
                                </p>
                            </div>
                            <span class="text-4xl">üèÜ</span>
                        </div>
                    </div>
                `;
            }
            prsList.innerHTML = html;
        }

        // ==========================================
        // HISTORY MANAGEMENT
        // ==========================================

        function saveToLocalStorage() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            // Add current session to history
            const sessionCopy = JSON.parse(JSON.stringify(sessionData));
            sessionCopy.savedAt = new Date().toISOString();
            history.unshift(sessionCopy); // Add to beginning

            // Keep only last 30 sessions
            if (history.length > 30) {
                history.length = 30;
            }

            localStorage.setItem('gymmate_history', JSON.stringify(history));
            localStorage.setItem('gymmate_session', JSON.stringify(sessionData));

            const saveMessage = document.getElementById('saveMessage');
            saveMessage.textContent = '‚úÖ Entrenamiento guardado correctamente';
            saveMessage.classList.remove('hidden');

            setTimeout(() => {
                saveMessage.classList.add('hidden');
            }, 3000);

            loadHistory();

            // Generate AI suggestions after saving
            setTimeout(() => {
                generateAISuggestions();
            }, 1000);
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-gray-600 text-center py-8">No hay entrenamientos guardados a√∫n</p>';
                return;
            }

            let html = '';
            history.forEach((session, index) => {
                const date = new Date(session.savedAt || session.date).toLocaleDateString('es-ES', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const completedCount = session.ejercicios.filter(ej => ej.completado).length;
                const totalExercises = session.ejercicios.filter(ej => ej.volumen > 0).length;

                html += `
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-gray-900">${session.grupo}</h3>
                                <p class="text-sm text-gray-600">${date}</p>
                            </div>
                            <button onclick="deleteHistoryItem(${index})" class="text-red-500 hover:text-red-700 text-xl">üóëÔ∏è</button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <div class="bg-white rounded-lg p-2">
                                <p class="text-xs text-gray-600">Volumen Total</p>
                                <p class="text-lg font-bold text-blue-600">${session.volumenTotal.toFixed(0)}</p>
                            </div>
                            <div class="bg-white rounded-lg p-2">
                                <p class="text-xs text-gray-600">Completados</p>
                                <p class="text-lg font-bold text-green-600">${completedCount}/${totalExercises}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            historyList.innerHTML = html;
        }

        function deleteHistoryItem(index) {
            if (confirm('¬øEliminar este entrenamiento del historial?')) {
                const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');
                history.splice(index, 1);
                localStorage.setItem('gymmate_history', JSON.stringify(history));
                loadHistory();
            }
        }

        // ==========================================
        // DARK MODE
        // ==========================================

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('gymmate_darkmode', isDark);
        }

        function loadDarkMode() {
            const isDark = localStorage.getItem('gymmate_darkmode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        // ==========================================
        // TAB NAVIGATION
        // ==========================================

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                selectedTab.classList.add('active');
            }

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });

            const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-500', 'text-white');
                activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
            }

            // Update bottom nav
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const activeNavItem = document.querySelector(`.bottom-nav-item[data-tab="${tabName}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // Load data for specific tabs
            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'prs') {
                loadPRs();
            } else if (tabName === 'charts') {
                initializeCharts();
            } else if (tabName === 'calculators') {
                populateCalculatorDropdowns();
            }
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================

        document.getElementById('grupoSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                loadTrainingGroup(e.target.value);
            }
        });

        // Tarjetas de rutinas clicables (reemplaza el select)
        document.querySelectorAll('[data-grupo]').forEach(card => {
            card.addEventListener('click', function() {
                const grupo = this.getAttribute('data-grupo');
                if (grupo) {
                    loadTrainingGroup(grupo);
                }
            });
        });

        // Navigation items
        document.querySelectorAll('[data-nav]').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('[data-nav]').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                // Handle navigation
                const navType = this.getAttribute('data-nav');
                if (navType === 'charts') {
                    switchTab('charts');
                } else if (navType === 'history') {
                    switchTab('history');
                } else if (navType === 'home') {
                    switchTab('workout');
                }
            });
        });

        // FAB button (central floating action button)
        if (document.getElementById('fabButton')) {
            document.getElementById('fabButton').addEventListener('click', function() {
                // Simular click en el primer grupo de entrenamiento
                const firstCard = document.querySelector('[data-grupo]');
                if (firstCard) {
                    firstCard.click();
                }
            });
        }

        // Start workout button
        if (document.getElementById('startWorkoutBtn')) {
            document.getElementById('startWorkoutBtn').addEventListener('click', function() {
                // Simular click en el primer grupo de entrenamiento
                const firstCard = document.querySelector('[data-grupo]');
                if (firstCard) {
                    firstCard.click();
                }
            });
        }

        // Quick Actions buttons
        document.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                switchTab(action);
            });
        });

        document.getElementById('saveButton').addEventListener('click', saveToLocalStorage);
        document.getElementById('closeModal').addEventListener('click', closeAnimationModal);
        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        document.querySelectorAll('.bottom-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                switchTab(item.dataset.tab);
            });
        });

        // Rest timer
        document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
        document.getElementById('stopTimer').addEventListener('click', stopTimer);
        document.getElementById('closeRestModal').addEventListener('click', () => {
            document.getElementById('restTimerModal').classList.remove('active');
        });

        document.querySelectorAll('.rest-time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                initializeTimer(parseInt(btn.dataset.seconds));
            });
        });

        // Modal close on outside click
        document.getElementById('animationModal').addEventListener('click', (e) => {
            if (e.target.id === 'animationModal') {
                closeAnimationModal();
            }
        });

        document.getElementById('restTimerModal').addEventListener('click', (e) => {
            if (e.target.id === 'restTimerModal') {
                document.getElementById('restTimerModal').classList.remove('active');
            }
        });

        document.getElementById('statsBtn').addEventListener('click', () => {
            switchTab('prs');
        });

        // Export to Excel button
        document.getElementById('exportToExcelBtn').addEventListener('click', exportToExcel);

        // ==========================================
        // CHART.JS - PROGRESS GRAPHS
        // ==========================================

        let volumeTrendChart = null;
        let muscleDistributionChart = null;
        let weightProgressChart = null;
        let weeklyComparisonChart = null;

        function initializeCharts() {
            // Destroy existing charts
            if (volumeTrendChart) volumeTrendChart.destroy();
            if (muscleDistributionChart) muscleDistributionChart.destroy();
            if (weightProgressChart) weightProgressChart.destroy();
            if (weeklyComparisonChart) weeklyComparisonChart.destroy();

            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            if (history.length === 0) {
                console.log('No hay datos para gr√°ficos');
                return;
            }

            // 1. Volume Trend Chart
            createVolumeTrendChart(history);

            // 2. Muscle Distribution Chart
            createMuscleDistributionChart(history);

            // 3. Weight Progress Chart (populated after exercise selection)
            populateExerciseDropdown(history);

            // 4. Weekly Comparison Chart
            createWeeklyComparisonChart(history);
        }

        function createVolumeTrendChart(history) {
            const ctx = document.getElementById('volumeTrendChart');
            if (!ctx) return;

            // Get last 30 sessions
            const last30 = history.slice(0, 30).reverse();

            const dates = last30.map(s => new Date(s.savedAt || s.date).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
            const volumes = last30.map(s => s.volumenTotal);

            volumeTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Volumen Total',
                        data: volumes,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volumen'
                            }
                        }
                    }
                }
            });
        }

        function createMuscleDistributionChart(history) {
            const ctx = document.getElementById('muscleDistributionChart');
            if (!ctx) return;

            // Aggregate volume by muscle group across all history
            const muscleVolumes = {};
            history.forEach(session => {
                Object.entries(session.volumenPorGrupo || {}).forEach(([muscle, volume]) => {
                    muscleVolumes[muscle] = (muscleVolumes[muscle] || 0) + volume;
                });
            });

            const muscles = Object.keys(muscleVolumes);
            const volumes = Object.values(muscleVolumes);

            muscleDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: muscles,
                    datasets: [{
                        data: volumes,
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function populateExerciseDropdown(history) {
            const dropdown = document.getElementById('exerciseChartSelect');
            if (!dropdown) return;

            // Get all unique exercises
            const exercises = new Set();
            history.forEach(session => {
                session.ejercicios.forEach(ej => {
                    if (ej.peso > 0) {
                        exercises.add(ej.nombre);
                    }
                });
            });

            dropdown.innerHTML = '<option value="">-- Elige un ejercicio --</option>';
            Array.from(exercises).sort().forEach(exercise => {
                const option = document.createElement('option');
                option.value = exercise;
                option.textContent = exercise;
                dropdown.appendChild(option);
            });

            dropdown.addEventListener('change', (e) => {
                if (e.target.value) {
                    createWeightProgressChart(history, e.target.value);
                }
            });
        }

        function createWeightProgressChart(history, exerciseName) {
            const ctx = document.getElementById('weightProgressChart');
            if (!ctx) return;

            if (weightProgressChart) weightProgressChart.destroy();

            // Get weight data for this exercise
            const exerciseData = [];
            history.slice(0, 30).reverse().forEach(session => {
                const exercise = session.ejercicios.find(ej => ej.nombre === exerciseName);
                if (exercise && exercise.peso > 0) {
                    exerciseData.push({
                        date: new Date(session.savedAt || session.date).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }),
                        peso: exercise.peso,
                        sets: exercise.sets,
                        reps: exercise.reps
                    });
                }
            });

            if (exerciseData.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            const dates = exerciseData.map(d => d.date);
            const pesos = exerciseData.map(d => d.peso);

            weightProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: `Peso (kg) - ${exerciseName}`,
                        data: pesos,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataPoint = exerciseData[context.dataIndex];
                                    return `Peso: ${dataPoint.peso}kg (${dataPoint.sets}√ó${dataPoint.reps})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Peso (kg)'
                            }
                        }
                    }
                }
            });
        }

        function createWeeklyComparisonChart(history) {
            const ctx = document.getElementById('weeklyComparisonChart');
            if (!ctx) return;

            // Group by week
            const weeklyData = {};
            history.forEach(session => {
                const date = new Date(session.savedAt || session.date);
                const week = getWeekNumber(date);
                const weekKey = `Semana ${week}`;

                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = 0;
                }
                weeklyData[weekKey] += session.volumenTotal;
            });

            const weeks = Object.keys(weeklyData).slice(0, 8).reverse();
            const volumes = weeks.map(w => weeklyData[w]);

            weeklyComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Volumen Semanal',
                        data: volumes,
                        backgroundColor: '#8B5CF6',
                        borderColor: '#7C3AED',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volumen Total'
                            }
                        }
                    }
                }
            });
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // ==========================================
        // AI SUGGESTIONS SYSTEM
        // ==========================================

        function generateAISuggestions() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            if (history.length < 3) {
                return; // Need at least 3 sessions for meaningful suggestions
            }

            const suggestions = [];

            // 1. Check for stagnation in weight progression
            const weightSuggestion = checkWeightStagnation(history);
            if (weightSuggestion) suggestions.push(weightSuggestion);

            // 2. Check for volume drops
            const volumeSuggestion = checkVolumeDrop(history);
            if (volumeSuggestion) suggestions.push(volumeSuggestion);

            // 3. Check for muscle group imbalances
            const balanceSuggestion = checkMuscleImbalance(history);
            if (balanceSuggestion) suggestions.push(balanceSuggestion);

            // 4. Check for rest days needed
            const restSuggestion = checkRestNeeded(history);
            if (restSuggestion) suggestions.push(restSuggestion);

            // Show first suggestion
            if (suggestions.length > 0) {
                showAISuggestion(suggestions[0]);
            }
        }

        function checkWeightStagnation(history) {
            // Get last 3 sessions for each exercise
            const exerciseProgress = {};

            history.slice(0, 5).forEach(session => {
                session.ejercicios.forEach(ej => {
                    if (!exerciseProgress[ej.nombre]) {
                        exerciseProgress[ej.nombre] = [];
                    }
                    if (ej.peso > 0) {
                        exerciseProgress[ej.nombre].push(ej.peso);
                    }
                });
            });

            // Find stagnant exercises (same weight for 3+ sessions)
            for (const [exercise, weights] of Object.entries(exerciseProgress)) {
                if (weights.length >= 3) {
                    const lastThree = weights.slice(0, 3);
                    const allSame = lastThree.every(w => w === lastThree[0]);

                    if (allSame && lastThree[0] > 0) {
                        const suggestedIncrease = lastThree[0] <= 20 ? 2.5 : 5;
                        return `üí™ Progresi√≥n detectada: Has usado ${lastThree[0]}kg en ${exercise} las √∫ltimas 3 sesiones. Considera incrementar a ${(lastThree[0] + suggestedIncrease).toFixed(1)}kg`;
                    }
                }
            }

            return null;
        }

        function checkVolumeDrop(history) {
            if (history.length < 2) return null;

            const lastSession = history[0];
            const previousSessions = history.slice(1, 4);
            const avgPreviousVolume = previousSessions.reduce((sum, s) => sum + s.volumenTotal, 0) / previousSessions.length;

            if (lastSession.volumenTotal < avgPreviousVolume * 0.7) {
                return `üìâ Volumen bajo: Tu √∫ltimo entreno tuvo ${lastSession.volumenTotal.toFixed(0)} de volumen, un ${((1 - lastSession.volumenTotal / avgPreviousVolume) * 100).toFixed(0)}% menos que tu promedio. ¬øNecesitas m√°s descanso?`;
            }

            return null;
        }

        function checkMuscleImbalance(history) {
            const muscleVolumes = {};

            history.slice(0, 10).forEach(session => {
                Object.entries(session.volumenPorGrupo || {}).forEach(([muscle, volume]) => {
                    muscleVolumes[muscle] = (muscleVolumes[muscle] || 0) + volume;
                });
            });

            const muscles = Object.keys(muscleVolumes);
            if (muscles.length < 2) return null;

            const maxVolume = Math.max(...Object.values(muscleVolumes));
            const minVolume = Math.min(...Object.values(muscleVolumes));

            if (maxVolume / minVolume > 3) {
                const undertrainedMuscle = Object.entries(muscleVolumes).find(([_, vol]) => vol === minVolume)[0];
                return `‚öñÔ∏è Desequilibrio detectado: ${undertrainedMuscle} tiene solo el ${((minVolume / maxVolume) * 100).toFixed(0)}% del volumen de tu grupo muscular m√°s entrenado. Considera a√±adir m√°s trabajo de ${undertrainedMuscle}.`;
            }

            return null;
        }

        function checkRestNeeded(history) {
            if (history.length < 7) return null;

            // Check if trained 7 days in a row
            const last7Days = history.slice(0, 7);
            const dates = last7Days.map(s => new Date(s.savedAt || s.date).toDateString());
            const uniqueDates = new Set(dates);

            if (uniqueDates.size >= 6) {
                return `üõë Descanso recomendado: Has entrenado ${uniqueDates.size} de los √∫ltimos 7 d√≠as. Considera tomar un d√≠a de descanso para optimizar recuperaci√≥n.`;
            }

            return null;
        }

        function showAISuggestion(suggestion) {
            const banner = document.getElementById('aiSuggestionsBanner');
            const text = document.getElementById('aiSuggestionText');

            if (banner && text) {
                text.textContent = suggestion;
                banner.classList.remove('hidden');
            }
        }

        function dismissAISuggestion() {
            const banner = document.getElementById('aiSuggestionsBanner');
            if (banner) {
                banner.classList.add('hidden');
            }
        }

        // ==========================================
        // CALCULATORS - 1RM, CALORIES, PROGRESSIVE
        // ==========================================

        function calculate1RM(exerciseName) {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            // Find best performance for this exercise
            let bestPerformance = null;
            let maxWeight = 0;

            history.forEach(session => {
                const exercise = session.ejercicios.find(ej => ej.nombre === exerciseName);
                if (exercise && exercise.peso > 0) {
                    if (exercise.peso > maxWeight ||
                        (exercise.peso === maxWeight && exercise.reps > (bestPerformance?.reps || 0))) {
                        maxWeight = exercise.peso;
                        bestPerformance = exercise;
                    }
                }
            });

            if (!bestPerformance) {
                return null;
            }

            const peso = bestPerformance.peso;
            const reps = bestPerformance.reps;

            // Three 1RM formulas
            const epley = peso * (1 + reps / 30);
            const brzycki = peso * (36 / (37 - reps));
            const lombardi = peso * Math.pow(reps, 0.1);

            return {
                bestPerformance,
                epley: epley.toFixed(1),
                brzycki: brzycki.toFixed(1),
                lombardi: lombardi.toFixed(1),
                average: ((epley + brzycki + lombardi) / 3).toFixed(1)
            };
        }

        function calculateCalories() {
            const age = parseFloat(document.getElementById('caloriesAge').value);
            const gender = document.getElementById('caloriesGender').value;
            const weight = parseFloat(document.getElementById('caloriesWeight').value);
            const height = parseFloat(document.getElementById('caloriesHeight').value);
            const activity = parseFloat(document.getElementById('caloriesActivity').value);

            if (!age || !weight || !height) {
                alert('Por favor completa todos los campos');
                return;
            }

            // Mifflin-St Jeor formula
            let bmr;
            if (gender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }

            const tdee = bmr * activity;
            const deficit = tdee * 0.8;
            const surplus = tdee * 1.2;

            document.getElementById('bmrResult').textContent = Math.round(bmr);
            document.getElementById('tdeeResult').textContent = Math.round(tdee);
            document.getElementById('deficitResult').textContent = Math.round(deficit) + ' kcal';
            document.getElementById('maintenanceResult').textContent = Math.round(tdee) + ' kcal';
            document.getElementById('surplusResult').textContent = Math.round(surplus) + ' kcal';

            document.getElementById('caloriesResults').classList.remove('hidden');
        }

        function calculateProgressive(exerciseName) {
            const prs = JSON.parse(localStorage.getItem('gymmate_prs') || '{}');
            const exercisePR = prs[exerciseName];

            if (!exercisePR) {
                return null;
            }

            const currentWeight = exercisePR.peso;
            const conservative = currentWeight + 2.5;
            const moderate = currentWeight + 5;
            const aggressive = currentWeight + 10;

            return {
                current: currentWeight,
                conservative: conservative.toFixed(1),
                moderate: moderate.toFixed(1),
                aggressive: aggressive.toFixed(1)
            };
        }

        // Populate calculator dropdowns when calculators tab is opened
        function populateCalculatorDropdowns() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            // Get all unique exercises
            const exercises = new Set();
            history.forEach(session => {
                session.ejercicios.forEach(ej => {
                    if (ej.peso > 0) {
                        exercises.add(ej.nombre);
                    }
                });
            });

            const exerciseArray = Array.from(exercises).sort();

            // Populate 1RM dropdown
            const rm1Select = document.getElementById('rm1ExerciseSelect');
            rm1Select.innerHTML = '<option value="">-- Elige un ejercicio --</option>';
            exerciseArray.forEach(ex => {
                const option = document.createElement('option');
                option.value = ex;
                option.textContent = ex;
                rm1Select.appendChild(option);
            });

            // Populate Progressive dropdown
            const progressiveSelect = document.getElementById('progressiveExerciseSelect');
            progressiveSelect.innerHTML = '<option value="">-- Elige un ejercicio --</option>';
            exerciseArray.forEach(ex => {
                const option = document.createElement('option');
                option.value = ex;
                option.textContent = ex;
                progressiveSelect.appendChild(option);
            });

            // Event listeners
            rm1Select.addEventListener('change', (e) => {
                if (e.target.value) {
                    const result = calculate1RM(e.target.value);
                    if (result) {
                        document.getElementById('rm1BestRecord').textContent =
                            `${result.bestPerformance.peso}kg √ó ${result.bestPerformance.reps} reps (${result.bestPerformance.sets} sets)`;
                        document.getElementById('rm1Epley').textContent = result.epley;
                        document.getElementById('rm1Brzycki').textContent = result.brzycki;
                        document.getElementById('rm1Lombardi').textContent = result.lombardi;
                        document.getElementById('rm1Results').classList.remove('hidden');
                    }
                }
            });

            progressiveSelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    const result = calculateProgressive(e.target.value);
                    if (result) {
                        document.getElementById('progressiveCurrentWeight').textContent = `${result.current}kg`;
                        document.getElementById('progressiveConservative').textContent = `${result.conservative}kg`;
                        document.getElementById('progressiveModerate').textContent = `${result.moderate}kg`;
                        document.getElementById('progressiveAggressive').textContent = `${result.aggressive}kg`;
                        document.getElementById('progressiveResults').classList.remove('hidden');
                    }
                }
            });
        }

        // ==========================================
        // EXPORT TO REAL EXCEL (.XLSX)
        // ==========================================

        function exportToExcel() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            if (history.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // Prepare data for Excel
            const excelData = [];

            // Headers
            excelData.push(['Fecha', 'Grupo', 'Ejercicio', 'Sets', 'Reps', 'Peso (kg)', 'Es Mancuerna', 'Grupo Muscular', 'Volumen', 'Completado', 'Volumen Total Sesi√≥n']);

            // Data rows
            history.forEach(session => {
                const fecha = new Date(session.savedAt || session.date).toLocaleDateString('es-ES');
                const grupo = session.grupo;
                const volumenTotalSesion = session.volumenTotal;

                session.ejercicios.forEach(ej => {
                    if (ej.volumen > 0) {
                        excelData.push([
                            fecha,
                            grupo,
                            ej.nombre,
                            ej.sets,
                            ej.reps,
                            ej.peso,
                            ej.esMancuerna ? 'S√≠' : 'No',
                            ej.grupoMuscular,
                            ej.volumen,
                            ej.completado ? 'S√≠' : 'No',
                            volumenTotalSesion
                        ]);
                    }
                });
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // Set column widths
            ws['!cols'] = [
                { wch: 12 },  // Fecha
                { wch: 30 },  // Grupo
                { wch: 30 },  // Ejercicio
                { wch: 8 },   // Sets
                { wch: 8 },   // Reps
                { wch: 10 },  // Peso
                { wch: 15 },  // Es Mancuerna
                { wch: 18 },  // Grupo Muscular
                { wch: 10 },  // Volumen
                { wch: 12 },  // Completado
                { wch: 18 }   // Volumen Total
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Historial de Entrenos');

            // Generate Excel file and download
            XLSX.writeFile(wb, `GymMate_Historial_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ==========================================
        // PWA & NOTIFICATIONS
        // ==========================================

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {
                console.log('Service worker registration failed');
            });
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        loadDarkMode();
        loadHistory();
        loadPRs();

        // Style tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.className = 'tab-btn p-3 rounded-lg font-semibold text-sm transition-all';
            if (btn.classList.contains('active')) {
                btn.classList.add('bg-blue-500', 'text-white');
            } else {
                btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            }
        });

        console.log('üöÄ GymMate v2.0 Initialized');
        console.log('‚úÖ Mobile-first responsive design');
        console.log('‚úÖ Dynamic muscle group display');
        console.log('‚úÖ Exercise GIFs from ExerciseDB');
        console.log('‚úÖ Rest timer with notifications');
        console.log('‚úÖ PR tracking system');
        console.log('‚úÖ Workout history');
        console.log('‚úÖ Dark mode support');
        console.log('‚úÖ PWA ready');
    </script>
</body>
</html>
