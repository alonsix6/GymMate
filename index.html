<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Tu compa√±ero personal de entrenamientos - Seguimiento de volumen, PRs, y progreso">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GymMate - Tu Compa√±ero de Entrenamiento</title>

    <link rel="manifest" href="manifest.json">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#0f172a',
                        'dark-surface': '#1e293b',
                        'accent-blue': '#2563eb',
                        'accent-purple': '#7c3aed',
                        'accent-cyan': '#22d3ee',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'display': ['Oswald', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lottie-web/build/player/lottie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #7c3aed;
            --danger-color: #EF4444;
            --dark-bg: #0f172a;
            --dark-surface: #1e293b;
            --accent-cyan: #22d3ee;
        }

        * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--dark-bg);
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }

        /* Glass Card Effect */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
        }

        /* Glow Effect */
        .glow-bg {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(37, 99, 235, 0.2), transparent 70%);
            filter: blur(40px);
            z-index: -1;
        }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Avatar Ring Gradient */
        .ring-gradient {
            position: relative;
        }

        .ring-gradient::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            z-index: -1;
        }

        .input-error {
            border: 2px solid #EF4444;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .progress-bar-fill {
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        input:focus, select:focus, button:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        .timer-active {
            animation: pulse-glow 2s infinite;
        }

        /* Mobile-first touch targets */
        @media (max-width: 768px) {
            input, button, select {
                min-height: 44px;
                font-size: 16px; /* Prevents iOS zoom */
            }

            .exercise-card {
                padding: 1rem;
            }

            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* Swipe indicator */
        .swipe-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .swipe-indicator.show {
            opacity: 1;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .pr-badge {
            display: inline-block;
            background: #F59E0B;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        /* Bottom navigation for mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0.75rem 0 1.5rem 0;
            padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
            z-index: 100;
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: #9ca3af;
            cursor: pointer;
            flex: 1;
            padding: 0.5rem;
        }

        .bottom-nav-item.active {
            color: var(--accent-cyan);
        }

        .bottom-nav-item:active {
            transform: scale(0.95);
        }

        /* FAB - Floating Action Button */
        .fab {
            position: relative;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.4);
            margin-top: -32px;
            cursor: pointer;
        }

        .fab:active {
            transform: scale(0.95);
        }

        .fab::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            opacity: 0.5;
            filter: blur(8px);
            z-index: -1;
        }

        /* Hide scrollbar but keep functionality */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Unsaved indicator animations */
        @keyframes slideDown {
            from {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }
            to {
                transform: translate(-50%, -100%);
                opacity: 0;
            }
        }

        @keyframes colorToGreen {
            from {
                background-color: rgba(234, 179, 8, 0.9);
            }
            to {
                background-color: rgba(34, 197, 94, 0.9);
            }
        }

        .unsaved-indicator-show {
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .unsaved-indicator-hide {
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .unsaved-indicator-saved {
            animation: colorToGreen 0.5s ease forwards;
            background-color: rgba(34, 197, 94, 0.9) !important;
        }

        /* Resume workout card animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .resume-card-enter {
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
    </style>
</head>
<body class="bg-dark-bg min-h-screen pb-32 font-sans">
    <!-- Unsaved Changes Indicator -->
    <div id="unsavedIndicator" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-yellow-500/90 text-dark-bg px-4 py-2 rounded-full font-semibold text-sm shadow-lg flex items-center gap-2 backdrop-blur-sm">
        <span class="animate-pulse">‚óè</span>
        Cambios sin guardar
    </div>

    <!-- Header with Profile -->
    <header class="px-6 pt-8 pb-6">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-gray-400 text-sm mb-1">üí™ Tu compa√±ero de entrenamiento</p>
                <h1 class="text-3xl font-display font-bold uppercase tracking-wide">GymMate</h1>
            </div>
            <div class="flex items-center gap-3">
                <!-- Hidden buttons for JS compatibility -->
                <button id="darkModeToggle" class="hidden"></button>
                <button id="statsBtn" class="glass-card px-4 py-2 rounded-lg text-cyan-400 font-semibold text-sm border border-cyan-500/30 active:scale-95 transition-transform">
                    üìä Stats
                </button>
                <div class="ring-gradient">
                    <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-2xl">
                        üèãÔ∏è
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <main class="px-6 space-y-6">
        <!-- HOME VIEW -->
        <div id="homeView" class="space-y-6">
            <!-- Hero Section - Estado Actual (Din√°mico) -->
            <section id="heroSection" class="relative glass-card p-6 overflow-hidden">
                <div class="glow-bg"></div>
                <div class="relative z-10">
                    <!-- Badge din√°mico -->
                    <div class="flex items-center gap-2 mb-2">
                        <span id="heroIcon" class="text-2xl">üí™</span>
                        <p id="heroBadge" class="text-cyan-400 text-sm font-semibold uppercase tracking-wide">
                            HOY TOCA
                        </p>
                    </div>

                    <!-- T√≠tulo principal -->
                    <h2 id="heroTitle" class="text-2xl font-display font-bold mb-1 gradient-text">
                        PIERNAS + GL√öTEOS
                    </h2>

                    <!-- Subt√≠tulo din√°mico -->
                    <p id="heroSubtitle" class="text-sm text-gray-400 mb-4">
                        √öltima vez: hace 3 d√≠as
                    </p>

                    <!-- Sugerencia de rutina (solo si aplica) -->
                    <p id="heroRoutine" class="text-xs text-cyan-400 font-semibold mb-6 hidden">
                        üìã Rutina sugerida: GRUPO 1
                    </p>

                    <!-- Bot√≥n -->
                    <button id="startWorkoutBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-4 rounded-xl shadow-lg shadow-blue-500/30 active:scale-95 transition-transform">
                        VER MIS RUTINAS
                    </button>
                </div>
            </section>

            <!-- Resume Workout Card - Shown when there's an unfinished workout -->
            <div id="resumeWorkoutCard" class="hidden glass-card p-5 border-l-4 border-cyan-400 relative overflow-hidden resume-card-enter">
                <div class="absolute inset-0 bg-gradient-to-r from-cyan-500/10 to-blue-500/10"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-500 flex items-center justify-center text-2xl shadow-lg shadow-cyan-500/30">
                                üí™
                            </div>
                            <div>
                                <p class="text-xs text-cyan-400 font-semibold uppercase tracking-wide">Sesi√≥n en progreso</p>
                                <h3 class="text-lg font-bold text-white" id="resumeWorkoutName">-</h3>
                            </div>
                        </div>
                        <button onclick="discardResumeWorkout()" class="text-gray-400 hover:text-red-400 transition-colors active:scale-95">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-dark-surface/50 rounded-lg p-2 text-center">
                            <p class="text-xs text-gray-400">Ejercicios</p>
                            <p class="text-lg font-bold text-cyan-400" id="resumeWorkoutExercises">0</p>
                        </div>
                        <div class="bg-dark-surface/50 rounded-lg p-2 text-center">
                            <p class="text-xs text-gray-400">Volumen</p>
                            <p class="text-lg font-bold text-cyan-400" id="resumeWorkoutVolume">0</p>
                        </div>
                        <div class="bg-dark-surface/50 rounded-lg p-2 text-center">
                            <p class="text-xs text-gray-400">Sets</p>
                            <p class="text-lg font-bold text-cyan-400" id="resumeWorkoutSets">0</p>
                        </div>
                    </div>

                    <button onclick="resumeWorkoutFromCard()" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-semibold py-3 rounded-lg shadow-lg shadow-cyan-500/20 active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <i class="ph-bold ph-play"></i>
                        Continuar Entrenamiento
                    </button>
                </div>
            </div>

            <!-- Grid de Herramientas - Quick Actions -->
            <section class="grid grid-cols-2 gap-4">
                <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform cursor-pointer" data-action="calculators">
                    <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center">
                        <i class="ph-bold ph-calculator text-purple-400 text-2xl"></i>
                    </div>
                    <span class="text-sm font-medium">1RM Calc</span>
                </div>
                <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform cursor-pointer" data-action="history">
                    <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center">
                        <i class="ph-bold ph-clock-counter-clockwise text-cyan-400 text-2xl"></i>
                    </div>
                    <span class="text-sm font-medium">Historial</span>
                </div>
                <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform cursor-pointer" data-action="charts">
                    <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center">
                        <i class="ph-bold ph-chart-line text-blue-400 text-2xl"></i>
                    </div>
                    <span class="text-sm font-medium">Progreso</span>
                </div>
                <div class="glass-card p-4 flex flex-col items-center justify-center gap-3 active:scale-95 transition-transform cursor-pointer" data-action="prs">
                    <div class="w-12 h-12 rounded-xl bg-yellow-500/10 flex items-center justify-center">
                        <i class="ph-bold ph-trophy text-yellow-400 text-2xl"></i>
                    </div>
                    <span class="text-sm font-medium">PRs</span>
                </div>
            </section>

            <!-- Selector de Rutinas (Sin <select>) -->
            <section>
                <h3 class="text-lg font-display font-bold uppercase mb-4 tracking-wide">RUTINAS DISPONIBLES</h3>

                <!-- Select oculto para mantener compatibilidad con JavaScript -->
                <select id="grupoSelect" class="hidden">
                    <option value="">-- Elige tu entrenamiento --</option>
                    <option value="grupo1">ü¶µ GRUPO 1 - Piernas + Gl√∫teos</option>
                    <option value="grupo2">üí™ GRUPO 2 - Upper Push</option>
                    <option value="grupo3">üèãÔ∏è GRUPO 3 - Piernas Quad Dominante</option>
                    <option value="grupo4">üî± GRUPO 4 - Espalda + B√≠ceps</option>
                    <option value="grupo5">üèÜ GRUPO 5 - Hombro + Tr√≠ceps</option>
                </select>

                <div class="space-y-3">
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo1">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-pink-500/10 flex items-center justify-center text-2xl">
                            ü¶µ
                        </div>
                        <div>
                            <p class="font-semibold">Piernas + Gl√∫teos</p>
                            <p class="text-xs text-gray-400">4 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo2">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center text-2xl">
                            üí™
                        </div>
                        <div>
                            <p class="font-semibold">Upper Push</p>
                            <p class="text-xs text-gray-400">3 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo3">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-purple-500/10 flex items-center justify-center text-2xl">
                            üèãÔ∏è
                        </div>
                        <div>
                            <p class="font-semibold">Piernas Quad Dominante</p>
                            <p class="text-xs text-gray-400">2 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center text-2xl">
                            üî±
                        </div>
                        <div>
                            <p class="font-semibold">Espalda + B√≠ceps</p>
                            <p class="text-xs text-gray-400">3 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
                <div class="glass-card p-4 flex items-center justify-between active:scale-95 transition-transform cursor-pointer" data-grupo="grupo5">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-orange-500/10 flex items-center justify-center text-2xl">
                            üèÜ
                        </div>
                        <div>
                            <p class="font-semibold">Hombro + Tr√≠ceps</p>
                            <p class="text-xs text-gray-400">2 d√≠as/sem</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-gray-400"></i>
                </div>
            </div>
        </section>

            <!-- Cardio HIIT Section -->
            <section class="mt-8">
                <h3 class="text-lg font-display font-bold uppercase mb-4 tracking-wide">CARDIO & HIIT</h3>

                <div onclick="showCardioSelector()" class="glass-card p-5 flex items-center justify-between active:scale-95 transition-transform cursor-pointer border-l-4 border-orange-500 bg-gradient-to-r from-orange-500/5 to-red-500/5 hover:from-orange-500/10 hover:to-red-500/10">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center text-3xl shadow-lg shadow-orange-500/30">
                            üî•
                        </div>
                        <div>
                            <p class="font-bold text-lg">Entrenamientos Cardio</p>
                            <p class="text-sm text-gray-400">EMOM, Tabata, Circuitos y m√°s</p>
                        </div>
                    </div>
                    <i class="ph-bold ph-caret-right text-orange-400 text-xl"></i>
                </div>
            </section>

        </div>
        <!-- END HOME VIEW -->

        <!-- Hidden sections from original (kept for functionality) -->
        <div id="tabContainer" class="hidden"></div>
        <div id="aiSuggestionsBanner" class="hidden"></div>

        <!-- WORKOUT TAB -->
        <div id="workoutTab" class="tab-content hidden">
            <!-- Back Button -->
            <button onclick="showHome()" class="glass-card px-4 py-2 rounded-lg text-gray-300 font-semibold text-sm border border-white/10 active:scale-95 transition-transform mb-4 flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i>
                Volver al Inicio
            </button>
            <!-- Rest Timer Fullscreen Modal moved to bottom with other modals -->
            <div id="trainingInfo" class="hidden glass-card p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl md:text-2xl font-display font-bold uppercase text-white" id="currentTraining"></h2>
                        <p class="text-sm text-gray-400 mt-1">üìÖ <span id="currentDate"></span></p>
                    </div>
                    <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-500 rounded-full flex items-center justify-center text-2xl shadow-lg shadow-cyan-500/30">
                        üí™
                    </div>
                </div>
            </div>

            <!-- Quick Stats Cards -->
            <div id="quickStats" class="hidden grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                <div class="stat-card">
                    <p class="text-xs opacity-90">Volumen Total</p>
                    <p class="text-2xl font-bold" id="statVolume">0</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <p class="text-xs opacity-90">Ejercicios</p>
                    <p class="text-2xl font-bold" id="statExercises">0</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <p class="text-xs opacity-90">Sets Totales</p>
                    <p class="text-2xl font-bold" id="statSets">0</p>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <p class="text-xs opacity-90">Completados</p>
                    <p class="text-2xl font-bold" id="statCompleted">0</p>
                </div>
            </div>

            <!-- Exercises Container -->
            <section id="ejerciciosContainer" class="hidden space-y-4">
                <div id="ejerciciosList" class="space-y-3 md:space-y-4"></div>

                <!-- Optional Exercises Section -->
                <div class="mt-6 md:mt-8 glass-card p-4 md:p-6 border-l-4 border-yellow-500">
                    <h3 class="text-lg md:text-xl font-display font-bold uppercase text-white mb-4">üìå Ejercicios Opcionales</h3>
                    <div id="opcionalesList" class="space-y-3 md:space-y-4"></div>
                </div>
            </section>

            <!-- Volume Summary -->
            <section id="volumeSummary" class="hidden mt-6 md:mt-8 glass-card p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-display font-bold uppercase text-white mb-6">üìä Resumen de Volumen</h2>
                <div id="volumeBars" class="space-y-4"></div>
                <div class="mt-6 pt-6 border-t-2 border-white/10">
                    <p class="text-lg md:text-xl font-bold text-white">Volumen Total: <span id="totalVolume" class="text-cyan-400 font-display">0</span></p>
                    <p class="text-sm text-gray-400 mt-2">
                        üí° <span class="font-semibold">¬øQu√© es el volumen?</span> Es la cantidad total de trabajo realizado, calculado como: <span class="text-cyan-400">Series √ó Repeticiones √ó Peso</span>. Las barras muestran el % que cada grupo muscular representa del volumen total de tu sesi√≥n.
                    </p>
                </div>
            </section>

            <!-- Save Button -->
            <div id="saveSection" class="hidden mt-6 md:mt-8">
                <button id="saveButton" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-green-500/30 active:scale-95 transition-transform text-lg">
                    üíæ Guardar Entrenamiento
                </button>
                <button onclick="endSession()" class="w-full mt-3 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-500 hover:to-orange-500 text-white font-semibold py-4 rounded-xl shadow-lg shadow-red-500/30 active:scale-95 transition-transform text-lg">
                    üèÅ Terminar Sesi√≥n
                </button>
                <p id="saveMessage" class="mt-4 text-green-400 font-semibold text-center hidden"></p>
            </div>
        </div>

        <!-- Calculators Tab -->
        <div id="calculatorsTab" class="tab-content hidden">
            <!-- Back Button -->
            <button onclick="showHome()" class="glass-card px-4 py-2 rounded-lg text-gray-300 font-semibold text-sm border border-white/10 active:scale-95 transition-transform mb-4 flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i>
                Volver al Inicio
            </button>
            <div class="space-y-6">
                <!-- 1RM Calculator -->
                <div class="glass-card p-4 md:p-6">
                    <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-2">üí™ Calculadora de 1RM</h2>
                    <p class="text-sm text-gray-400 mb-4">Estima tu m√°ximo para 1 repetici√≥n bas√°ndose en tu mejor rendimiento reciente</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Selecciona Ejercicio:</label>
                            <select id="rm1ExerciseSelect" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-blue-500">
                                <option value="">-- Elige un ejercicio --</option>
                            </select>
                        </div>
                    </div>

                    <div id="rm1Results" class="hidden">
                        <div class="bg-blue-500/10 border-l-4 border-blue-500 p-4 rounded-lg backdrop-blur-sm">
                            <p class="text-sm text-gray-300 mb-2"><strong>Mejor registro:</strong> <span id="rm1BestRecord"></span></p>
                            <div class="grid grid-cols-3 gap-3 mt-4">
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Epley</p>
                                    <p class="text-2xl font-bold gradient-text" id="rm1Epley">-</p>
                                    <p class="text-xs text-gray-400">kg</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Brzycki</p>
                                    <p class="text-2xl font-bold gradient-text" id="rm1Brzycki">-</p>
                                    <p class="text-xs text-gray-400">kg</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Lombardi</p>
                                    <p class="text-2xl font-bold gradient-text" id="rm1Lombardi">-</p>
                                    <p class="text-xs text-gray-400">kg</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-3 text-center">Promedio de 3 f√≥rmulas cient√≠ficas basadas en tu mejor rendimiento</p>
                        </div>
                    </div>
                </div>

                <!-- Calories Calculator -->
                <div class="glass-card p-4 md:p-6">
                    <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-2">üî• Calculadora de Calor√≠as</h2>
                    <p class="text-sm text-gray-400 mb-4">Calcula tu gasto cal√≥rico diario y requerimientos nutricionales</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Edad:</label>
                            <input type="number" id="caloriesAge" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500" placeholder="Ej: 25">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Sexo:</label>
                            <select id="caloriesGender" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500">
                                <option value="male">Hombre</option>
                                <option value="female">Mujer</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Peso (kg):</label>
                            <input type="number" id="caloriesWeight" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500" placeholder="Ej: 70">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Altura (cm):</label>
                            <input type="number" id="caloriesHeight" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500" placeholder="Ej: 175">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Nivel de Actividad:</label>
                            <select id="caloriesActivity" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-orange-500">
                                <option value="1.2">Sedentario (poco o ning√∫n ejercicio)</option>
                                <option value="1.375">Ligero (1-3 d√≠as/semana)</option>
                                <option value="1.55" selected>Moderado (3-5 d√≠as/semana)</option>
                                <option value="1.725">Activo (6-7 d√≠as/semana)</option>
                                <option value="1.9">Muy Activo (2 veces al d√≠a)</option>
                            </select>
                        </div>
                    </div>

                    <button onclick="prefillCaloriesFromProfile()" class="w-full bg-cyan-500/10 hover:bg-cyan-500/20 border border-cyan-500/30 text-cyan-300 font-semibold py-2 rounded-xl active:scale-95 transition-transform mb-3">
                        üë§ Usar datos de mi perfil
                    </button>

                    <button onclick="calculateCalories()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-semibold py-3 rounded-xl shadow-lg shadow-orange-500/30 active:scale-95 transition-transform mb-4">
                        Calcular
                    </button>

                    <div id="caloriesResults" class="hidden">
                        <div class="bg-orange-500/10 border-l-4 border-orange-500 p-4 rounded-lg backdrop-blur-sm">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-400">BMR (Metabolismo Basal)</p>
                                    <p class="text-2xl font-bold text-orange-400" id="bmrResult">-</p>
                                    <p class="text-xs text-gray-400">kcal/d√≠a</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-400">TDEE (Gasto Total)</p>
                                    <p class="text-2xl font-bold text-orange-400" id="tdeeResult">-</p>
                                    <p class="text-xs text-gray-400">kcal/d√≠a</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mt-4 pt-4 border-t border-orange-500/20">
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">D√©ficit (-20%)</p>
                                    <p class="text-lg font-bold text-red-400" id="deficitResult">-</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Mantenimiento</p>
                                    <p class="text-lg font-bold text-green-400" id="maintenanceResult">-</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-xs text-gray-400">Super√°vit (+20%)</p>
                                    <p class="text-lg font-bold text-blue-400" id="surplusResult">-</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-400 mt-3 text-center">Basado en f√≥rmula de Mifflin-St Jeor y tu nivel de actividad</p>
                        </div>
                    </div>
                </div>

                <!-- Progressive Weight Calculator -->
                <div class="glass-card p-4 md:p-6">
                    <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-2">üìà Calculadora de Peso Progresivo</h2>
                    <p class="text-sm text-gray-400 mb-4">Recomendaciones basadas en ACSM/NSCA y la regla "2-for-2"</p>

                    <div class="bg-blue-500/10 border-l-4 border-blue-500 p-3 rounded-lg mb-4">
                        <p class="text-xs text-gray-300 leading-relaxed">
                            <strong class="text-blue-400">üìö Regla "2-for-2" (ACSM/NSCA):</strong> Aumenta el peso cuando puedas realizar <strong>2 repeticiones extra</strong> por encima de tu objetivo durante <strong>2 entrenamientos consecutivos</strong>.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Selecciona Ejercicio:</label>
                            <select id="progressiveExerciseSelect" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-green-500">
                                <option value="">-- Elige un ejercicio --</option>
                            </select>
                        </div>
                    </div>

                    <div id="progressiveResults" class="hidden">
                        <div class="bg-green-500/10 border-l-4 border-green-500 p-4 rounded-lg backdrop-blur-sm">
                            <p class="text-sm text-gray-300 mb-1"><strong>Peso actual:</strong> <span id="progressiveCurrentWeight"></span></p>
                            <p class="text-xs text-gray-400 mb-3">Grupo muscular: <span id="progressiveExerciseType" class="text-cyan-400"></span></p>

                            <div class="space-y-3">
                                <div class="bg-dark-surface/50 rounded-lg p-3 border border-green-500/20">
                                    <p class="text-sm font-semibold text-gray-200">ACSM: Incremento Conservador (2-5%)</p>
                                    <p class="text-xl font-bold text-green-400 mt-1" id="progressiveConservative">-</p>
                                    <p class="text-xs text-gray-400">Ideal para principiantes y ejercicios t√©cnicos</p>
                                </div>

                                <div class="bg-dark-surface/50 rounded-lg p-3 border border-blue-500/20">
                                    <p class="text-sm font-semibold text-gray-200">ACSM: Incremento Est√°ndar (5-10%)</p>
                                    <p class="text-xl font-bold text-blue-400 mt-1" id="progressiveModerate">-</p>
                                    <p class="text-xs text-gray-400">Recomendado para intermedios con buena t√©cnica</p>
                                </div>

                                <div class="bg-dark-surface/50 rounded-lg p-3 border border-purple-500/20">
                                    <p class="text-sm font-semibold text-gray-200">NSCA: Incremento Avanzado (10%+)</p>
                                    <p class="text-xl font-bold text-purple-400 mt-1" id="progressiveAggressive">-</p>
                                    <p class="text-xs text-gray-400">Para avanzados en ejercicios de pierna</p>
                                </div>
                            </div>

                            <div class="mt-4 p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-lg">
                                <p class="text-xs text-yellow-300">
                                    <strong>üí° Recomendaci√≥n NSCA:</strong> Tren superior: 2.5-5kg | Tren inferior: 5-10kg
                                </p>
                            </div>

                            <p class="text-xs text-gray-400 mt-3 text-center">Basado en estudios ACSM (2009) y NSCA Standards</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Tab -->
        <div id="chartsTab" class="tab-content hidden">
            <!-- Back Button -->
            <button onclick="showHome()" class="glass-card px-4 py-2 rounded-lg text-gray-300 font-semibold text-sm border border-white/10 active:scale-95 transition-transform mb-4 flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i>
                Volver al Inicio
            </button>
            <div class="space-y-6">
                <!-- Export Button -->
                <div class="glass-card p-4">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-display font-bold uppercase">üìä An√°lisis de Progreso</h2>
                        <button id="exportToExcelBtn" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-lg shadow-green-500/30 active:scale-95 transition-transform">
                            üì• Exportar a Excel
                        </button>
                    </div>
                </div>

                <!-- Volume Trend Chart -->
                <div class="glass-card p-4 md:p-6">
                    <h3 class="text-lg font-bold text-white mb-2">Tendencia de Volumen (√öltimos 30 d√≠as)</h3>
                    <p class="text-xs text-gray-400 mb-4">Visualiza tu progreso de volumen total a lo largo del tiempo</p>
                    <canvas id="volumeTrendChart" class="w-full" style="max-height: 300px;"></canvas>
                </div>

                <!-- Muscle Group Distribution -->
                <div class="glass-card p-4 md:p-6">
                    <h3 class="text-lg font-bold text-white mb-2">Distribuci√≥n por Grupo Muscular</h3>
                    <p class="text-xs text-gray-400 mb-4">Identifica qu√© grupos musculares has entrenado m√°s en tu historial</p>
                    <canvas id="muscleDistributionChart" class="w-full" style="max-height: 300px;"></canvas>
                </div>

                <!-- Weight Progress by Exercise -->
                <div class="glass-card p-4 md:p-6">
                    <h3 class="text-lg font-bold text-white mb-2">Progresi√≥n de Peso por Ejercicio</h3>
                    <p class="text-xs text-gray-400 mb-4">Rastrea tu evoluci√≥n de fuerza en cada ejercicio espec√≠fico</p>
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Selecciona Ejercicio:</label>
                        <select id="exerciseChartSelect" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-blue-500">
                            <option value="">-- Elige un ejercicio --</option>
                        </select>
                    </div>
                    <canvas id="weightProgressChart" class="w-full" style="max-height: 300px;"></canvas>
                </div>

                <!-- Weekly Volume Comparison -->
                <div class="glass-card p-4 md:p-6">
                    <h3 class="text-lg font-bold text-white mb-2">Comparativa Semanal</h3>
                    <p class="text-xs text-gray-400 mb-4">Compara tu volumen total acumulado por semana</p>
                    <canvas id="weeklyComparisonChart" class="w-full" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="tab-content hidden">
            <!-- Back Button -->
            <button onclick="showHome()" class="glass-card px-4 py-2 rounded-lg text-gray-300 font-semibold text-sm border border-white/10 active:scale-95 transition-transform mb-4 flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i>
                Volver al Inicio
            </button>
            <div class="glass-card p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-4">üìÖ Historial de Entrenamientos</h2>
                <div id="historyList" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">No hay entrenamientos guardados a√∫n</p>
                </div>
            </div>
        </div>

        <!-- PRs Tab -->
        <div id="prsTab" class="tab-content hidden">
            <!-- Back Button -->
            <button onclick="showHome()" class="glass-card px-4 py-2 rounded-lg text-gray-300 font-semibold text-sm border border-white/10 active:scale-95 transition-transform mb-4 flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i>
                Volver al Inicio
            </button>
            <div class="glass-card p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-4">üèÜ Personal Records</h2>
                <div id="prsList" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">Registra tus primeros entrenamientos para ver tus PRs</p>
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profileTab" class="tab-content hidden">
            <!-- Back Button -->
            <button onclick="showHome()" class="glass-card px-4 py-2 rounded-lg text-gray-300 font-semibold text-sm border border-white/10 active:scale-95 transition-transform mb-4 flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i>
                Volver al Inicio
            </button>
            <div class="glass-card p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-display font-bold uppercase mb-2">üë§ Mi Perfil</h2>
                <p class="text-sm text-gray-400 mb-6">Tus datos personales para c√°lculos precisos</p>

                <form id="profileForm" class="space-y-4">
                    <!-- Nombre -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Nombre</label>
                        <input type="text" id="profileName" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-cyan-500" placeholder="Ej: Juan P√©rez">
                    </div>

                    <!-- Fecha de Nacimiento -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Fecha de Nacimiento</label>
                        <input type="date"
                               id="profileBirthdate"
                               class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-cyan-500"
                               max="">
                        <p class="text-xs text-gray-400 mt-1">Tu edad: <span id="calculatedAge" class="text-cyan-400 font-semibold">-</span> a√±os</p>
                    </div>

                    <!-- G√©nero -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">G√©nero</label>
                        <select id="profileGender" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-cyan-500">
                            <option value="male">Hombre</option>
                            <option value="female">Mujer</option>
                        </select>
                    </div>

                    <!-- Peso y Altura -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Peso (kg)</label>
                            <input type="number" step="0.1" id="profileWeight" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-cyan-500" placeholder="70">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-300 mb-2">Altura (cm)</label>
                            <input type="number" id="profileHeight" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-cyan-500" placeholder="175">
                        </div>
                    </div>

                    <!-- Nivel de Actividad -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Nivel de Actividad</label>
                        <select id="profileActivity" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-cyan-500">
                            <option value="1.2">Sedentario (poco o ning√∫n ejercicio)</option>
                            <option value="1.375">Ligero (1-3 d√≠as/semana)</option>
                            <option value="1.55" selected>Moderado (3-5 d√≠as/semana)</option>
                            <option value="1.725">Activo (6-7 d√≠as/semana)</option>
                            <option value="1.9">Muy Activo (2 veces al d√≠a)</option>
                        </select>
                    </div>

                    <!-- Bot√≥n Guardar -->
                    <button type="submit" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-cyan-500/30 active:scale-95 transition-transform">
                        üíæ Guardar Perfil
                    </button>
                </form>

                <div id="profileSaveMessage" class="hidden mt-4 p-3 bg-green-500/10 border-l-4 border-green-500 rounded-lg">
                    <p class="text-green-400 font-semibold">‚úÖ Perfil guardado correctamente</p>
                </div>
            </div>
        </div>

        <!-- Workout Builder Tab -->
        <div id="workoutBuilderTab" class="tab-content hidden">
            <!-- Header -->
            <div class="glass-card p-4 mb-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl md:text-2xl font-display font-bold uppercase text-white">‚ú® Crear Entrenamiento</h2>
                        <p class="text-sm text-gray-400 mt-1">Dise√±a tu rutina personalizada</p>
                    </div>
                    <button onclick="closeWorkoutBuilder()" class="text-gray-400 hover:text-white text-3xl active:scale-95 transition-transform">√ó</button>
                </div>
            </div>

            <!-- Step Indicator -->
            <div class="glass-card p-3 mb-4">
                <div class="flex items-center justify-between text-xs">
                    <div class="flex items-center gap-2">
                        <div id="step1Indicator" class="w-6 h-6 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold">1</div>
                        <span id="step1Text" class="text-cyan-400 font-semibold">Ejercicios</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-dark-surface mx-2"></div>
                    <div class="flex items-center gap-2">
                        <div id="step2Indicator" class="w-6 h-6 rounded-full bg-dark-surface border border-white/20 flex items-center justify-center text-gray-500 font-bold">2</div>
                        <span id="step2Text" class="text-gray-500">Revisar</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-dark-surface mx-2"></div>
                    <div class="flex items-center gap-2">
                        <div id="step3Indicator" class="w-6 h-6 rounded-full bg-dark-surface border border-white/20 flex items-center justify-center text-gray-500 font-bold">3</div>
                        <span id="step3Text" class="text-gray-500">Nombrar</span>
                    </div>
                </div>
            </div>

            <!-- Step 1: Select Exercises -->
            <div id="builderStep1" class="space-y-4">
                <!-- Filter by muscle group -->
                <div class="glass-card p-4">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Filtrar por grupo muscular:</label>
                    <select id="muscleGroupFilter" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-cyan-500">
                        <option value="all">üìã Todos los ejercicios</option>
                        <option value="pecho">ü´Ä Pecho</option>
                        <option value="espalda">üîô Espalda</option>
                        <option value="hombros">üí™ Hombros</option>
                        <option value="biceps">üí™ B√≠ceps</option>
                        <option value="triceps">üí™ Tr√≠ceps</option>
                        <option value="piernas">ü¶µ Piernas</option>
                        <option value="gluteos">üçë Gl√∫teos</option>
                        <option value="core">üéØ Core/Abdomen</option>
                    </select>
                </div>

                <!-- Exercise List -->
                <div id="exercisesList" class="space-y-2">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Selected count -->
                <div class="glass-card p-4 border-l-4 border-cyan-500">
                    <p class="text-sm text-gray-300">
                        <strong class="text-cyan-400 text-lg" id="selectedCount">0</strong> ejercicios seleccionados
                    </p>
                </div>

                <button onclick="goToStep2()" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-cyan-500/30 active:scale-95 transition-transform">
                    Continuar ‚Üí
                </button>
            </div>

            <!-- Step 2: Review & Organize -->
            <div id="builderStep2" class="hidden space-y-4">
                <div class="glass-card p-4">
                    <h3 class="text-lg font-display font-bold uppercase text-white mb-4">üìã Ejercicios Seleccionados</h3>
                    <div id="selectedExercisesList" class="space-y-2">
                        <!-- Will be populated -->
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="goToStep1()" class="bg-dark-surface border border-white/10 hover:bg-dark-surface/80 text-gray-300 font-bold py-3 rounded-xl active:scale-95 transition-transform">
                        ‚Üê Atr√°s
                    </button>
                    <button onclick="goToStep3()" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-cyan-500/30 active:scale-95 transition-transform">
                        Continuar ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 3: Name & Save -->
            <div id="builderStep3" class="hidden space-y-4">
                <div class="glass-card p-4">
                    <h3 class="text-lg font-display font-bold uppercase text-white mb-4">üè∑Ô∏è Nombra tu rutina</h3>

                    <!-- Suggested names -->
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-300 mb-2">Sugerencias basadas en grupos musculares:</label>
                        <div id="suggestedNames" class="space-y-2">
                            <!-- Will be populated -->
                        </div>
                    </div>

                    <!-- Custom name -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-300 mb-2">O escribe un nombre personalizado:</label>
                        <input type="text" id="customWorkoutName" class="w-full px-4 py-2 bg-dark-surface border border-white/10 rounded-lg text-white focus:border-cyan-500" placeholder="Ej: Mi Rutina de Lunes">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <button onclick="goToStep2()" class="bg-dark-surface border border-white/10 hover:bg-dark-surface/80 text-gray-300 font-bold py-3 rounded-xl active:scale-95 transition-transform">
                        ‚Üê Atr√°s
                    </button>
                    <button onclick="saveCustomWorkout()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-green-500/30 active:scale-95 transition-transform">
                        üíæ Guardar Rutina
                    </button>
                </div>
            </div>
        </div>

        <!-- CARDIO HIIT SYSTEM -->
        <!-- Vista Selector de Modos -->
        <div id="cardioSelectorView" class="hidden space-y-6">
            <button onclick="showHome()" class="glass-card px-4 py-2 rounded-lg text-gray-300 font-semibold text-sm border border-white/10 active:scale-95 transition-transform flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i>
                Volver al Inicio
            </button>

            <h2 class="text-2xl font-display font-bold uppercase text-orange-400">üî• Cardio & HIIT</h2>
            <p class="text-gray-300">Elige tu tipo de entrenamiento cardiovascular</p>

            <div class="space-y-4">
                <div onclick="showCardioConfig('emom')" class="glass-card p-5 cursor-pointer active:scale-95 transition-transform border-l-4 border-orange-500 hover:bg-white/5">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white mb-2">‚è±Ô∏è EMOM</h3>
                            <p class="text-sm text-gray-300 font-semibold mb-2">Every Minute On the Minute</p>
                            <p class="text-sm text-gray-400">Haz X repeticiones al inicio de cada minuto. El resto del tiempo descansas. Perfecto para mantener ritmo constante.</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-orange-400 text-xl ml-4"></i>
                    </div>
                </div>

                <div onclick="showCardioConfig('tabata')" class="glass-card p-5 cursor-pointer active:scale-95 transition-transform border-l-4 border-red-500 hover:bg-white/5">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white mb-2">üî• TABATA</h3>
                            <p class="text-sm text-gray-300 font-semibold mb-2">20 segundos ON / 10 segundos OFF</p>
                            <p class="text-sm text-gray-400">El cl√°sico: 20s trabajo, 10s descanso, 8 rondas (4 min total). Intensidad m√°xima para quemar calor√≠as r√°pido.</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-red-400 text-xl ml-4"></i>
                    </div>
                </div>

                <div onclick="showCardioConfig('circuit')" class="glass-card p-5 cursor-pointer active:scale-95 transition-transform border-l-4 border-yellow-500 hover:bg-white/5">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white mb-2">üîÑ CIRCUITO</h3>
                            <p class="text-sm text-gray-300 font-semibold mb-2">M√∫ltiples ejercicios en secuencia</p>
                            <p class="text-sm text-gray-400">Haz varios ejercicios seguidos, descansa y repite X rondas. Control total sobre tu rutina funcional.</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-yellow-400 text-xl ml-4"></i>
                    </div>
                </div>

                <div onclick="showCardioConfig('pyramid')" class="glass-card p-5 cursor-pointer active:scale-95 transition-transform border-l-4 border-purple-500 hover:bg-white/5">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white mb-2">üìä PIR√ÅMIDE</h3>
                            <p class="text-sm text-gray-300 font-semibold mb-2">Sube y baja en intensidad</p>
                            <p class="text-sm text-gray-400">Incrementa el tiempo/reps, llega al pico y baja gradualmente. Ejemplo: 20-30-40-30-20. Progresi√≥n controlada.</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-purple-400 text-xl ml-4"></i>
                    </div>
                </div>

                <div onclick="showCardioConfig('custom')" class="glass-card p-5 cursor-pointer active:scale-95 transition-transform border-l-4 border-cyan-500 hover:bg-white/5">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white mb-2">‚öôÔ∏è HIIT PERSONALIZADO</h3>
                            <p class="text-sm text-gray-300 font-semibold mb-2">Configura todo a tu medida</p>
                            <p class="text-sm text-gray-400">Define tus propios intervalos, ejercicios y tiempos. M√°xima flexibilidad para tu rutina √∫nica.</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-cyan-400 text-xl ml-4"></i>
                    </div>
                </div>

                <div onclick="showCardioConfig('amrap')" class="glass-card p-5 cursor-pointer active:scale-95 transition-transform border-l-4 border-green-500 hover:bg-white/5">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white mb-2">üéØ AMRAP</h3>
                            <p class="text-sm text-gray-300 font-semibold mb-2">As Many Rounds As Possible</p>
                            <p class="text-sm text-gray-400">Temporizador cuenta regresiva. Haz tantas rondas como puedas en X minutos. Desaf√≠ate a ti mismo.</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-green-400 text-xl ml-4"></i>
                    </div>
                </div>

                <div onclick="showCardioConfig('fortime')" class="glass-card p-5 cursor-pointer active:scale-95 transition-transform border-l-4 border-pink-500 hover:bg-white/5">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-white mb-2">üèÅ FOR TIME</h3>
                            <p class="text-sm text-gray-300 font-semibold mb-2">Completa X rondas lo m√°s r√°pido posible</p>
                            <p class="text-sm text-gray-400">Tienes un n√∫mero fijo de rondas. El reloj corre. ¬øCu√°nto tardas en terminar? Compite contigo mismo.</p>
                        </div>
                        <i class="ph-bold ph-caret-right text-pink-400 text-xl ml-4"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista de Configuraci√≥n (Multi-modo) -->
        <div id="cardioConfigView" class="hidden space-y-6">
            <button onclick="showCardioSelector()" class="glass-card px-4 py-2 rounded-lg text-gray-300 font-semibold text-sm border border-white/10 active:scale-95 transition-transform flex items-center gap-2">
                <i class="ph-bold ph-arrow-left"></i>
                Volver
            </button>

            <h2 id="cardioConfigTitle" class="text-2xl font-display font-bold uppercase text-orange-400"></h2>

            <div id="cardioConfigContent" class="space-y-4">
                <!-- El contenido se genera din√°micamente seg√∫n el modo -->
            </div>

            <button onclick="startCardioTimer()" id="btnStartCardio" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-orange-500/30 active:scale-95 transition-transform text-lg">
                üöÄ Iniciar Entrenamiento
            </button>
        </div>

        <!-- Vista de Ejecuci√≥n/Timer -->
        <div id="cardioTimerView" class="hidden space-y-6">
            <div class="glass-card p-6 text-center">
                <p id="timerRoundInfo" class="text-sm text-gray-400 mb-2">Ronda 1/3</p>
                <h2 id="timerPhase" class="text-3xl font-bold text-orange-400 mb-4">üî• TRABAJO</h2>

                <div id="timerDisplay" class="text-7xl font-display font-bold text-white my-6">00:00</div>

                <div id="timerProgress" class="w-full bg-dark-surface border border-white/10 rounded-full h-4 mb-4">
                    <div id="timerProgressBar" class="bg-gradient-to-r from-orange-500 to-red-500 h-4 rounded-full transition-all duration-1000" style="width: 0%"></div>
                </div>

                <h3 id="timerExercise" class="text-2xl font-bold text-white mb-2">Burpees</h3>
                <p id="timerExerciseTarget" class="text-gray-400">30 repeticiones</p>
                <p id="timerNextInfo" class="text-sm text-cyan-400 mt-4">Siguiente: Descanso 15s</p>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="pauseCardioTimer()" id="btnPauseTimer" class="glass-card p-4 text-yellow-400 font-semibold rounded-xl active:scale-95 transition-transform">
                    <i class="ph-bold ph-pause text-2xl"></i><br>
                    Pausar
                </button>
                <button onclick="stopCardioTimer()" class="glass-card p-4 text-red-400 font-semibold rounded-xl active:scale-95 transition-transform">
                    <i class="ph-bold ph-stop text-2xl"></i><br>
                    Terminar
                </button>
            </div>
        </div>

        <!-- Vista de Resumen -->
        <div id="cardioSummaryView" class="hidden space-y-6">
            <div class="text-center mb-6">
                <div class="text-6xl mb-4">üèÜ</div>
                <h2 class="text-3xl font-bold text-white mb-2">¬°Sesi√≥n Completada!</h2>
                <p class="text-gray-400">Excelente trabajo</p>
            </div>

            <div class="glass-card p-6">
                <h3 class="text-lg font-bold text-white mb-4">üìä Estad√≠sticas</h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-400">‚è±Ô∏è Tiempo total:</span>
                        <span id="summaryTotalTime" class="text-white font-bold">0:00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">üî• Tiempo trabajo:</span>
                        <span id="summaryWorkTime" class="text-white font-bold">0:00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">üòÆ‚Äçüí® Descanso:</span>
                        <span id="summaryRestTime" class="text-white font-bold">0:00</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">üîÑ Rondas:</span>
                        <span id="summaryRounds" class="text-white font-bold">0/0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">üî• Calor√≠as (est.):</span>
                        <span id="summaryCalories" class="text-orange-400 font-bold">0 kcal</span>
                    </div>
                </div>
            </div>

            <div id="summaryExercises" class="glass-card p-6">
                <!-- Se llena din√°micamente con los ejercicios realizados -->
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="showHome()" class="glass-card p-4 text-gray-300 font-semibold rounded-xl active:scale-95 transition-transform">
                    üè† Inicio
                </button>
                <button onclick="saveCardioSession()" class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/30 active:scale-95 transition-transform">
                    üíæ Guardar
                </button>
            </div>
        </div>
        <!-- END CARDIO HIIT SYSTEM -->

    </main>

    <!-- Bottom Navigation Bar with FAB -->
    <nav class="bottom-nav">
        <div class="bottom-nav-item active" data-nav="home">
            <i class="ph-bold ph-house text-xl"></i>
            <span>Inicio</span>
        </div>
        <div class="bottom-nav-item" data-nav="charts">
            <i class="ph-bold ph-chart-line text-xl"></i>
            <span>Gr√°ficos</span>
        </div>
        <div class="fab" id="fabButton">
            <i class="ph-bold ph-plus text-white text-3xl"></i>
        </div>
        <div class="bottom-nav-item" data-nav="history">
            <i class="ph-bold ph-clock-counter-clockwise text-xl"></i>
            <span>Historial</span>
        </div>
        <div class="bottom-nav-item" data-nav="profile">
            <i class="ph-bold ph-user text-xl"></i>
            <span>Perfil</span>
        </div>
    </nav>

    <!-- Animation Modal -->
    <div id="animationModal" class="modal">
        <div class="glass-card p-4 md:p-6 max-w-2xl w-full mx-4 modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-lg md:text-2xl font-display font-bold uppercase text-white"></h3>
                <button id="closeModal" class="text-gray-400 hover:text-white text-3xl font-bold transition-colors">&times;</button>
            </div>
            <div id="animationContainer" class="bg-dark-surface rounded-xl p-4 min-h-[300px] md:min-h-[400px] flex items-center justify-center border border-white/10">
                <p class="text-gray-400">Cargando imagen de referencia...</p>
            </div>
        </div>
    </div>

    <!-- Rest Timer Modal -->
    <div id="restTimerModal" class="modal">
        <div class="glass-card p-6 max-w-md w-full mx-4">
            <h3 class="text-2xl font-display font-bold uppercase mb-4">‚è±Ô∏è Tiempo de Descanso</h3>
            <p class="text-gray-400 mb-4">¬øCu√°nto tiempo quieres descansar?</p>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="60">1 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="90">1.5 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="120">2 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="180">3 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="240">4 min</button>
                <button class="rest-time-btn bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 p-4 rounded-xl font-bold text-white active:scale-95 transition-transform" data-seconds="300">5 min</button>
            </div>
            <button id="closeRestModal" class="w-full bg-dark-surface border border-white/10 hover:bg-dark-surface/80 text-gray-300 font-bold py-3 rounded-xl active:scale-95 transition-transform">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Rest Timer Fullscreen Display -->
    <div id="restTimerBanner" class="modal">
        <div class="glass-card p-8 max-w-lg w-full mx-4 text-center">
            <div class="mb-8">
                <div class="text-8xl mb-4">‚è±Ô∏è</div>
                <h3 class="text-2xl font-display font-bold uppercase text-white mb-2">Tiempo de Descanso</h3>
                <p class="text-gray-400">Rel√°jate y recup√©rate</p>
            </div>

            <div class="relative mb-8">
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-64 h-64 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-full blur-3xl"></div>
                </div>
                <div class="relative">
                    <p class="text-9xl font-bold font-display text-white drop-shadow-2xl" id="timerDisplay">00:00</p>
                </div>
            </div>

            <div class="flex gap-4 justify-center">
                <button id="pauseTimer" class="bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg shadow-yellow-500/30 active:scale-95 transition-transform">
                    ‚è∏ Pausar
                </button>
                <button id="stopTimer" class="bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg shadow-red-500/30 active:scale-95 transition-transform">
                    ‚èπ Detener
                </button>
            </div>
        </div>
    </div>

    <!-- Confirm Workout Change Modal -->
    <div id="confirmChangeModal" class="modal">
        <div class="glass-card p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-display font-bold uppercase mb-4 text-yellow-400">‚ö†Ô∏è Cambios Sin Guardar</h3>
            <p id="confirmChangeMessage" class="text-gray-300 mb-6"></p>

            <div class="space-y-3">
                <button id="confirmResumeBtn" class="w-full bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-semibold py-3 rounded-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <i class="ph-bold ph-play"></i>
                    Reanudar ahora
                </button>
                <button id="confirmSaveBtn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white font-semibold py-3 rounded-lg active:scale-95 transition-transform">
                    üíæ Guardar y continuar
                </button>
                <button id="confirmDiscardBtn" class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white font-semibold py-3 rounded-lg active:scale-95 transition-transform">
                    üóëÔ∏è Descartar y continuar
                </button>
                <button id="confirmCancelBtn" class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg active:scale-95 transition-transform">
                    ‚Üê Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Resume Draft Modal -->
    <div id="resumeDraftModal" class="modal">
        <div class="glass-card p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-display font-bold uppercase mb-4 text-cyan-400">üìù Sesi√≥n Pendiente</h3>
            <p class="text-gray-300 mb-4">Tienes una sesi√≥n sin terminar:</p>

            <div id="resumeDraftMessage" class="bg-dark-surface border border-white/10 rounded-lg p-4 mb-6 space-y-2 text-sm text-gray-300">
            </div>

            <div class="space-y-3">
                <button id="resumeDraftBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-3 rounded-lg active:scale-95 transition-transform">
                    ‚úÖ Reanudar sesi√≥n
                </button>
                <button id="discardDraftBtn" class="w-full bg-gray-600 text-white font-semibold py-3 rounded-lg active:scale-95 transition-transform">
                    üóëÔ∏è Descartar y empezar nueva
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // EXERCISE GIF MAPPING (ExerciseDB API)
        // ==========================================
        const exerciseGifs = {
            // Using free exercise images from GitHub (free-exercise-db) - Public Domain
            // These images are hosted on GitHub's raw CDN with proper CORS support
            "Hip Thrust (core lift)": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Hip_Thrust/0.jpg",
            "RDL": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Deadlift/0.jpg",
            "Prensa": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Bench_Press_-_Medium_Grip/0.jpg",
            "Abducciones": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Band_Hip_Adductions/0.jpg",
            "Aducciones": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Adductor/0.jpg",
            "Extensi√≥n de cu√°driceps": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Hack_Squat/0.jpg",
            "Press militar": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Shoulder_Press/0.jpg",
            "Elevaci√≥n lateral": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Alternating_Deltoid_Raise/0.jpg",
            "Press de pecho": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Bench_Press_-_Medium_Grip/0.jpg",
            "Elevaci√≥n frontal / Y-Raise": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Incline_Shoulder_Raise/0.jpg",
            "Tr√≠ceps cuerda": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Band_Skull_Crusher/0.jpg",
            "Extensi√≥n o fondos": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Bench_Dips/0.jpg",
            "Face pull (opcional)": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Bent_Over_Low-Pulley_Side_Lateral/0.jpg",
            "Hack squat": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Hack_Squat/0.jpg",
            "Zancada estacionaria": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Lunge/0.jpg",
            "Prensa quad-dominante": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Bench_Press_-_Medium_Grip/0.jpg",
            "Jal√≥n pecho": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Band_Assisted_Pull-Up/0.jpg",
            "Remo sentado": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Bent_Over_Barbell_Row/0.jpg",
            "Remo mancuerna": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Bent_Over_Two-Dumbbell_Row/0.jpg",
            "Curl barra": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Curl/0.jpg",
            "Curl martillo": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Alternate_Hammer_Curl/0.jpg",
            "Curl martillo cross-body": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Alternate_Hammer_Curl/0.jpg",
            "Tr√≠ceps aislado": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Band_Skull_Crusher/0.jpg",
            "Hip Thrust ligero": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Barbell_Hip_Thrust/0.jpg",
            "Abs en m√°quina": "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/exercises/Ab_Crunch_Machine/0.jpg"
        };

        // ==========================================
        // DATA STRUCTURE - All Training Groups
        // ==========================================
        const trainingGroups = {
            grupo1: {
                nombre: "GRUPO 1 - Piernas + Gl√∫teos",
                ejercicios: [
                    { nombre: "Hip Thrust (core lift)", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "RDL", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Prensa", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Abducciones", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Aducciones", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Extensi√≥n de cu√°driceps", esMancuerna: false, grupoMuscular: "Piernas" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            },
            grupo2: {
                nombre: "GRUPO 2 - Upper Push",
                ejercicios: [
                    { nombre: "Press militar", esMancuerna: false, grupoMuscular: "Hombros" },
                    { nombre: "Elevaci√≥n lateral", esMancuerna: true, grupoMuscular: "Hombros" },
                    { nombre: "Press de pecho", esMancuerna: false, grupoMuscular: "Pecho" },
                    { nombre: "Elevaci√≥n frontal / Y-Raise", esMancuerna: true, grupoMuscular: "Hombros" },
                    { nombre: "Tr√≠ceps cuerda", esMancuerna: false, grupoMuscular: "Tr√≠ceps" },
                    { nombre: "Extensi√≥n o fondos", esMancuerna: false, grupoMuscular: "Tr√≠ceps" },
                    { nombre: "Face pull (opcional)", esMancuerna: false, grupoMuscular: "Hombros" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            },
            grupo3: {
                nombre: "GRUPO 3 - Piernas Quad Dominante",
                ejercicios: [
                    { nombre: "Hack squat", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Extensi√≥n de cu√°driceps", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Zancada estacionaria", esMancuerna: false, grupoMuscular: "Piernas" },
                    { nombre: "Prensa quad-dominante", esMancuerna: false, grupoMuscular: "Piernas" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            },
            grupo4: {
                nombre: "GRUPO 4 - Espalda + B√≠ceps",
                ejercicios: [
                    { nombre: "Jal√≥n pecho", esMancuerna: false, grupoMuscular: "Espalda" },
                    { nombre: "Remo sentado", esMancuerna: false, grupoMuscular: "Espalda" },
                    { nombre: "Remo mancuerna", esMancuerna: true, grupoMuscular: "Espalda" },
                    { nombre: "Curl barra", esMancuerna: false, grupoMuscular: "B√≠ceps" },
                    { nombre: "Curl martillo", esMancuerna: true, grupoMuscular: "B√≠ceps" },
                    { nombre: "Curl martillo cross-body", esMancuerna: true, grupoMuscular: "B√≠ceps" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            },
            grupo5: {
                nombre: "GRUPO 5 - Hombro + Tr√≠ceps (aislamiento)",
                ejercicios: [
                    { nombre: "Elevaci√≥n lateral", esMancuerna: true, grupoMuscular: "Hombros" },
                    { nombre: "Elevaci√≥n frontal", esMancuerna: true, grupoMuscular: "Hombros" },
                    { nombre: "Press ligero o m√°quinas", esMancuerna: false, grupoMuscular: "Hombros" },
                    { nombre: "Tr√≠ceps aislado", esMancuerna: false, grupoMuscular: "Tr√≠ceps" },
                    { nombre: "Finisher hombro (30-20-10): Lateral ‚Üí Frontal ‚Üí Press", esMancuerna: false, grupoMuscular: "Hombros" }
                ],
                opcionales: [
                    { nombre: "Hip Thrust ligero", esMancuerna: false, grupoMuscular: "Gl√∫teos" },
                    { nombre: "Abs en m√°quina", esMancuerna: false, grupoMuscular: "Core" }
                ]
            }
        };

        // ==========================================
        // STATE MANAGEMENT
        // ==========================================
        let currentGroup = null;
        let sessionData = {
            date: new Date().toISOString().split('T')[0],
            grupo: "",
            ejercicios: [],
            volumenTotal: 0,
            volumenPorGrupo: {}
        };

        let restTimer = null;
        let restTimeRemaining = 0;
        let isPaused = false;

        // Draft auto-save management
        let draftSaveTimeout = null;
        const DRAFT_SAVE_DELAY = 15000; // 15 segundos
        let hasUnsavedChanges = false;
        let lastSavedState = null;

        // Session state tracking (prevent duplicate saves)
        let sessionSaved = false; // Flag to track if current session has been saved
        let lastSavedData = null; // Snapshot of data when last saved
        let sessionId = null; // Unique ID for current workout session

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================

        function calculateVolume(sets, reps, peso, esMancuerna) {
            const pesoFinal = esMancuerna ? peso * 2 : peso;
            return sets * reps * pesoFinal;
        }

        function validateDecimalInput(input) {
            const value = input.value;
            if (value.includes(',')) {
                input.classList.add('input-error');
                showError(input, 'Usa punto (.) para decimales');
                return false;
            } else {
                input.classList.remove('input-error');
                hideError(input);
                return true;
            }
        }

        function showError(input, message) {
            let errorDiv = input.parentElement.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message text-red-500 text-sm mt-1';
                input.parentElement.appendChild(errorDiv);
            }
            errorDiv.textContent = message;
        }

        function hideError(input) {
            const errorDiv = input.parentElement.querySelector('.error-message');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        function calculateVolumenPorGrupo() {
            const volumenPorGrupo = {};

            sessionData.ejercicios.forEach(ej => {
                // Only count exercises with actual volume
                if (ej.volumen > 0) {
                    const grupo = ej.grupoMuscular;
                    if (!volumenPorGrupo[grupo]) {
                        volumenPorGrupo[grupo] = 0;
                    }
                    volumenPorGrupo[grupo] += ej.volumen;
                }
            });

            sessionData.volumenPorGrupo = volumenPorGrupo;
            return volumenPorGrupo;
        }

        // ==========================================
        // DRAFT & UNSAVED CHANGES MANAGEMENT
        // ==========================================

        function hasUnsavedData() {
            // Chequear si hay ejercicios con datos ingresados
            const hasData = sessionData.ejercicios.some(ej =>
                (ej.sets && ej.sets > 0) ||
                (ej.reps && ej.reps > 0) ||
                (ej.peso && ej.peso > 0) ||
                ej.completado
            );
            return hasData;
        }

        function saveDraft() {
            if (!hasUnsavedData()) {
                return; // No guardar si no hay datos
            }

            const draft = {
                ...sessionData,
                draftSavedAt: new Date().toISOString(),
                draftTimestamp: Date.now()
            };

            localStorage.setItem('gymmate_draft', JSON.stringify(draft));
            console.log('üìù Borrador guardado autom√°ticamente');
        }

        function scheduleDraftSave() {
            // Limpiar timeout anterior si existe
            if (draftSaveTimeout) {
                clearTimeout(draftSaveTimeout);
            }

            // Marcar que hay cambios sin guardar
            hasUnsavedChanges = true;
            updateUnsavedIndicator();

            // Programar guardado despu√©s de 15 segundos de inactividad
            draftSaveTimeout = setTimeout(() => {
                saveDraft();
                hasUnsavedChanges = false;
                // Mostrar indicador de guardado exitoso
                showSavedIndicator();
            }, DRAFT_SAVE_DELAY);
        }

        function updateUnsavedIndicator() {
            const indicator = document.getElementById('unsavedIndicator');
            if (!indicator) return;

            if (hasUnsavedChanges && hasUnsavedData()) {
                // Mostrar indicador con animaci√≥n
                if (indicator.classList.contains('hidden')) {
                    indicator.classList.remove('hidden');
                    indicator.classList.add('unsaved-indicator-show');
                    indicator.classList.remove('unsaved-indicator-hide');
                }
            } else {
                // Ocultar con animaci√≥n hacia arriba
                if (!indicator.classList.contains('hidden')) {
                    indicator.classList.remove('unsaved-indicator-show');
                    indicator.classList.add('unsaved-indicator-hide');
                    setTimeout(() => {
                        indicator.classList.add('hidden');
                        indicator.classList.remove('unsaved-indicator-hide');
                    }, 400); // Duraci√≥n de la animaci√≥n
                }
            }
        }

        function showSavedIndicator() {
            const indicator = document.getElementById('unsavedIndicator');
            if (!indicator) return;

            // Cambiar texto a "Guardado"
            indicator.innerHTML = `
                <span>‚úì</span>
                Guardado
            `;

            // Animar cambio de color a verde
            indicator.classList.add('unsaved-indicator-saved');

            // Despu√©s de 1.5 segundos, ocultar con animaci√≥n hacia arriba
            setTimeout(() => {
                indicator.classList.remove('unsaved-indicator-show');
                indicator.classList.add('unsaved-indicator-hide');

                setTimeout(() => {
                    indicator.classList.add('hidden');
                    indicator.classList.remove('unsaved-indicator-hide', 'unsaved-indicator-saved');
                    // Restaurar contenido original
                    indicator.innerHTML = `
                        <span class="animate-pulse">‚óè</span>
                        Cambios sin guardar
                    `;
                }, 400);
            }, 1500);
        }

        // ==========================================
        // SESSION STATE MANAGEMENT (Prevent Duplicate Saves)
        // ==========================================

        function hasChangesToSave() {
            // Si nunca se ha guardado, cualquier dato cuenta como cambio
            if (!sessionSaved || !lastSavedData) {
                return hasUnsavedData();
            }

            // Comparar snapshot actual con el √∫ltimo guardado
            const currentSnapshot = JSON.stringify(sessionData.ejercicios);
            const savedSnapshot = JSON.stringify(lastSavedData);

            const hasChanges = currentSnapshot !== savedSnapshot;

            // Debug: descomentar para ver cambios
            // if (hasChanges) {
            //     console.log('üîç Cambios detectados');
            //     console.log('Current:', currentSnapshot);
            //     console.log('Saved:', savedSnapshot);
            // }

            return hasChanges;
        }

        function updateSaveButtonState() {
            const saveButton = document.getElementById('saveButton');
            if (!saveButton) return;

            const hasChanges = hasChangesToSave();

            if (!hasChanges && sessionSaved) {
                // Todo est√° guardado, sin cambios
                saveButton.innerHTML = '‚úÖ Todo Guardado';
                saveButton.disabled = true;
                saveButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else if (sessionSaved && hasChanges) {
                // Ya se guard√≥ una vez, pero hay cambios nuevos
                saveButton.innerHTML = 'üíæ Actualizar Entrenamiento';
                saveButton.disabled = false;
                saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                // Primera vez guardando
                saveButton.innerHTML = 'üíæ Guardar Entrenamiento';
                saveButton.disabled = false;
                saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function endSession() {
            // Si hay cambios sin guardar, preguntar
            if (hasChangesToSave() && hasUnsavedData()) {
                const confirmEnd = confirm('‚ö†Ô∏è Tienes cambios sin guardar. ¬øEst√°s seguro de que quieres terminar la sesi√≥n sin guardar?');
                if (!confirmEnd) {
                    return; // No terminar si cancela
                }
            }

            // Mostrar mensaje de feedback
            const saveMessage = document.getElementById('saveMessage');
            saveMessage.textContent = 'üèÅ Sesi√≥n terminada correctamente';
            saveMessage.classList.remove('hidden', 'text-green-400');
            saveMessage.classList.add('text-orange-400');

            // Limpiar todo el estado de la sesi√≥n
            localStorage.removeItem('gymmate_draft');
            localStorage.removeItem('gymmate_session');

            // Resetear flags
            sessionSaved = false;
            lastSavedData = null;
            sessionId = null;
            hasUnsavedChanges = false;

            if (draftSaveTimeout) {
                clearTimeout(draftSaveTimeout);
            }

            // Resetear sessionData
            sessionData.grupo = '';
            sessionData.date = new Date().toISOString();
            sessionData.ejercicios = [];
            sessionData.volumenTotal = 0;
            sessionData.volumenPorGrupo = {};

            // Esperar 1 segundo para mostrar feedback, luego ir al home
            setTimeout(() => {
                saveMessage.classList.add('hidden');
                saveMessage.classList.remove('text-orange-400');
                saveMessage.classList.add('text-green-400');

                // Volver al home
                showView('home');

                // Actualizar hero section (puede haber cambios despu√©s de guardar)
                updateHeroSection();

                // Actualizar tarjeta de reanudar
                updateResumeWorkoutCard();
            }, 1000);
        }

        function updateResumeWorkoutCard() {
            const card = document.getElementById('resumeWorkoutCard');
            if (!card) return;

            if (hasUnsavedData()) {
                // Calcular estad√≠sticas
                const exercisesWithData = sessionData.ejercicios.filter(ej => ej.volumen > 0).length;
                const totalSets = sessionData.ejercicios.reduce((sum, ej) => sum + (ej.sets || 0), 0);

                // Actualizar informaci√≥n
                document.getElementById('resumeWorkoutName').textContent = sessionData.grupo || 'Rutina sin nombre';
                document.getElementById('resumeWorkoutExercises').textContent = exercisesWithData;
                document.getElementById('resumeWorkoutVolume').textContent = sessionData.volumenTotal.toFixed(0);
                document.getElementById('resumeWorkoutSets').textContent = totalSets;

                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        }

        function resumeWorkoutFromCard() {
            switchTab('workout');
        }

        function discardResumeWorkout() {
            if (confirm('¬øEst√°s seguro de que quieres descartar esta sesi√≥n?')) {
                sessionData.ejercicios = [];
                sessionData.volumenTotal = 0;
                localStorage.removeItem('gymmate_draft');
                hasUnsavedChanges = false;
                updateUnsavedIndicator();
                updateResumeWorkoutCard();
            }
        }

        function confirmWorkoutChange(callback, newWorkoutName) {
            if (!hasUnsavedData()) {
                // Si no hay datos, ejecutar directamente
                callback();
                return;
            }

            // Mostrar modal de confirmaci√≥n
            const modal = document.getElementById('confirmChangeModal');
            const message = document.getElementById('confirmChangeMessage');

            message.textContent = `Tienes cambios sin guardar en "${sessionData.grupo}". ¬øDeseas cambiar a "${newWorkoutName}"?`;

            modal.classList.add('active');

            // Bot√≥n "Reanudar despu√©s"
            document.getElementById('confirmResumeBtn').onclick = () => {
                modal.classList.remove('active');
                // No hacer nada, mantener draft y ejecutar callback
                callback();
                // Asegurarse de que la carta se actualice cuando vuelva a home
            };

            // Bot√≥n "Guardar y continuar"
            document.getElementById('confirmSaveBtn').onclick = () => {
                modal.classList.remove('active');
                saveToLocalStorage();
                hasUnsavedChanges = false;
                updateUnsavedIndicator();
                setTimeout(() => {
                    callback();
                }, 500);
            };

            // Bot√≥n "Descartar y continuar"
            document.getElementById('confirmDiscardBtn').onclick = () => {
                modal.classList.remove('active');
                // Limpiar draft al cambiar
                localStorage.removeItem('gymmate_draft');
                hasUnsavedChanges = false;
                updateUnsavedIndicator();
                callback();
            };

            // Bot√≥n "Cancelar"
            document.getElementById('confirmCancelBtn').onclick = () => {
                modal.classList.remove('active');
            };
        }

        function checkForDraft() {
            const draft = localStorage.getItem('gymmate_draft');
            if (!draft) return;

            try {
                const draftData = JSON.parse(draft);
                const draftAge = Date.now() - draftData.draftTimestamp;

                // Solo ofrecer recuperar si el draft tiene menos de 24 horas
                if (draftAge > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('gymmate_draft');
                    return;
                }

                const draftDate = new Date(draftData.draftSavedAt).toLocaleString('es-ES');
                const modal = document.getElementById('resumeDraftModal');
                const message = document.getElementById('resumeDraftMessage');

                message.innerHTML = `
                    <p><strong>Rutina:</strong> ${draftData.grupo}</p>
                    <p><strong>Guardado:</strong> ${draftDate}</p>
                    <p><strong>Ejercicios con datos:</strong> ${draftData.ejercicios.filter(ej => ej.volumen > 0).length}</p>
                `;

                modal.classList.add('active');

                // Bot√≥n "Reanudar"
                document.getElementById('resumeDraftBtn').onclick = () => {
                    modal.classList.remove('active');
                    restoreDraft(draftData);
                };

                // Bot√≥n "Descartar"
                document.getElementById('discardDraftBtn').onclick = () => {
                    modal.classList.remove('active');
                    localStorage.removeItem('gymmate_draft');
                };

            } catch (e) {
                console.error('Error al cargar draft:', e);
                localStorage.removeItem('gymmate_draft');
            }
        }

        function restoreDraft(draftData) {
            sessionData = {
                date: draftData.date,
                grupo: draftData.grupo,
                ejercicios: draftData.ejercicios,
                volumenTotal: draftData.volumenTotal,
                volumenPorGrupo: draftData.volumenPorGrupo
            };

            // Cambiar a vista de workout
            switchTab('workout');

            // Mostrar informaci√≥n de entrenamiento
            document.getElementById('trainingInfo').classList.remove('hidden');
            document.getElementById('currentTraining').textContent = draftData.grupo;
            document.getElementById('currentDate').textContent = new Date(draftData.date).toLocaleDateString('es-ES');

            // Renderizar ejercicios
            let html = '';
            draftData.ejercicios.forEach((ej, index) => {
                html += renderEjercicio(ej, index, false);
            });
            document.getElementById('ejerciciosList').innerHTML = html;
            document.getElementById('opcionalesList').innerHTML = '';

            document.getElementById('ejerciciosContainer').classList.remove('hidden');
            document.getElementById('volumeSummary').classList.remove('hidden');
            document.getElementById('saveSection').classList.remove('hidden');
            document.getElementById('quickStats').classList.remove('hidden');

            updateVolumeDisplay();

            // Mostrar notificaci√≥n
            alert('‚úÖ Sesi√≥n restaurada correctamente');
        }

        // ==========================================
        // DYNAMIC HERO SECTION
        // ==========================================

        function getMuscleGroupRecommendation() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            if (history.length === 0) {
                return null; // Usuario nuevo
            }

            // Grupos musculares disponibles
            const allMuscles = ['Piernas', 'Gl√∫teos', 'Pecho', 'Espalda', 'Hombros', 'B√≠ceps', 'Tr√≠ceps', 'Core'];

            // Obtener los 2 √∫ltimos grupos musculares principales entrenados
            const last2Sessions = history.slice(0, 2);
            const last2MainMuscles = [];

            last2Sessions.forEach(session => {
                if (session.volumenPorGrupo && Object.keys(session.volumenPorGrupo).length > 0) {
                    // Obtener el grupo muscular con m√°s volumen en esa sesi√≥n
                    const muscles = Object.entries(session.volumenPorGrupo);
                    const mainMuscle = muscles.reduce((max, curr) =>
                        curr[1] > max[1] ? curr : max
                    );
                    last2MainMuscles.push(mainMuscle[0]);
                }
            });

            // Calcular d√≠as desde √∫ltima vez que se entren√≥ cada grupo muscular
            const muscleLastTrained = {};

            allMuscles.forEach(muscle => {
                let daysSince = Infinity;

                for (let i = 0; i < history.length; i++) {
                    const session = history[i];

                    // Verificar si este grupo se entren√≥ en esta sesi√≥n (con volumen significativo)
                    if (session.volumenPorGrupo && session.volumenPorGrupo[muscle] > 0) {
                        const sessionDate = new Date(session.date);
                        const today = new Date();
                        daysSince = Math.floor((today - sessionDate) / (1000 * 60 * 60 * 24));
                        break;
                    }
                }

                muscleLastTrained[muscle] = daysSince;
            });

            // Filtrar: NO puede ser uno de los 2 √∫ltimos entrenados
            let availableMuscles = allMuscles.filter(m => !last2MainMuscles.includes(m));

            // Si todos fueron entrenados recientemente, permitir todos menos el √∫ltimo
            if (availableMuscles.length === 0) {
                availableMuscles = allMuscles.filter(m => m !== last2MainMuscles[0]);
            }

            // Ordenar por d√≠as sin entrenar (de mayor a menor)
            availableMuscles.sort((a, b) => muscleLastTrained[b] - muscleLastTrained[a]);

            const recommendedMuscle = availableMuscles[0];
            const daysSince = muscleLastTrained[recommendedMuscle];

            return {
                muscle: recommendedMuscle,
                daysSince: daysSince,
                isNew: daysSince === Infinity,
                suggestedRoutines: getSuggestedRoutines(recommendedMuscle)
            };
        }

        function getSuggestedRoutines(muscle) {
            // Mapeo de grupo muscular ‚Üí rutinas que lo contienen
            const muscleToRoutines = {
                'Piernas': ['GRUPO 1', 'GRUPO 3'],
                'Gl√∫teos': ['GRUPO 1'],
                'Pecho': ['GRUPO 2'],
                'Hombros': ['GRUPO 2', 'GRUPO 5'],
                'Tr√≠ceps': ['GRUPO 2', 'GRUPO 5'],
                'Espalda': ['GRUPO 4'],
                'B√≠ceps': ['GRUPO 4'],
                'Core': ['Cualquier rutina']
            };

            return muscleToRoutines[muscle] || [];
        }

        function getRecentPR() {
            const prs = JSON.parse(localStorage.getItem('gymmate_prs') || '{}');

            // Filtrar PRs de √∫ltimos 3 d√≠as
            const recentPRs = Object.entries(prs)
                .filter(([name, data]) => {
                    const prDate = new Date(data.date);
                    const daysSince = (Date.now() - prDate) / (1000 * 60 * 60 * 24);
                    return daysSince <= 3;
                })
                .sort((a, b) => new Date(b[1].date) - new Date(a[1].date));

            return recentPRs.length > 0 ? recentPRs[0] : null;
        }

        function getStreak() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 30; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);

                const trained = history.some(session => {
                    const sessionDate = new Date(session.date);
                    sessionDate.setHours(0, 0, 0, 0);
                    return sessionDate.getTime() === checkDate.getTime();
                });

                if (trained || i === 0) { // Permitir d√≠a actual sin entrenar
                    if (trained) streak++;
                } else {
                    break;
                }
            }

            return streak >= 7 ? streak : 0;
        }

        function getMotivationForInactive() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            if (history.length === 0) return null;

            const lastSession = history[0];
            const lastDate = new Date(lastSession.date);
            const today = new Date();
            const daysSince = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));

            if (daysSince >= 7) {
                // Sugerir grupo muscular menos entrenado
                const recommendation = getMuscleGroupRecommendation();

                return {
                    daysSince,
                    recommendation,
                    isInactive: true
                };
            }

            return null;
        }

        function getWelcomeMessage() {
            // Combinaci√≥n h√≠brida: Estad√≠stica motivadora + rotativo por d√≠a de semana
            const dayOfWeek = new Date().getDay(); // 0 = Domingo, 1 = Lunes, etc.

            const suggestions = [
                { muscle: 'PIERNAS + GL√öTEOS', routine: 'GRUPO 1', day: 'DOMINGO' },
                { muscle: 'PECHO + HOMBROS', routine: 'GRUPO 2', day: 'LUNES' },
                { muscle: 'ESPALDA + B√çCEPS', routine: 'GRUPO 4', day: 'MARTES' },
                { muscle: 'PIERNAS QUAD', routine: 'GRUPO 3', day: 'MI√âRCOLES' },
                { muscle: 'HOMBRO + TR√çCEPS', routine: 'GRUPO 5', day: 'JUEVES' },
                { muscle: 'PIERNAS + GL√öTEOS', routine: 'GRUPO 1', day: 'VIERNES' },
                { muscle: 'PECHO + HOMBROS', routine: 'GRUPO 2', day: 'S√ÅBADO' }
            ];

            return {
                isNewUser: true,
                suggestion: suggestions[dayOfWeek]
            };
        }

        function updateHeroSection() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            // Elementos del DOM
            const heroIcon = document.getElementById('heroIcon');
            const heroBadge = document.getElementById('heroBadge');
            const heroTitle = document.getElementById('heroTitle');
            const heroSubtitle = document.getElementById('heroSubtitle');
            const heroRoutine = document.getElementById('heroRoutine');

            if (!heroIcon || !heroBadge || !heroTitle || !heroSubtitle || !heroRoutine) return;

            // 1. Verificar PR reciente (√∫ltimos 3 d√≠as)
            const recentPR = getRecentPR();
            if (recentPR) {
                const [exerciseName, prData] = recentPR;
                heroIcon.textContent = 'üèÜ';
                heroBadge.textContent = 'NUEVO RECORD';
                heroBadge.className = 'text-yellow-400 text-sm font-semibold uppercase tracking-wide';
                heroTitle.textContent = `${exerciseName} ‚Üí ${prData.peso}kg`;
                heroSubtitle.textContent = `¬°Superaste tu marca anterior!`;
                heroRoutine.classList.add('hidden');
                return;
            }

            // 2. Verificar racha >= 7 d√≠as
            const streak = getStreak();
            if (streak >= 7) {
                heroIcon.textContent = 'üî•';
                heroBadge.textContent = 'RACHA ACTIVA';
                heroBadge.className = 'text-orange-400 text-sm font-semibold uppercase tracking-wide';
                heroTitle.textContent = `${streak} d√≠as consecutivos`;
                heroSubtitle.textContent = '¬°No la rompas hoy!';
                heroRoutine.classList.add('hidden');
                return;
            }

            // 3. Verificar si lleva >= 7 d√≠as sin entrenar
            const inactive = getMotivationForInactive();
            if (inactive) {
                heroIcon.textContent = '‚ö†Ô∏è';
                heroBadge.textContent = '¬°TE EXTRA√ëAMOS!';
                heroBadge.className = 'text-red-400 text-sm font-semibold uppercase tracking-wide';
                heroTitle.textContent = `Han pasado ${inactive.daysSince} d√≠as`;
                if (inactive.recommendation) {
                    heroSubtitle.textContent = `Retoma con: ${inactive.recommendation.muscle}`;
                    const routines = inactive.recommendation.suggestedRoutines.join(' o ');
                    heroRoutine.textContent = `üìã Rutina sugerida: ${routines}`;
                    heroRoutine.classList.remove('hidden');
                } else {
                    heroSubtitle.textContent = '¬°Es hora de volver!';
                    heroRoutine.classList.add('hidden');
                }
                return;
            }

            // 4. Verificar si es usuario nuevo
            if (history.length === 0) {
                const welcome = getWelcomeMessage();
                heroIcon.textContent = 'üéØ';
                heroBadge.textContent = `${welcome.suggestion.day} - COMIENZA HOY`;
                heroBadge.className = 'text-cyan-400 text-sm font-semibold uppercase tracking-wide';
                heroTitle.textContent = welcome.suggestion.muscle;
                heroSubtitle.textContent = 'Tu viaje fitness empieza aqu√≠';
                heroRoutine.textContent = `üìã Rutina sugerida: ${welcome.suggestion.routine}`;
                heroRoutine.classList.remove('hidden');
                return;
            }

            // 5. Default: Recomendar grupo muscular
            const recommendation = getMuscleGroupRecommendation();
            if (recommendation) {
                heroIcon.textContent = 'üí™';
                heroBadge.textContent = 'HOY TOCA';
                heroBadge.className = 'text-cyan-400 text-sm font-semibold uppercase tracking-wide';
                heroTitle.textContent = recommendation.muscle;

                if (recommendation.isNew) {
                    heroSubtitle.textContent = '¬°A√∫n no lo has entrenado!';
                } else {
                    heroSubtitle.textContent = `√öltima vez: hace ${recommendation.daysSince} ${recommendation.daysSince === 1 ? 'd√≠a' : 'd√≠as'}`;
                }

                const routines = recommendation.suggestedRoutines.join(' o ');
                heroRoutine.textContent = `üìã Rutina sugerida: ${routines}`;
                heroRoutine.classList.remove('hidden');
            }
        }

        function updateVolumeDisplay() {
            const volumenPorGrupo = calculateVolumenPorGrupo();
            const volumeBarsContainer = document.getElementById('volumeBars');

            // Only show if there are muscle groups with volume
            if (Object.keys(volumenPorGrupo).length === 0) {
                volumeBarsContainer.innerHTML = '<p class="text-gray-400 text-center py-4">Ingresa datos para ver el resumen de volumen</p>';
                return;
            }

            // Calcular volumen total para usar como 100%
            const totalVolume = Object.values(volumenPorGrupo).reduce((sum, vol) => sum + vol, 0);

            let html = '';
            for (const [grupo, volumen] of Object.entries(volumenPorGrupo)) {
                // Cada barra representa el % que ese grupo muscular aporta al volumen total
                const percentage = totalVolume > 0 ? (volumen / totalVolume) * 100 : 0;
                html += `
                    <div class="mb-4">
                        <div class="flex justify-between mb-2">
                            <span class="font-semibold text-white">${grupo}</span>
                            <span class="text-gray-300">${volumen.toFixed(0)} (${percentage.toFixed(0)}%)</span>
                        </div>
                        <div class="w-full bg-dark-surface border border-white/10 rounded-full h-6">
                            <div class="progress-bar-fill bg-gradient-to-r from-cyan-500 to-blue-500 h-6 rounded-full shadow-lg shadow-cyan-500/20" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }

            volumeBarsContainer.innerHTML = html;

            // Actualizar volumen total en sessionData y UI
            sessionData.volumenTotal = totalVolume;
            document.getElementById('totalVolume').textContent = totalVolume.toFixed(0);

            // Update quick stats
            updateQuickStats();
        }

        function updateQuickStats() {
            const completedCount = sessionData.ejercicios.filter(ej => ej.completado && ej.volumen > 0).length;
            const totalSets = sessionData.ejercicios.reduce((sum, ej) => sum + ej.sets, 0);
            const exercisesWithData = sessionData.ejercicios.filter(ej => ej.volumen > 0).length;

            document.getElementById('statVolume').textContent = sessionData.volumenTotal.toFixed(0);
            document.getElementById('statExercises').textContent = exercisesWithData;
            document.getElementById('statSets').textContent = totalSets;
            document.getElementById('statCompleted').textContent = completedCount;
        }

        function renderEjercicio(ejercicio, index, esOpcional = false) {
            const ejercicioData = sessionData.ejercicios[index] || {
                nombre: ejercicio.nombre,
                sets: 0,
                reps: 0,
                peso: 0,
                esMancuerna: ejercicio.esMancuerna,
                grupoMuscular: ejercicio.grupoMuscular,
                volumen: 0,
                completado: false
            };

            if (!sessionData.ejercicios[index]) {
                sessionData.ejercicios[index] = ejercicioData;
            }

            const volumen = ejercicioData.volumen || 0;
            const gifUrl = exerciseGifs[ejercicio.nombre] || '';

            return `
                <div class="exercise-card glass-card p-4 md:p-6 ${esOpcional ? 'border-l-4 border-yellow-500' : ''}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-start gap-3 flex-1">
                            <input type="checkbox"
                                   id="completado-${index}"
                                   class="w-6 h-6 text-cyan-400 rounded mt-1 bg-dark-surface border-white/10"
                                   ${ejercicioData.completado ? 'checked' : ''}
                                   onchange="toggleCompletado(${index})">
                            <div class="flex-1">
                                <h3 class="text-base md:text-xl font-bold text-white leading-tight">${ejercicio.nombre}</h3>
                                <p class="text-xs md:text-sm text-gray-400 mt-1">
                                    ${ejercicio.grupoMuscular}
                                    ${ejercicio.esMancuerna ? ' ‚Ä¢ <span class="text-cyan-400 font-semibold">üí™ √ó2</span>' : ''}
                                </p>
                            </div>
                        </div>
                        <button onclick="showAnimation('${ejercicio.nombre}', '${gifUrl}')"
                                class="bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 text-blue-300 px-3 py-2 rounded-lg text-xs md:text-sm font-semibold whitespace-nowrap ml-2 active:scale-95 transition-transform">
                            üé¨ Ver
                        </button>
                    </div>

                    <div class="grid grid-cols-3 gap-2 md:gap-4 mb-4">
                        <div>
                            <label class="block text-xs md:text-sm font-semibold text-gray-300 mb-2">Sets</label>
                            <input type="number"
                                   id="sets-${index}"
                                   value="${ejercicioData.sets}"
                                   min="0"
                                   class="w-full px-2 md:px-3 py-2 bg-dark-surface border border-white/10 rounded-lg text-center text-white focus:border-cyan-500"
                                   oninput="updateEjercicio(${index})">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-semibold text-gray-300 mb-2">Reps</label>
                            <input type="number"
                                   id="reps-${index}"
                                   value="${ejercicioData.reps}"
                                   min="0"
                                   class="w-full px-2 md:px-3 py-2 bg-dark-surface border border-white/10 rounded-lg text-center text-white focus:border-cyan-500"
                                   oninput="updateEjercicio(${index})">
                        </div>
                        <div>
                            <label class="block text-xs md:text-sm font-semibold text-gray-300 mb-2">Peso (kg)</label>
                            <input type="text"
                                   id="peso-${index}"
                                   value="${ejercicioData.peso}"
                                   class="w-full px-2 md:px-3 py-2 bg-dark-surface border border-white/10 rounded-lg text-center text-white focus:border-cyan-500"
                                   oninput="updateEjercicio(${index})"
                                   onblur="validateDecimalInput(this)">
                        </div>
                    </div>

                    <div class="flex justify-between items-center flex-wrap gap-2">
                        <div class="flex gap-2">
                            <button onclick="addSet(${index})"
                                    class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-lg shadow-green-500/20 active:scale-95 transition-transform">
                                + Set
                            </button>
                            <button onclick="startRestTimer()"
                                    class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white px-4 py-2 rounded-lg font-semibold text-sm shadow-lg shadow-purple-500/20 active:scale-95 transition-transform">
                                ‚è±Ô∏è
                            </button>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-400">Volumen</p>
                            <p class="text-xl md:text-2xl font-bold text-cyan-400 font-display" id="volumen-${index}">${volumen.toFixed(0)}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadTrainingGroup(grupoId) {
            const grupo = trainingGroups[grupoId];

            confirmWorkoutChange(() => {
                currentGroup = grupoId;
                sessionData.grupo = grupo.nombre;
                sessionData.ejercicios = [];
                hasUnsavedChanges = false;
                updateUnsavedIndicator();

                // Resetear flags de sesi√≥n (nueva sesi√≥n)
                sessionSaved = false;
                lastSavedData = null;
                sessionId = null;

                document.getElementById('trainingInfo').classList.remove('hidden');
                document.getElementById('currentTraining').textContent = grupo.nombre;
                document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES');

                let html = '';
                grupo.ejercicios.forEach((ej, index) => {
                    html += renderEjercicio(ej, index, false);
                });
                document.getElementById('ejerciciosList').innerHTML = html;

                let opcionalesHtml = '';
                const opcionalesStartIndex = grupo.ejercicios.length;
                grupo.opcionales.forEach((ej, index) => {
                    opcionalesHtml += renderEjercicio(ej, opcionalesStartIndex + index, true);
                });
                document.getElementById('opcionalesList').innerHTML = opcionalesHtml;

                document.getElementById('ejerciciosContainer').classList.remove('hidden');
                document.getElementById('volumeSummary').classList.remove('hidden');
                document.getElementById('saveSection').classList.remove('hidden');
                document.getElementById('quickStats').classList.remove('hidden');

                updateVolumeDisplay();

                // Actualizar estado del bot√≥n de guardar (nuevo workout, nada guardado a√∫n)
                updateSaveButtonState();
            }, grupo.nombre);
        }

        function updateEjercicio(index) {
            const sets = parseFloat(document.getElementById(`sets-${index}`).value) || 0;
            const reps = parseFloat(document.getElementById(`reps-${index}`).value) || 0;
            const pesoInput = document.getElementById(`peso-${index}`);

            if (!validateDecimalInput(pesoInput)) {
                return;
            }

            const peso = parseFloat(pesoInput.value) || 0;
            const esMancuerna = sessionData.ejercicios[index].esMancuerna;

            const volumen = calculateVolume(sets, reps, peso, esMancuerna);

            sessionData.ejercicios[index].sets = sets;
            sessionData.ejercicios[index].reps = reps;
            sessionData.ejercicios[index].peso = peso;
            sessionData.ejercicios[index].volumen = volumen;

            document.getElementById(`volumen-${index}`).textContent = volumen.toFixed(0);

            // Check for PR
            checkForPR(sessionData.ejercicios[index]);

            updateVolumeDisplay();

            // Programar auto-guardado despu√©s de 15 segundos
            scheduleDraftSave();

            // Actualizar estado del bot√≥n de guardar
            updateSaveButtonState();
        }

        function addSet(index) {
            const setsInput = document.getElementById(`sets-${index}`);
            setsInput.value = (parseFloat(setsInput.value) || 0) + 1;
            updateEjercicio(index);
        }

        function toggleCompletado(index) {
            const checked = document.getElementById(`completado-${index}`).checked;
            sessionData.ejercicios[index].completado = checked;
            updateQuickStats();

            // Guardar draft inmediatamente al marcar checkbox
            saveDraft();
            hasUnsavedChanges = false;
            updateUnsavedIndicator();

            // Actualizar estado del bot√≥n de guardar
            updateSaveButtonState();
        }

        function showAnimation(nombre, gifUrl) {
            document.getElementById('modalTitle').textContent = nombre;
            const container = document.getElementById('animationContainer');

            if (gifUrl) {
                // Show loading indicator first
                container.innerHTML = '<div class="flex flex-col items-center gap-3"><div class="animate-pulse text-4xl">‚è≥</div><p class="text-gray-400">Cargando imagen...</p></div>';

                // Create image element with better error handling
                const img = new Image();
                // Don't use crossOrigin - causes CORS issues with some CDNs
                img.className = 'w-full max-w-md rounded-lg shadow-lg';
                img.alt = nombre;

                img.onload = function() {
                    container.innerHTML = '';
                    container.appendChild(img);
                };

                img.onerror = function() {
                    container.innerHTML = `
                        <div class="flex flex-col items-center gap-3 text-center p-4">
                            <div class="text-4xl">‚ùå</div>
                            <p class="text-gray-300 font-semibold">Error al cargar la imagen</p>
                            <p class="text-gray-400 text-sm">La imagen de referencia no est√° disponible en este momento.</p>
                            <p class="text-gray-500 text-xs mt-2">Fuente: Wger Workout Manager</p>
                        </div>
                    `;
                };

                img.src = gifUrl;
            } else {
                container.innerHTML = `
                    <div class="flex flex-col items-center gap-3 text-center p-4">
                        <div class="text-4xl">üìã</div>
                        <p class="text-gray-400">Referencia visual no disponible para este ejercicio.</p>
                    </div>
                `;
            }

            document.getElementById('animationModal').classList.add('active');
        }

        function closeAnimationModal() {
            document.getElementById('animationModal').classList.remove('active');
            document.getElementById('animationContainer').innerHTML = '<p class="text-gray-400">Cargando imagen de referencia...</p>';
        }

        // ==========================================
        // REST TIMER FUNCTIONS
        // ==========================================

        function startRestTimer() {
            document.getElementById('restTimerModal').classList.add('active');
        }

        function initializeTimer(seconds) {
            restTimeRemaining = seconds;
            isPaused = false;

            document.getElementById('restTimerModal').classList.remove('active');
            document.getElementById('restTimerBanner').classList.add('active');

            updateTimerDisplay();

            if (restTimer) clearInterval(restTimer);

            restTimer = setInterval(() => {
                if (!isPaused) {
                    restTimeRemaining--;
                    updateTimerDisplay();

                    if (restTimeRemaining <= 0) {
                        clearInterval(restTimer);
                        playNotificationSound();

                        // Vibraci√≥n del celular
                        if (navigator.vibrate) {
                            navigator.vibrate([200, 100, 200, 100, 200]);
                        }

                        showNotification('¬°Tiempo de descanso terminado! üí™');

                        // Cerrar modal autom√°ticamente despu√©s de 2 segundos
                        setTimeout(() => {
                            document.getElementById('restTimerBanner').classList.remove('active');
                        }, 2000);
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(restTimeRemaining / 60);
            const seconds = restTimeRemaining % 60;
            document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function pauseTimer() {
            isPaused = !isPaused;
            document.getElementById('pauseTimer').textContent = isPaused ? '‚ñ∂Ô∏è Reanudar' : '‚è∏ Pausar';
        }

        function stopTimer() {
            if (restTimer) clearInterval(restTimer);
            document.getElementById('restTimerBanner').classList.remove('active');
            restTimeRemaining = 0;
        }

        function playNotificationSound() {
            // Simple beep using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio notification not available');
            }
        }

        function showNotification(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('GymMate', {
                    body: message,
                    icon: '/icon-192.png'
                });
            } else {
                alert(message);
            }
        }

        // ==========================================
        // PR TRACKING
        // ==========================================

        function checkForPR(ejercicioData) {
            if (ejercicioData.volumen === 0) return;

            const prs = JSON.parse(localStorage.getItem('gymmate_prs') || '{}');
            const ejercicioNombre = ejercicioData.nombre;

            if (!prs[ejercicioNombre] || ejercicioData.peso > prs[ejercicioNombre].peso) {
                prs[ejercicioNombre] = {
                    peso: ejercicioData.peso,
                    sets: ejercicioData.sets,
                    reps: ejercicioData.reps,
                    volumen: ejercicioData.volumen,
                    date: new Date().toISOString()
                };
                localStorage.setItem('gymmate_prs', JSON.stringify(prs));

                // Silent PR tracking - no notification to avoid interrupting input
                // PR will update dynamically in the PRs tab
            }
        }

        function loadPRs() {
            const prs = JSON.parse(localStorage.getItem('gymmate_prs') || '{}');
            const prsList = document.getElementById('prsList');

            if (Object.keys(prs).length === 0) {
                prsList.innerHTML = '<p class="text-gray-400 text-center py-8">Registra tus primeros entrenamientos para ver tus PRs</p>';
                return;
            }

            let html = '';
            for (const [nombre, data] of Object.entries(prs)) {
                html += `
                    <div class="glass-card p-4 border-l-4 border-yellow-500 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-r from-yellow-500/10 to-orange-500/10"></div>
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <h3 class="font-bold text-white">${nombre}</h3>
                                <p class="text-sm text-gray-300 mt-1">
                                    <strong class="text-2xl text-yellow-400">${data.peso}kg</strong> ‚Ä¢ ${data.sets}√ó${data.reps}
                                </p>
                                <p class="text-xs text-gray-400 mt-2">
                                    ${new Date(data.date).toLocaleDateString('es-ES')}
                                </p>
                            </div>
                            <span class="text-4xl">üèÜ</span>
                        </div>
                    </div>
                `;
            }
            prsList.innerHTML = html;
        }

        // ==========================================
        // PROFILE MANAGEMENT
        // ==========================================

        function saveProfile(e) {
            e.preventDefault();

            const profile = {
                name: document.getElementById('profileName').value,
                birthdate: document.getElementById('profileBirthdate').value,
                gender: document.getElementById('profileGender').value,
                weight: parseFloat(document.getElementById('profileWeight').value) || 0,
                height: parseFloat(document.getElementById('profileHeight').value) || 0,
                activity: parseFloat(document.getElementById('profileActivity').value)
            };

            localStorage.setItem('gymmate_profile', JSON.stringify(profile));

            // Show success message
            const message = document.getElementById('profileSaveMessage');
            message.classList.remove('hidden');
            setTimeout(() => {
                message.classList.add('hidden');
            }, 3000);

            return false;
        }

        function loadProfile() {
            const profile = JSON.parse(localStorage.getItem('gymmate_profile') || '{}');

            if (profile.name) {
                document.getElementById('profileName').value = profile.name;
            }
            if (profile.birthdate) {
                document.getElementById('profileBirthdate').value = profile.birthdate;
                calculateAge();
            }
            if (profile.gender) {
                document.getElementById('profileGender').value = profile.gender;
            }
            if (profile.weight) {
                document.getElementById('profileWeight').value = profile.weight;
            }
            if (profile.height) {
                document.getElementById('profileHeight').value = profile.height;
            }
            if (profile.activity) {
                document.getElementById('profileActivity').value = profile.activity;
            }
        }

        function calculateAge() {
            const birthdate = document.getElementById('profileBirthdate').value;
            if (!birthdate) {
                document.getElementById('calculatedAge').textContent = '-';
                return;
            }

            const birth = new Date(birthdate);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();

            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }

            document.getElementById('calculatedAge').textContent = age;
        }

        function prefillCaloriesFromProfile() {
            const profile = JSON.parse(localStorage.getItem('gymmate_profile') || '{}');

            if (profile.birthdate) {
                const birth = new Date(profile.birthdate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                document.getElementById('caloriesAge').value = age;
            }
            if (profile.gender) {
                document.getElementById('caloriesGender').value = profile.gender;
            }
            if (profile.weight) {
                document.getElementById('caloriesWeight').value = profile.weight;
            }
            if (profile.height) {
                document.getElementById('caloriesHeight').value = profile.height;
            }
            if (profile.activity) {
                document.getElementById('caloriesActivity').value = profile.activity;
            }
        }

        // ==========================================
        // WORKOUT BUILDER - CUSTOM ROUTINES
        // ==========================================

        // Comprehensive exercise database
        const exerciseDatabase = {
            pecho: [
                { name: "Press de banca", desc: "Ejercicio b√°sico para pecho", variants: ["Barra", "Mancuernas", "M√°quina Smith"] },
                { name: "Press inclinado", desc: "Trabaja pecho superior", variants: ["Barra", "Mancuernas"] },
                { name: "Press declinado", desc: "Enfoca pecho inferior", variants: ["Barra", "Mancuernas"] },
                { name: "Aperturas", desc: "Aislamiento de pecho", variants: ["Mancuernas", "Poleas", "M√°quina"] },
                { name: "Fondos en paralelas", desc: "Compuesto para pecho y tr√≠ceps", variants: ["Peso corporal", "Con lastre"] },
                { name: "Pullover", desc: "Expansi√≥n de caja tor√°cica", variants: ["Mancuerna", "Polea", "M√°quina"] },
                { name: "Crossover de poleas", desc: "Aislamiento con poleas", variants: ["Alto", "Medio", "Bajo"] },
                { name: "Press con agarre cerrado", desc: "Pecho interno y tr√≠ceps", variants: ["Barra", "Mancuernas"] }
            ],
            espalda: [
                { name: "Jal√≥n al pecho", desc: "Dorsales y ancho de espalda", variants: ["Agarre ancho", "Agarre cerrado", "Neutro"] },
                { name: "Jal√≥n tras nuca", desc: "Dorsales superiores", variants: ["M√°quina"] },
                { name: "Remo con barra", desc: "Grosor de espalda", variants: ["Pronado", "Supino", "Pendlay"] },
                { name: "Remo sentado", desc: "Espalda media", variants: ["Polea", "M√°quina", "Mancuerna"] },
                { name: "Dominadas", desc: "Dorsales completos", variants: ["Peso corporal", "Asistidas", "Con lastre"] },
                { name: "Remo con mancuerna", desc: "Unilateral para espalda", variants: ["A una mano", "Seal row"] },
                { name: "Face pull", desc: "Trapecios y deltoides posterior", variants: ["Polea", "Banda"] },
                { name: "Peso muerto", desc: "Espalda baja y general", variants: ["Convencional", "Sumo", "Rumano"] },
                { name: "Pulldown de brazo recto", desc: "Dorsales con brazos extendidos", variants: ["Barra", "Cuerda"] },
                { name: "Remo en T", desc: "Espalda media y trapecios", variants: ["Barra", "M√°quina"] }
            ],
            hombros: [
                { name: "Press militar", desc: "Hombros completos", variants: ["Barra", "Mancuernas", "M√°quina"] },
                { name: "Elevaci√≥n lateral", desc: "Deltoides medial", variants: ["Mancuernas", "Poleas", "M√°quina"] },
                { name: "Elevaci√≥n frontal", desc: "Deltoides anterior", variants: ["Mancuernas", "Barra", "Disco"] },
                { name: "P√°jaros", desc: "Deltoides posterior", variants: ["Mancuernas", "M√°quina", "Polea"] },
                { name: "Press Arnold", desc: "Rotaci√≥n completa de hombro", variants: ["Mancuernas"] },
                { name: "Remo al ment√≥n", desc: "Trapecios y deltoides", variants: ["Barra", "Mancuernas", "Polea"] },
                { name: "Face pull", desc: "Deltoides posterior y rotadores", variants: ["Polea", "Banda"] },
                { name: "Press Bradford", desc: "Anterior y posterior", variants: ["Barra"] }
            ],
            biceps: [
                { name: "Curl con barra", desc: "B√≠ceps completo", variants: ["Barra recta", "Barra Z", "Polea"] },
                { name: "Curl con mancuernas", desc: "Trabajo bilateral", variants: ["Alternado", "Simult√°neo", "Martillo"] },
                { name: "Curl predicador", desc: "Aislamiento de b√≠ceps", variants: ["Barra", "Mancuernas", "M√°quina"] },
                { name: "Curl concentrado", desc: "Pico del b√≠ceps", variants: ["Mancuerna"] },
                { name: "Curl en banco inclinado", desc: "Estiramiento completo", variants: ["Mancuernas"] },
                { name: "Curl ara√±a", desc: "B√≠ceps corto", variants: ["Barra", "Mancuernas"] },
                { name: "Curl 21s", desc: "T√©cnica de intensidad", variants: ["Barra"] }
            ],
            triceps: [
                { name: "Press franc√©s", desc: "Cabeza larga del tr√≠ceps", variants: ["Barra", "Mancuernas", "Barra Z"] },
                { name: "Extensi√≥n con cuerda", desc: "Tr√≠ceps con polea", variants: ["Cuerda", "Barra"] },
                { name: "Fondos en banco", desc: "Tr√≠ceps con peso corporal", variants: ["Peso corporal", "Con disco"] },
                { name: "Patada de tr√≠ceps", desc: "Aislamiento unilateral", variants: ["Mancuerna", "Polea"] },
                { name: "Press cerrado", desc: "Tr√≠ceps y pecho", variants: ["Barra", "Mancuernas"] },
                { name: "Jal√≥n con agarre invertido", desc: "Cabeza lateral", variants: ["Barra", "Polea"] },
                { name: "Extensi√≥n sobre cabeza", desc: "Cabeza larga", variants: ["Mancuerna", "Polea", "Barra"] }
            ],
            piernas: [
                { name: "Sentadilla", desc: "Ejercicio rey de piernas", variants: ["Barra libre", "Smith", "Hack", "B√∫lgara"] },
                { name: "Prensa", desc: "Cu√°driceps y gl√∫teos", variants: ["45¬∞", "Horizontal", "Vertical"] },
                { name: "Extensi√≥n de cu√°driceps", desc: "Aislamiento de cu√°driceps", variants: ["M√°quina"] },
                { name: "Curl femoral", desc: "Isquiotibiales", variants: ["Acostado", "Sentado", "De pie"] },
                { name: "Zancada", desc: "Unilateral para piernas", variants: ["Con barra", "Con mancuernas", "Caminando"] },
                { name: "Peso muerto rumano", desc: "Femorales y gl√∫teos", variants: ["Barra", "Mancuernas"] },
                { name: "Sentadilla hack", desc: "Cu√°driceps con m√°quina", variants: ["M√°quina hack"] },
                { name: "Peso muerto a una pierna", desc: "Equilibrio y femorales", variants: ["Mancuerna", "Barra"] },
                { name: "Step ups", desc: "Escal√≥n con peso", variants: ["Con mancuernas", "Con barra"] },
                { name: "Sissy squat", desc: "Cu√°driceps intenso", variants: ["Peso corporal", "Con disco"] }
            ],
            gluteos: [
                { name: "Hip thrust", desc: "Ejercicio principal para gl√∫teos", variants: ["Barra", "Mancuerna", "M√°quina"] },
                { name: "Peso muerto rumano", desc: "Gl√∫teos y femorales", variants: ["Barra", "Mancuernas"] },
                { name: "Patada de gl√∫teo", desc: "Aislamiento", variants: ["Polea", "M√°quina", "Peso corporal"] },
                { name: "Abducci√≥n de cadera", desc: "Gl√∫teo medio", variants: ["M√°quina", "Polea", "Banda"] },
                { name: "Aducci√≥n de cadera", desc: "Aductores", variants: ["M√°quina", "Polea"] },
                { name: "Puente de gl√∫teos", desc: "Activaci√≥n de gl√∫teos", variants: ["Peso corporal", "Con barra"] },
                { name: "Buenos d√≠as", desc: "Cadena posterior", variants: ["Barra"] }
            ],
            core: [
                { name: "Plancha", desc: "Estabilizaci√≥n core", variants: ["Frontal", "Lateral", "Con elevaci√≥n"] },
                { name: "Crunch", desc: "Abdomen superior", variants: ["En suelo", "En banco", "Con polea"] },
                { name: "Elevaci√≥n de piernas", desc: "Abdomen inferior", variants: ["Colgado", "En suelo", "En banco"] },
                { name: "Russian twist", desc: "Oblicuos", variants: ["Con disco", "Con bal√≥n medicinal"] },
                { name: "Mountain climbers", desc: "Cardio y core", variants: ["Cl√°sico", "Cruzado"] },
                { name: "Ab wheel", desc: "Core completo", variants: ["Rueda abdominal"] },
                { name: "Dead bug", desc: "Control de core", variants: ["Peso corporal"] },
                { name: "Pallof press", desc: "Anti-rotaci√≥n", variants: ["Polea", "Banda"] }
            ]
        };

        // Workout builder state
        let selectedExercises = [];
        let currentBuilderStep = 1;

        function openWorkoutBuilder() {
            // Reset state
            selectedExercises = [];
            currentBuilderStep = 1;

            // Reset UI
            updateSelectedCount();
            renderExercisesList('all');
            goToStep1();

            // Show builder
            switchTab('workoutBuilder');
        }

        function closeWorkoutBuilder() {
            showHome();
        }

        function renderExercisesList(filter = 'all') {
            const container = document.getElementById('exercisesList');
            let html = '';

            const groups = filter === 'all' ? Object.keys(exerciseDatabase) : [filter];

            groups.forEach(group => {
                const exercises = exerciseDatabase[group];
                const groupName = {
                    pecho: 'ü´Ä Pecho',
                    espalda: 'üîô Espalda',
                    hombros: 'üí™ Hombros',
                    biceps: 'üí™ B√≠ceps',
                    triceps: 'üí™ Tr√≠ceps',
                    piernas: 'ü¶µ Piernas',
                    gluteos: 'üçë Gl√∫teos',
                    core: 'üéØ Core/Abdomen'
                }[group];

                html += `<div class="glass-card p-3 mb-2">
                    <p class="text-xs font-bold text-cyan-400 uppercase mb-2">${groupName}</p>`;

                exercises.forEach((exercise, idx) => {
                    const exerciseId = `${group}_${idx}`;
                    const isSelected = selectedExercises.some(e => e.id === exerciseId);

                    html += `
                        <div class="flex items-start gap-3 p-2 rounded-lg hover:bg-white/5 transition-colors mb-1">
                            <input type="checkbox"
                                   id="ex_${exerciseId}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleExerciseSelection('${exerciseId}', '${group}', ${idx})"
                                   class="w-5 h-5 text-cyan-400 rounded mt-0.5 bg-dark-surface border-white/10">
                            <div class="flex-1">
                                <label for="ex_${exerciseId}" class="text-sm font-semibold text-white cursor-pointer">${exercise.name}</label>
                                <p class="text-xs text-gray-400">${exercise.desc}</p>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${exercise.variants.map(v => `<span class="text-xs px-2 py-0.5 rounded-full bg-blue-500/20 text-blue-300">${v}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            });

            container.innerHTML = html;
        }

        function toggleExerciseSelection(exerciseId, group, idx) {
            const exercise = exerciseDatabase[group][idx];
            const existingIndex = selectedExercises.findIndex(e => e.id === exerciseId);

            if (existingIndex > -1) {
                selectedExercises.splice(existingIndex, 1);
            } else {
                selectedExercises.push({
                    id: exerciseId,
                    name: exercise.name,
                    group: group,
                    grupoMuscular: {
                        pecho: 'Pecho',
                        espalda: 'Espalda',
                        hombros: 'Hombros',
                        biceps: 'B√≠ceps',
                        triceps: 'Tr√≠ceps',
                        piernas: 'Piernas',
                        gluteos: 'Gl√∫teos',
                        core: 'Core'
                    }[group]
                });
            }

            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedExercises.length;
        }

        // Step navigation
        function goToStep1() {
            currentBuilderStep = 1;
            document.getElementById('builderStep1').classList.remove('hidden');
            document.getElementById('builderStep2').classList.add('hidden');
            document.getElementById('builderStep3').classList.add('hidden');

            // Update indicators
            updateStepIndicators();
        }

        function goToStep2() {
            if (selectedExercises.length === 0) {
                alert('Selecciona al menos un ejercicio');
                return;
            }

            currentBuilderStep = 2;
            document.getElementById('builderStep1').classList.add('hidden');
            document.getElementById('builderStep2').classList.remove('hidden');
            document.getElementById('builderStep3').classList.add('hidden');

            // Render selected exercises
            renderSelectedExercises();
            updateStepIndicators();
        }

        function goToStep3() {
            currentBuilderStep = 3;
            document.getElementById('builderStep1').classList.add('hidden');
            document.getElementById('builderStep2').classList.add('hidden');
            document.getElementById('builderStep3').classList.remove('hidden');

            // Generate suggested names
            generateSuggestedNames();
            updateStepIndicators();
        }

        function updateStepIndicators() {
            [1, 2, 3].forEach(step => {
                const indicator = document.getElementById(`step${step}Indicator`);
                const text = document.getElementById(`step${step}Text`);

                if (step < currentBuilderStep) {
                    // Completed
                    indicator.className = 'w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white font-bold';
                    indicator.textContent = '‚úì';
                    text.className = 'text-green-400 font-semibold';
                } else if (step === currentBuilderStep) {
                    // Active
                    indicator.className = 'w-6 h-6 rounded-full bg-cyan-500 flex items-center justify-center text-white font-bold';
                    indicator.textContent = step;
                    text.className = 'text-cyan-400 font-semibold';
                } else {
                    // Pending
                    indicator.className = 'w-6 h-6 rounded-full bg-dark-surface border border-white/20 flex items-center justify-center text-gray-500 font-bold';
                    indicator.textContent = step;
                    text.className = 'text-gray-500';
                }
            });
        }

        function renderSelectedExercises() {
            const container = document.getElementById('selectedExercisesList');
            let html = '';

            if (selectedExercises.length === 0) {
                html = '<p class="text-gray-400 text-center py-4">No hay ejercicios seleccionados</p>';
            } else {
                selectedExercises.forEach((ex, idx) => {
                    html += `
                        <div class="flex items-center justify-between p-3 bg-dark-surface rounded-lg border border-white/10">
                            <div class="flex items-center gap-3">
                                <span class="text-cyan-400 font-bold">${idx + 1}</span>
                                <div>
                                    <p class="text-white font-semibold text-sm">${ex.name}</p>
                                    <p class="text-xs text-gray-400">${ex.grupoMuscular}</p>
                                </div>
                            </div>
                            <button onclick="removeExercise(${idx})" class="text-red-400 hover:text-red-300 active:scale-95 transition-transform">
                                <i class="ph-bold ph-trash text-lg"></i>
                            </button>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function removeExercise(idx) {
            selectedExercises.splice(idx, 1);
            renderSelectedExercises();
            updateSelectedCount();

            // Re-render exercise list to update checkboxes
            const filter = document.getElementById('muscleGroupFilter').value;
            renderExercisesList(filter);
        }

        function generateSuggestedNames() {
            const container = document.getElementById('suggestedNames');
            const groups = {};

            // Count exercises per group
            selectedExercises.forEach(ex => {
                groups[ex.grupoMuscular] = (groups[ex.grupoMuscular] || 0) + 1;
            });

            const sortedGroups = Object.entries(groups).sort((a, b) => b[1] - a[1]);
            const suggestions = [];

            // Generate suggestions
            if (sortedGroups.length === 1) {
                suggestions.push(`${sortedGroups[0][0]}`);
                suggestions.push(`D√≠a de ${sortedGroups[0][0]}`);
            } else if (sortedGroups.length === 2) {
                suggestions.push(`${sortedGroups[0][0]} + ${sortedGroups[1][0]}`);
                suggestions.push(`D√≠a ${sortedGroups[0][0]}/${sortedGroups[1][0]}`);
            } else if (sortedGroups.length >= 3) {
                suggestions.push('Full Body');
                suggestions.push(`${sortedGroups[0][0]} + ${sortedGroups[1][0]} + ${sortedGroups[2][0]}`);
                suggestions.push('Rutina Completa');
            }

            // Add day-based suggestions
            const days = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes'];
            const randomDay = days[Math.floor(Math.random() * days.length)];
            suggestions.push(`Rutina ${randomDay}`);

            let html = suggestions.map(name => `
                <button onclick="selectSuggestedName('${name}')"
                        class="w-full text-left p-3 bg-dark-surface hover:bg-dark-surface/80 border border-white/10 hover:border-cyan-500/30 rounded-lg text-white text-sm active:scale-95 transition-all">
                    ${name}
                </button>
            `).join('');

            container.innerHTML = html;
        }

        function selectSuggestedName(name) {
            document.getElementById('customWorkoutName').value = name;
        }

        function saveCustomWorkout() {
            const customName = document.getElementById('customWorkoutName').value.trim();

            if (!customName) {
                alert('Por favor ingresa un nombre para tu rutina');
                return;
            }

            if (selectedExercises.length === 0) {
                alert('No puedes guardar una rutina sin ejercicios');
                return;
            }

            // Get existing custom workouts
            const customWorkouts = JSON.parse(localStorage.getItem('gymmate_custom_workouts') || '[]');

            // Create new workout
            const newWorkout = {
                id: 'custom_' + Date.now(),
                nombre: customName,
                ejercicios: selectedExercises.map(ex => ({
                    nombre: ex.name,
                    grupoMuscular: ex.grupoMuscular,
                    esMancuerna: false
                })),
                opcionales: [],
                isCustom: true,
                createdAt: new Date().toISOString()
            };

            customWorkouts.push(newWorkout);
            localStorage.setItem('gymmate_custom_workouts', JSON.stringify(customWorkouts));

            // Show success and return to home
            alert(`‚úÖ Rutina "${customName}" guardada exitosamente!`);
            showHome();
            loadCustomWorkoutsInHome();
        }

        function loadCustomWorkoutsInHome() {
            const customWorkouts = JSON.parse(localStorage.getItem('gymmate_custom_workouts') || '[]');
            const container = document.querySelector('#homeView .space-y-3');

            if (!container) return;

            // Remove old custom workout cards
            container.querySelectorAll('[data-custom-workout]').forEach(el => el.remove());

            // Add custom workout cards
            customWorkouts.forEach(workout => {
                const card = document.createElement('div');
                card.setAttribute('data-custom-workout', workout.id);
                card.setAttribute('data-grupo', workout.id);
                card.className = 'glass-card p-4 active:scale-95 transition-transform cursor-pointer border-l-4 border-purple-500';

                card.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-xl">
                                ‚ú®
                            </div>
                            <div>
                                <h3 class="font-bold text-white">${workout.nombre}</h3>
                                <p class="text-xs text-purple-300">Rutina personalizada</p>
                            </div>
                        </div>
                        <button onclick="deleteCustomWorkout('${workout.id}', event)" class="text-red-400 hover:text-red-300 active:scale-95 transition-transform">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-2 text-xs text-gray-400 mt-2">
                        <span>üí™ ${workout.ejercicios.length} ejercicios</span>
                        <span>‚Ä¢</span>
                        <span>${new Date(workout.createdAt).toLocaleDateString('es-ES')}</span>
                    </div>
                `;

                // Add click event
                card.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        loadCustomWorkout(workout);
                    }
                });

                container.insertBefore(card, container.firstChild);
            });
        }

        function loadCustomWorkout(workout) {
            confirmWorkoutChange(() => {
                // Set session data
                sessionData.grupo = workout.nombre;
                sessionData.ejercicios = [];
                hasUnsavedChanges = false;
                updateUnsavedIndicator();

                // Resetear flags de sesi√≥n (nueva sesi√≥n)
                sessionSaved = false;
                lastSavedData = null;
                sessionId = null;

                // Show workout tab
                switchTab('workout');

                // Update training info
                document.getElementById('trainingInfo').classList.remove('hidden');
                document.getElementById('currentTraining').textContent = workout.nombre;
                document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES');

                // Render exercises
                let html = '';
                workout.ejercicios.forEach((ej, index) => {
                    html += renderEjercicio(ej, index, false);
                });
                document.getElementById('ejerciciosList').innerHTML = html;

                // Hide optionals section for custom workouts
                document.getElementById('opcionalesList').innerHTML = '';

                document.getElementById('ejerciciosContainer').classList.remove('hidden');
                document.getElementById('volumeSummary').classList.remove('hidden');
                document.getElementById('saveSection').classList.remove('hidden');
                document.getElementById('quickStats').classList.remove('hidden');

                updateVolumeDisplay();

                // Actualizar estado del bot√≥n de guardar (nuevo workout, nada guardado a√∫n)
                updateSaveButtonState();
            }, workout.nombre);
        }

        function deleteCustomWorkout(workoutId, event) {
            event.stopPropagation();

            if (!confirm('¬øEliminar esta rutina personalizada?')) {
                return;
            }

            const customWorkouts = JSON.parse(localStorage.getItem('gymmate_custom_workouts') || '[]');
            const filtered = customWorkouts.filter(w => w.id !== workoutId);
            localStorage.setItem('gymmate_custom_workouts', JSON.stringify(filtered));

            loadCustomWorkoutsInHome();
        }

        // Filter exercise list
        document.addEventListener('DOMContentLoaded', function() {
            const filterSelect = document.getElementById('muscleGroupFilter');
            if (filterSelect) {
                filterSelect.addEventListener('change', (e) => {
                    renderExercisesList(e.target.value);
                });
            }
        });

        // ==========================================
        // HISTORY MANAGEMENT
        // ==========================================

        function saveToLocalStorage() {
            // Generar sessionId √∫nico si no existe
            if (!sessionId) {
                sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            // Limpiar flags de auto-save (pero mantener draft hasta endSession)
            hasUnsavedChanges = false;
            if (draftSaveTimeout) {
                clearTimeout(draftSaveTimeout);
            }
            updateUnsavedIndicator();

            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            // Preparar copia de la sesi√≥n
            const sessionCopy = JSON.parse(JSON.stringify(sessionData));
            sessionCopy.savedAt = new Date().toISOString();
            sessionCopy.sessionId = sessionId; // Agregar ID √∫nico

            // Verificar si esta sesi√≥n ya fue guardada (buscar por sessionId)
            const existingIndex = history.findIndex(s => s.sessionId === sessionId);

            if (existingIndex !== -1) {
                // Sobrescribir la entrada existente (no duplicar)
                history[existingIndex] = sessionCopy;
                console.log('üîÑ Entrenamiento actualizado (no duplicado)');
            } else {
                // Primera vez guardando esta sesi√≥n
                history.unshift(sessionCopy); // Agregar al inicio
                console.log('üíæ Nuevo entrenamiento guardado');
            }

            // Keep only last 30 sessions
            if (history.length > 30) {
                history.length = 30;
            }

            localStorage.setItem('gymmate_history', JSON.stringify(history));
            localStorage.setItem('gymmate_session', JSON.stringify(sessionData));

            // Actualizar estado de sesi√≥n guardada
            sessionSaved = true;
            lastSavedData = JSON.parse(JSON.stringify(sessionData.ejercicios));

            const saveMessage = document.getElementById('saveMessage');
            saveMessage.textContent = existingIndex !== -1
                ? '‚úÖ Entrenamiento actualizado correctamente'
                : '‚úÖ Entrenamiento guardado correctamente';
            saveMessage.classList.remove('hidden');

            setTimeout(() => {
                saveMessage.classList.add('hidden');
            }, 3000);

            loadHistory();

            // Generate AI suggestions after saving
            setTimeout(() => {
                generateAISuggestions();
            }, 1000);

            // Actualizar Hero Section (puede haber nuevo PR)
            updateHeroSection();

            // Actualizar estado del bot√≥n de guardar
            updateSaveButtonState();
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-gray-400 text-center py-8">No hay entrenamientos guardados a√∫n</p>';
                return;
            }

            let html = '';
            history.forEach((session, index) => {
                const date = new Date(session.savedAt || session.date).toLocaleDateString('es-ES', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                // Diferenciar entre sesi√≥n de cardio y de pesas
                if (session.type === 'cardio') {
                    // Sesi√≥n de CARDIO
                    const modeEmoji = session.mode === 'tabata' ? '‚ö°' : session.mode === 'amrap' ? 'üî•' : '‚è±Ô∏è';
                    const modeName = session.mode === 'tabata' ? 'Tabata' : session.mode === 'amrap' ? 'AMRAP' : 'EMOM';

                    html += `
                        <div class="glass-card p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-white">${modeEmoji} ${modeName}</h3>
                                    <p class="text-sm text-gray-400">${date}</p>
                                </div>
                                <button onclick="deleteHistoryItem(${index})" class="text-red-400 hover:text-red-300 text-xl active:scale-95 transition-transform">üóëÔ∏è</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-3">
                                <div class="bg-dark-surface border border-white/10 rounded-lg p-2">
                                    <p class="text-xs text-gray-400">Tiempo Total</p>
                                    <p class="text-lg font-bold text-orange-400">${Math.floor(session.stats.totalTime / 60)}:${String(session.stats.totalTime % 60).padStart(2, '0')}</p>
                                </div>
                                <div class="bg-dark-surface border border-white/10 rounded-lg p-2">
                                    <p class="text-xs text-gray-400">Rondas</p>
                                    <p class="text-lg font-bold text-purple-400">${session.stats.roundsCompleted}</p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Sesi√≥n de PESAS
                    // Verificar que session.ejercicios existe antes de acceder
                    const completedCount = session.ejercicios ? session.ejercicios.filter(ej => ej.completado).length : 0;
                    const totalExercises = session.ejercicios ? session.ejercicios.filter(ej => ej.volumen > 0).length : 0;
                    const volumenTotal = session.volumenTotal || 0;

                    html += `
                        <div class="glass-card p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-bold text-white">üí™ ${session.grupo || 'Entrenamiento'}</h3>
                                    <p class="text-sm text-gray-400">${date}</p>
                                </div>
                                <button onclick="deleteHistoryItem(${index})" class="text-red-400 hover:text-red-300 text-xl active:scale-95 transition-transform">üóëÔ∏è</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-3">
                                <div class="bg-dark-surface border border-white/10 rounded-lg p-2">
                                    <p class="text-xs text-gray-400">Volumen Total</p>
                                    <p class="text-lg font-bold text-cyan-400">${volumenTotal.toFixed(0)} kg</p>
                                </div>
                                <div class="bg-dark-surface border border-white/10 rounded-lg p-2">
                                    <p class="text-xs text-gray-400">Completados</p>
                                    <p class="text-lg font-bold text-green-400">${completedCount}/${totalExercises}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            historyList.innerHTML = html;
        }

        function deleteHistoryItem(index) {
            if (confirm('¬øEliminar este entrenamiento del historial?')) {
                const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');
                history.splice(index, 1);
                localStorage.setItem('gymmate_history', JSON.stringify(history));
                loadHistory();
            }
        }

        // ==========================================
        // DARK MODE
        // ==========================================

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            document.getElementById('darkModeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('gymmate_darkmode', isDark);
        }

        function loadDarkMode() {
            const isDark = localStorage.getItem('gymmate_darkmode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
            }
        }

        // ==========================================
        // TAB NAVIGATION
        // ==========================================

        function showHome() {
            if (hasUnsavedData()) {
                if (!confirm('‚ö†Ô∏è Tienes cambios sin guardar. ¬øVolver al inicio de todas formas?')) {
                    return; // Cancelar navegaci√≥n
                }
            }

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('active');
            });

            // Hide all cardio views
            document.getElementById('cardioSelectorView').classList.add('hidden');
            document.getElementById('cardioConfigView').classList.add('hidden');
            document.getElementById('cardioTimerView').classList.add('hidden');
            document.getElementById('cardioSummaryView').classList.add('hidden');

            // Show home view
            const homeView = document.getElementById('homeView');
            if (homeView) {
                homeView.classList.remove('hidden');
            }

            // Update bottom nav
            document.querySelectorAll('[data-nav]').forEach(item => {
                item.classList.remove('active');
            });
            const homeNavItem = document.querySelector('[data-nav="home"]');
            if (homeNavItem) {
                homeNavItem.classList.add('active');
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Actualizar carta flotante de reanudar
            updateResumeWorkoutCard();

            // Actualizar Hero Section din√°mico
            updateHeroSection();
        }

        function switchTab(tabName) {
            // Hide home view
            const homeView = document.getElementById('homeView');
            if (homeView) {
                homeView.classList.add('hidden');
            }

            // Hide all cardio views
            document.getElementById('cardioSelectorView').classList.add('hidden');
            document.getElementById('cardioConfigView').classList.add('hidden');
            document.getElementById('cardioTimerView').classList.add('hidden');
            document.getElementById('cardioSummaryView').classList.add('hidden');

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
                tab.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
                selectedTab.classList.add('active');
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });

            const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-500', 'text-white');
                activeBtn.classList.remove('bg-gray-100', 'text-gray-700');
            }

            // Update bottom nav
            document.querySelectorAll('[data-nav]').forEach(item => {
                item.classList.remove('active');
            });

            const activeNavItem = document.querySelector(`[data-nav="${tabName}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // Load data for specific tabs
            if (tabName === 'history') {
                loadHistory();
            } else if (tabName === 'prs') {
                loadPRs();
            } else if (tabName === 'charts') {
                initializeCharts();
            } else if (tabName === 'calculators') {
                populateCalculatorDropdowns();
            }
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================

        document.getElementById('grupoSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                loadTrainingGroup(e.target.value);
            }
        });

        // Tarjetas de rutinas clicables (reemplaza el select)
        document.querySelectorAll('[data-grupo]').forEach(card => {
            card.addEventListener('click', function() {
                const grupo = this.getAttribute('data-grupo');
                if (grupo) {
                    loadTrainingGroup(grupo);
                    // Cambiar a la vista de workout
                    switchTab('workout');
                }
            });
        });

        // Navigation items
        document.querySelectorAll('[data-nav]').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('[data-nav]').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                // Handle navigation
                const navType = this.getAttribute('data-nav');
                if (navType === 'home') {
                    showHome();
                } else if (navType === 'charts') {
                    switchTab('charts');
                } else if (navType === 'history') {
                    switchTab('history');
                } else if (navType === 'prs') {
                    switchTab('prs');
                } else if (navType === 'profile') {
                    switchTab('profile');
                }
            });
        });

        // FAB button (central floating action button) - Opens workout builder
        if (document.getElementById('fabButton')) {
            document.getElementById('fabButton').addEventListener('click', function() {
                openWorkoutBuilder();
            });
        }

        // Start workout button - Scroll to rutinas section
        if (document.getElementById('startWorkoutBtn')) {
            document.getElementById('startWorkoutBtn').addEventListener('click', function() {
                // Scroll suave a la secci√≥n de rutinas
                const rutinasSection = document.querySelector('[data-grupo]').closest('section');
                if (rutinasSection) {
                    rutinasSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }

        // Quick Actions buttons
        document.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                switchTab(action);
            });
        });

        document.getElementById('saveButton').addEventListener('click', saveToLocalStorage);
        document.getElementById('closeModal').addEventListener('click', closeAnimationModal);
        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        // Tab navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        // NOTE: bottom-nav-item event listeners already added above (lines 1839-1858) using data-nav
        // Removed duplicate event listener that was using incorrect data-tab attribute

        // Rest timer
        document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
        document.getElementById('stopTimer').addEventListener('click', stopTimer);
        document.getElementById('closeRestModal').addEventListener('click', () => {
            document.getElementById('restTimerModal').classList.remove('active');
        });

        document.querySelectorAll('.rest-time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                initializeTimer(parseInt(btn.dataset.seconds));
            });
        });

        // Modal close on outside click
        document.getElementById('animationModal').addEventListener('click', (e) => {
            if (e.target.id === 'animationModal') {
                closeAnimationModal();
            }
        });

        document.getElementById('restTimerModal').addEventListener('click', (e) => {
            if (e.target.id === 'restTimerModal') {
                document.getElementById('restTimerModal').classList.remove('active');
            }
        });

        document.getElementById('statsBtn').addEventListener('click', () => {
            switchTab('prs');
        });

        // Export to Excel button
        document.getElementById('exportToExcelBtn').addEventListener('click', exportToExcel);

        // Profile form
        document.getElementById('profileForm').addEventListener('submit', saveProfile);
        document.getElementById('profileBirthdate').addEventListener('change', calculateAge);

        // Load profile when switching to profile tab
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            if (tabName === 'profile') {
                loadProfile();
            } else if (tabName === 'calculators') {
                // Auto-fill calories calculator when switching to calculators
                setTimeout(() => {
                    const profile = JSON.parse(localStorage.getItem('gymmate_profile') || '{}');
                    if (Object.keys(profile).length > 0) {
                        // Profile exists - could show a button to prefill
                    }
                }, 100);
            }
        };

        // Warning al cerrar navegador con cambios sin guardar
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedData()) {
                e.preventDefault();
                e.returnValue = ''; // Necesario para Chrome
                return ''; // Para otros navegadores
            }
        });

        // Verificar si hay draft al cargar
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkForDraft();
                updateHeroSection(); // Actualizar Hero Section al cargar
            }, 1000); // Esperar 1 segundo para que cargue todo
        });

        // ==========================================
        // CHART.JS - PROGRESS GRAPHS
        // ==========================================

        let volumeTrendChart = null;
        let muscleDistributionChart = null;
        let weightProgressChart = null;
        let weeklyComparisonChart = null;

        function initializeCharts() {
            // Destroy existing charts
            if (volumeTrendChart) volumeTrendChart.destroy();
            if (muscleDistributionChart) muscleDistributionChart.destroy();
            if (weightProgressChart) weightProgressChart.destroy();
            if (weeklyComparisonChart) weeklyComparisonChart.destroy();

            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            if (history.length === 0) {
                console.log('No hay datos para gr√°ficos');
                return;
            }

            // 1. Volume Trend Chart
            createVolumeTrendChart(history);

            // 2. Muscle Distribution Chart
            createMuscleDistributionChart(history);

            // 3. Weight Progress Chart (populated after exercise selection)
            populateExerciseDropdown(history);

            // 4. Weekly Comparison Chart
            createWeeklyComparisonChart(history);
        }

        function createVolumeTrendChart(history) {
            const ctx = document.getElementById('volumeTrendChart');
            if (!ctx) return;

            // Get last 30 sessions
            const last30 = history.slice(0, 30).reverse();

            const dates = last30.map(s => new Date(s.savedAt || s.date).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
            const volumes = last30.map(s => s.volumenTotal);

            volumeTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Volumen Total',
                        data: volumes,
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volumen'
                            }
                        }
                    }
                }
            });
        }

        function createMuscleDistributionChart(history) {
            const ctx = document.getElementById('muscleDistributionChart');
            if (!ctx) return;

            // Aggregate volume by muscle group across all history
            const muscleVolumes = {};
            history.forEach(session => {
                Object.entries(session.volumenPorGrupo || {}).forEach(([muscle, volume]) => {
                    muscleVolumes[muscle] = (muscleVolumes[muscle] || 0) + volume;
                });
            });

            const muscles = Object.keys(muscleVolumes);
            const volumes = Object.values(muscleVolumes);

            muscleDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: muscles,
                    datasets: [{
                        data: volumes,
                        backgroundColor: [
                            '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function populateExerciseDropdown(history) {
            const dropdown = document.getElementById('exerciseChartSelect');
            if (!dropdown) return;

            // Get all unique exercises - filtrar solo sesiones de pesas
            const exercises = new Set();
            history.forEach(session => {
                // Solo procesar sesiones que tienen ejercicios (pesas, no cardio)
                if (session.ejercicios && Array.isArray(session.ejercicios)) {
                    session.ejercicios.forEach(ej => {
                        if (ej.peso > 0) {
                            exercises.add(ej.nombre);
                        }
                    });
                }
            });

            dropdown.innerHTML = '<option value="">-- Elige un ejercicio --</option>';
            Array.from(exercises).sort().forEach(exercise => {
                const option = document.createElement('option');
                option.value = exercise;
                option.textContent = exercise;
                dropdown.appendChild(option);
            });

            dropdown.addEventListener('change', (e) => {
                if (e.target.value) {
                    createWeightProgressChart(history, e.target.value);
                }
            });
        }

        function createWeightProgressChart(history, exerciseName) {
            const ctx = document.getElementById('weightProgressChart');
            if (!ctx) return;

            if (weightProgressChart) weightProgressChart.destroy();

            // Get weight data for this exercise - solo sesiones con ejercicios
            const exerciseData = [];
            history.slice(0, 30).reverse().forEach(session => {
                // Solo procesar sesiones de pesas que tienen ejercicios
                if (session.ejercicios && Array.isArray(session.ejercicios)) {
                    const exercise = session.ejercicios.find(ej => ej.nombre === exerciseName);
                    if (exercise && exercise.peso > 0) {
                        exerciseData.push({
                            date: new Date(session.savedAt || session.date).toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }),
                            peso: exercise.peso,
                            sets: exercise.sets,
                            reps: exercise.reps
                        });
                    }
                }
            });

            if (exerciseData.length === 0) {
                ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
                return;
            }

            const dates = exerciseData.map(d => d.date);
            const pesos = exerciseData.map(d => d.peso);

            weightProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: `Peso (kg) - ${exerciseName}`,
                        data: pesos,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const dataPoint = exerciseData[context.dataIndex];
                                    return `Peso: ${dataPoint.peso}kg (${dataPoint.sets}√ó${dataPoint.reps})`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Peso (kg)'
                            }
                        }
                    }
                }
            });
        }

        function createWeeklyComparisonChart(history) {
            const ctx = document.getElementById('weeklyComparisonChart');
            if (!ctx) return;

            // Group by week
            const weeklyData = {};
            history.forEach(session => {
                const date = new Date(session.savedAt || session.date);
                const week = getWeekNumber(date);
                const weekKey = `Semana ${week}`;

                if (!weeklyData[weekKey]) {
                    weeklyData[weekKey] = 0;
                }
                weeklyData[weekKey] += session.volumenTotal;
            });

            const weeks = Object.keys(weeklyData).slice(0, 8).reverse();
            const volumes = weeks.map(w => weeklyData[w]);

            weeklyComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'Volumen Semanal',
                        data: volumes,
                        backgroundColor: '#8B5CF6',
                        borderColor: '#7C3AED',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Volumen Total'
                            }
                        }
                    }
                }
            });
        }

        function getWeekNumber(date) {
            const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
            const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
            return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        }

        // ==========================================
        // AI SUGGESTIONS SYSTEM
        // ==========================================

        function generateAISuggestions() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            if (history.length < 3) {
                return; // Need at least 3 sessions for meaningful suggestions
            }

            const suggestions = [];

            // 1. Check for stagnation in weight progression
            const weightSuggestion = checkWeightStagnation(history);
            if (weightSuggestion) suggestions.push(weightSuggestion);

            // 2. Check for volume drops
            const volumeSuggestion = checkVolumeDrop(history);
            if (volumeSuggestion) suggestions.push(volumeSuggestion);

            // 3. Check for muscle group imbalances
            const balanceSuggestion = checkMuscleImbalance(history);
            if (balanceSuggestion) suggestions.push(balanceSuggestion);

            // 4. Check for rest days needed
            const restSuggestion = checkRestNeeded(history);
            if (restSuggestion) suggestions.push(restSuggestion);

            // Show first suggestion
            if (suggestions.length > 0) {
                showAISuggestion(suggestions[0]);
            }
        }

        function checkWeightStagnation(history) {
            // Get last 3 sessions for each exercise - solo sesiones de pesas
            const exerciseProgress = {};

            history.slice(0, 5).forEach(session => {
                // Solo procesar sesiones que tienen ejercicios (pesas, no cardio)
                if (session.ejercicios && Array.isArray(session.ejercicios)) {
                    session.ejercicios.forEach(ej => {
                        if (!exerciseProgress[ej.nombre]) {
                            exerciseProgress[ej.nombre] = [];
                        }
                        if (ej.peso > 0) {
                            exerciseProgress[ej.nombre].push(ej.peso);
                        }
                    });
                }
            });

            // Find stagnant exercises (same weight for 3+ sessions)
            for (const [exercise, weights] of Object.entries(exerciseProgress)) {
                if (weights.length >= 3) {
                    const lastThree = weights.slice(0, 3);
                    const allSame = lastThree.every(w => w === lastThree[0]);

                    if (allSame && lastThree[0] > 0) {
                        const suggestedIncrease = lastThree[0] <= 20 ? 2.5 : 5;
                        return `üí™ Progresi√≥n detectada: Has usado ${lastThree[0]}kg en ${exercise} las √∫ltimas 3 sesiones. Considera incrementar a ${(lastThree[0] + suggestedIncrease).toFixed(1)}kg`;
                    }
                }
            }

            return null;
        }

        function checkVolumeDrop(history) {
            if (history.length < 2) return null;

            const lastSession = history[0];
            const previousSessions = history.slice(1, 4);
            const avgPreviousVolume = previousSessions.reduce((sum, s) => sum + s.volumenTotal, 0) / previousSessions.length;

            if (lastSession.volumenTotal < avgPreviousVolume * 0.7) {
                return `üìâ Volumen bajo: Tu √∫ltimo entreno tuvo ${lastSession.volumenTotal.toFixed(0)} de volumen, un ${((1 - lastSession.volumenTotal / avgPreviousVolume) * 100).toFixed(0)}% menos que tu promedio. ¬øNecesitas m√°s descanso?`;
            }

            return null;
        }

        function checkMuscleImbalance(history) {
            const muscleVolumes = {};

            history.slice(0, 10).forEach(session => {
                Object.entries(session.volumenPorGrupo || {}).forEach(([muscle, volume]) => {
                    muscleVolumes[muscle] = (muscleVolumes[muscle] || 0) + volume;
                });
            });

            const muscles = Object.keys(muscleVolumes);
            if (muscles.length < 2) return null;

            const maxVolume = Math.max(...Object.values(muscleVolumes));
            const minVolume = Math.min(...Object.values(muscleVolumes));

            if (maxVolume / minVolume > 3) {
                const undertrainedMuscle = Object.entries(muscleVolumes).find(([_, vol]) => vol === minVolume)[0];
                return `‚öñÔ∏è Desequilibrio detectado: ${undertrainedMuscle} tiene solo el ${((minVolume / maxVolume) * 100).toFixed(0)}% del volumen de tu grupo muscular m√°s entrenado. Considera a√±adir m√°s trabajo de ${undertrainedMuscle}.`;
            }

            return null;
        }

        function checkRestNeeded(history) {
            if (history.length < 7) return null;

            // Check if trained 7 days in a row
            const last7Days = history.slice(0, 7);
            const dates = last7Days.map(s => new Date(s.savedAt || s.date).toDateString());
            const uniqueDates = new Set(dates);

            if (uniqueDates.size >= 6) {
                return `üõë Descanso recomendado: Has entrenado ${uniqueDates.size} de los √∫ltimos 7 d√≠as. Considera tomar un d√≠a de descanso para optimizar recuperaci√≥n.`;
            }

            return null;
        }

        function showAISuggestion(suggestion) {
            const banner = document.getElementById('aiSuggestionsBanner');
            const text = document.getElementById('aiSuggestionText');

            if (banner && text) {
                text.textContent = suggestion;
                banner.classList.remove('hidden');
            }
        }

        function dismissAISuggestion() {
            const banner = document.getElementById('aiSuggestionsBanner');
            if (banner) {
                banner.classList.add('hidden');
            }
        }

        // ==========================================
        // CALCULATORS - 1RM, CALORIES, PROGRESSIVE
        // ==========================================

        function calculate1RM(exerciseName) {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            // Find best performance for this exercise - solo sesiones de pesas
            let bestPerformance = null;
            let maxWeight = 0;

            history.forEach(session => {
                // Solo procesar sesiones que tienen ejercicios
                if (session.ejercicios && Array.isArray(session.ejercicios)) {
                    const exercise = session.ejercicios.find(ej => ej.nombre === exerciseName);
                    if (exercise && exercise.peso > 0) {
                        if (exercise.peso > maxWeight ||
                            (exercise.peso === maxWeight && exercise.reps > (bestPerformance?.reps || 0))) {
                            maxWeight = exercise.peso;
                            bestPerformance = exercise;
                        }
                    }
                }
            });

            if (!bestPerformance) {
                return null;
            }

            const peso = bestPerformance.peso;
            const reps = bestPerformance.reps;

            // Three 1RM formulas
            const epley = peso * (1 + reps / 30);
            const brzycki = peso * (36 / (37 - reps));
            const lombardi = peso * Math.pow(reps, 0.1);

            return {
                bestPerformance,
                epley: epley.toFixed(1),
                brzycki: brzycki.toFixed(1),
                lombardi: lombardi.toFixed(1),
                average: ((epley + brzycki + lombardi) / 3).toFixed(1)
            };
        }

        function calculateCalories() {
            const age = parseFloat(document.getElementById('caloriesAge').value);
            const gender = document.getElementById('caloriesGender').value;
            const weight = parseFloat(document.getElementById('caloriesWeight').value);
            const height = parseFloat(document.getElementById('caloriesHeight').value);
            const activity = parseFloat(document.getElementById('caloriesActivity').value);

            if (!age || !weight || !height) {
                alert('Por favor completa todos los campos');
                return;
            }

            // Mifflin-St Jeor formula
            let bmr;
            if (gender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }

            const tdee = bmr * activity;
            const deficit = tdee * 0.8;
            const surplus = tdee * 1.2;

            document.getElementById('bmrResult').textContent = Math.round(bmr);
            document.getElementById('tdeeResult').textContent = Math.round(tdee);
            document.getElementById('deficitResult').textContent = Math.round(deficit) + ' kcal';
            document.getElementById('maintenanceResult').textContent = Math.round(tdee) + ' kcal';
            document.getElementById('surplusResult').textContent = Math.round(surplus) + ' kcal';

            document.getElementById('caloriesResults').classList.remove('hidden');
        }

        function calculateProgressive(exerciseName) {
            const prs = JSON.parse(localStorage.getItem('gymmate_prs') || '{}');
            const exercisePR = prs[exerciseName];

            if (!exercisePR) {
                return null;
            }

            const currentWeight = exercisePR.peso;

            // Detect if upper or lower body based on exercise name
            const lowerBodyKeywords = ['squat', 'prensa', 'leg', 'pierna', 'rdl', 'hip thrust', 'zancada', 'hack', 'cu√°driceps', 'femoral', 'gl√∫teo', 'aduc', 'abduc'];
            const isLowerBody = lowerBodyKeywords.some(keyword => exerciseName.toLowerCase().includes(keyword));

            // ACSM recommendations: 2-10% increase
            // NSCA: Upper body 2.5-5kg, Lower body 5-10kg
            let conservative, moderate, aggressive;

            if (isLowerBody) {
                // Lower body: larger increments (NSCA: 5-10kg)
                conservative = currentWeight * 1.025;  // 2.5% (ACSM low end)
                moderate = currentWeight * 1.075;      // 7.5% (ACSM mid range)
                aggressive = currentWeight * 1.10;     // 10% (NSCA aggressive)
            } else {
                // Upper body: smaller increments (NSCA: 2.5-5kg)
                conservative = currentWeight * 1.025;  // 2.5% (ACSM low end)
                moderate = currentWeight * 1.05;       // 5% (ACSM standard)
                aggressive = currentWeight * 1.075;    // 7.5% (upper limit for upper body)
            }

            // Redondear a m√∫ltiplos de 2.5kg (com√∫n en gimnasios)
            // Pero sin forzar m√≠nimo, para que los porcentajes se reflejen correctamente
            const roundTo2_5 = (weight) => Math.ceil(weight / 2.5) * 2.5;

            conservative = roundTo2_5(conservative);
            moderate = roundTo2_5(moderate);
            aggressive = roundTo2_5(aggressive);

            return {
                current: currentWeight,
                conservative: conservative.toFixed(1),
                moderate: moderate.toFixed(1),
                aggressive: aggressive.toFixed(1),
                exerciseType: isLowerBody ? 'Tren Inferior' : 'Tren Superior'
            };
        }

        // Populate calculator dropdowns when calculators tab is opened
        function populateCalculatorDropdowns() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            // Get all unique exercises - solo de sesiones de pesas
            const exercises = new Set();
            history.forEach(session => {
                // Solo procesar sesiones que tienen ejercicios (pesas, no cardio)
                if (session.ejercicios && Array.isArray(session.ejercicios)) {
                    session.ejercicios.forEach(ej => {
                        if (ej.peso > 0) {
                            exercises.add(ej.nombre);
                        }
                    });
                }
            });

            const exerciseArray = Array.from(exercises).sort();

            // Populate 1RM dropdown
            const rm1Select = document.getElementById('rm1ExerciseSelect');
            rm1Select.innerHTML = '<option value="">-- Elige un ejercicio --</option>';
            exerciseArray.forEach(ex => {
                const option = document.createElement('option');
                option.value = ex;
                option.textContent = ex;
                rm1Select.appendChild(option);
            });

            // Populate Progressive dropdown
            const progressiveSelect = document.getElementById('progressiveExerciseSelect');
            progressiveSelect.innerHTML = '<option value="">-- Elige un ejercicio --</option>';
            exerciseArray.forEach(ex => {
                const option = document.createElement('option');
                option.value = ex;
                option.textContent = ex;
                progressiveSelect.appendChild(option);
            });

            // Event listeners
            rm1Select.addEventListener('change', (e) => {
                if (e.target.value) {
                    const result = calculate1RM(e.target.value);
                    if (result) {
                        document.getElementById('rm1BestRecord').textContent =
                            `${result.bestPerformance.peso}kg √ó ${result.bestPerformance.reps} reps (${result.bestPerformance.sets} sets)`;
                        document.getElementById('rm1Epley').textContent = result.epley;
                        document.getElementById('rm1Brzycki').textContent = result.brzycki;
                        document.getElementById('rm1Lombardi').textContent = result.lombardi;
                        document.getElementById('rm1Results').classList.remove('hidden');
                    }
                }
            });

            progressiveSelect.addEventListener('change', (e) => {
                if (e.target.value) {
                    const result = calculateProgressive(e.target.value);
                    if (result) {
                        document.getElementById('progressiveCurrentWeight').textContent = `${result.current}kg`;
                        document.getElementById('progressiveExerciseType').textContent = result.exerciseType;
                        document.getElementById('progressiveConservative').textContent = `${result.conservative}kg`;
                        document.getElementById('progressiveModerate').textContent = `${result.moderate}kg`;
                        document.getElementById('progressiveAggressive').textContent = `${result.aggressive}kg`;
                        document.getElementById('progressiveResults').classList.remove('hidden');
                    }
                }
            });
        }

        // ==========================================
        // EXPORT TO REAL EXCEL (.XLSX)
        // ==========================================

        function exportToExcel() {
            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');

            if (history.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // Prepare data for Excel
            const excelData = [];

            // Headers
            excelData.push(['Fecha', 'Grupo', 'Ejercicio', 'Sets', 'Reps', 'Peso (kg)', 'Es Mancuerna', 'Grupo Muscular', 'Volumen', 'Completado', 'Volumen Total Sesi√≥n']);

            // Data rows - solo exportar sesiones de pesas
            history.forEach(session => {
                // Solo exportar sesiones que tienen ejercicios (pesas, no cardio)
                if (session.ejercicios && Array.isArray(session.ejercicios)) {
                    const fecha = new Date(session.savedAt || session.date).toLocaleDateString('es-ES');
                    const grupo = session.grupo;
                    const volumenTotalSesion = session.volumenTotal;

                    session.ejercicios.forEach(ej => {
                        if (ej.volumen > 0) {
                            excelData.push([
                                fecha,
                                grupo,
                                ej.nombre,
                                ej.sets,
                                ej.reps,
                                ej.peso,
                                ej.esMancuerna ? 'S√≠' : 'No',
                                ej.grupoMuscular,
                                ej.volumen,
                                ej.completado ? 'S√≠' : 'No',
                                volumenTotalSesion
                            ]);
                        }
                    });
                }
            });

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);

            // Set column widths
            ws['!cols'] = [
                { wch: 12 },  // Fecha
                { wch: 30 },  // Grupo
                { wch: 30 },  // Ejercicio
                { wch: 8 },   // Sets
                { wch: 8 },   // Reps
                { wch: 10 },  // Peso
                { wch: 15 },  // Es Mancuerna
                { wch: 18 },  // Grupo Muscular
                { wch: 10 },  // Volumen
                { wch: 12 },  // Completado
                { wch: 18 }   // Volumen Total
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Historial de Entrenos');

            // Generate Excel file and download
            XLSX.writeFile(wb, `GymMate_Historial_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ==========================================
        // PWA & NOTIFICATIONS
        // ==========================================

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => {
                console.log('Service worker registration failed');
            });
        }

        // ==========================================
        // INITIALIZATION
        // ==========================================

        // Set max date for birthdate input (today)
        const today = new Date().toISOString().split('T')[0];
        const birthdateInput = document.getElementById('profileBirthdate');
        if (birthdateInput) {
            birthdateInput.setAttribute('max', today);
            // Set min to 100 years ago (reasonable limit)
            const minDate = new Date();
            minDate.setFullYear(minDate.getFullYear() - 100);
            birthdateInput.setAttribute('min', minDate.toISOString().split('T')[0]);
        }

        loadDarkMode();
        loadHistory();
        loadPRs();
        loadCustomWorkoutsInHome();

        // Style tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.className = 'tab-btn p-3 rounded-lg font-semibold text-sm transition-all';
            if (btn.classList.contains('active')) {
                btn.classList.add('bg-blue-500', 'text-white');
            } else {
                btn.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
            }
        });

        // ==========================================
        // CARDIO HIIT SYSTEM
        // ==========================================

        // Biblioteca de ejercicios cardio
        const cardioExercises = {
            'Burpees': { difficulty: 5, calories: 12, muscles: ['Todo el cuerpo'], desc: 'De pie ‚Üí plancha ‚Üí push-up ‚Üí salto. M√°xima intensidad.' },
            'Mountain Climbers': { difficulty: 4, calories: 10, muscles: ['Core', 'Hombros'], desc: 'Plancha alta, lleva rodillas al pecho alternadas r√°pido.' },
            'Jumping Jacks': { difficulty: 3, calories: 8, muscles: ['Cardio', 'Piernas'], desc: 'Salta abriendo piernas y brazos arriba simult√°neamente.' },
            'High Knees': { difficulty: 3, calories: 9, muscles: ['Piernas', 'Cardio'], desc: 'Corre en el lugar elevando rodillas al m√°ximo.' },
            'Kettlebell Swings': { difficulty: 4, calories: 12, muscles: ['Gl√∫teos', 'Core', 'Hombros'], desc: 'Balanceo explosivo desde cadera hasta altura de hombros. Usa las caderas.' },
            'Russian Twists': { difficulty: 3, calories: 6, muscles: ['Oblicuos', 'Core'], desc: 'Sentado, torso inclinado, rota de lado a lado. Pies arriba para m√°s dificultad.' },
            'Plank': { difficulty: 3, calories: 4, muscles: ['Core completo'], desc: 'Posici√≥n push-up sobre antebrazos. Cuerpo recto, core apretado.' },
            'Jump Squats': { difficulty: 4, calories: 11, muscles: ['Piernas', 'Gl√∫teos'], desc: 'Sentadilla profunda + salto explosivo. Aterriza suave.' },
            'Box Jumps': { difficulty: 4, calories: 10, muscles: ['Piernas', 'Explosividad'], desc: 'Salta sobre una caja/plataforma. Aterriza suave, baja controlado.' },
            'Battle Ropes': { difficulty: 4, calories: 11, muscles: ['Hombros', 'Core', 'Cardio'], desc: 'Ondas alternadas con cuerdas. Mant√©n ritmo constante.' },
            'Sprints': { difficulty: 4, calories: 13, muscles: ['Piernas', 'Cardio'], desc: 'Carrera a m√°xima velocidad.' },
            'Bicycle Crunches': { difficulty: 3, calories: 5, muscles: ['Core', 'Oblicuos'], desc: 'Acostado, lleva codo a rodilla opuesta alternando.' }
        };

        // Estado global del sistema cardio
        let cardioState = {
            mode: null, // 'emom', 'tabata', 'circuit', 'pyramid', 'custom', 'amrap', 'fortime'
            config: {},
            timer: null,
            isPaused: false,
            currentPhase: 'work', // 'work', 'rest', 'roundRest'
            currentRound: 1,
            currentExerciseIndex: 0,
            timeRemaining: 0,
            totalTimeElapsed: 0,
            workTimeTotal: 0,
            restTimeTotal: 0,
            startTime: null
        };

        // ==========================================
        // NAVEGACI√ìN ENTRE VISTAS
        // ==========================================

        function showCardioSelector() {
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('cardioSelectorView').classList.remove('hidden');
            document.getElementById('cardioConfigView').classList.add('hidden');
            document.getElementById('cardioTimerView').classList.add('hidden');
            document.getElementById('cardioSummaryView').classList.add('hidden');
        }

        function showCardioConfig(mode) {
            cardioState.mode = mode;
            document.getElementById('cardioSelectorView').classList.add('hidden');
            document.getElementById('cardioConfigView').classList.remove('hidden');
            document.getElementById('cardioTimerView').classList.add('hidden');
            document.getElementById('cardioSummaryView').classList.add('hidden');

            // Configurar UI seg√∫n el modo
            const title = document.getElementById('cardioConfigTitle');
            const content = document.getElementById('cardioConfigContent');

            const modeConfigs = {
                'emom': { title: '‚è±Ô∏è CONFIGURAR EMOM', html: generateEMOMConfig() },
                'tabata': { title: 'üî• CONFIGURAR TABATA', html: generateTabataConfig() },
                'circuit': { title: 'üîÑ CONFIGURAR CIRCUITO', html: generateCircuitConfig() },
                'pyramid': { title: 'üìä CONFIGURAR PIR√ÅMIDE', html: generatePyramidConfig() },
                'custom': { title: '‚öôÔ∏è CONFIGURAR HIIT CUSTOM', html: generateCustomConfig() },
                'amrap': { title: 'üéØ CONFIGURAR AMRAP', html: generateAMRAPConfig() },
                'fortime': { title: 'üèÅ CONFIGURAR FOR TIME', html: generateForTimeConfig() }
            };

            const config = modeConfigs[mode];
            title.textContent = config.title;
            content.innerHTML = config.html;
        }

        // ==========================================
        // GENERADORES DE CONFIGURACI√ìN
        // ==========================================

        function generateCircuitConfig() {
            return `
                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">‚öôÔ∏è Configuraci√≥n</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üîÑ N√∫mero de Rondas</label>
                            <input type="number" id="circuitRounds" value="3" min="1" max="10" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üòÆ‚Äçüí® Descanso entre Rondas (segundos)</label>
                            <input type="number" id="circuitRest" value="90" min="0" max="300" step="15" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">üéØ Ejercicios del Circuito</h3>
                    <div id="circuitExercisesList" class="space-y-3">
                        ${generateExerciseItem(0, 'Kettlebell Swings', 30, 'reps')}
                        ${generateExerciseItem(1, 'Russian Twists', 20, 'reps')}
                        ${generateExerciseItem(2, 'Plank', 30, 'time')}
                    </div>
                    <button onclick="addCircuitExercise()" class="w-full mt-3 glass-card p-3 text-cyan-400 font-semibold rounded-lg active:scale-95 transition-transform">
                        + Agregar Ejercicio
                    </button>
                </div>
            `;
        }

        function generateTabataConfig() {
            return `
                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">‚öôÔ∏è Configuraci√≥n</h3>
                    <p class="text-sm text-gray-400 mb-4">Tabata Cl√°sico: 20s trabajo / 10s descanso</p>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üî• Trabajo (segundos)</label>
                            <input type="number" id="tabataWork" value="20" min="10" max="60" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üòÆ‚Äçüí® Descanso (segundos)</label>
                            <input type="number" id="tabataRest" value="10" min="5" max="30" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üîÑ N√∫mero de Rondas</label>
                            <input type="number" id="tabataRounds" value="8" min="4" max="12" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">üéØ Ejercicio</h3>
                    <select id="tabataExercise" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        ${Object.keys(cardioExercises).map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                    </select>
                </div>
            `;
        }

        function generateCustomConfig() {
            return `
                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">‚öôÔ∏è Intervalos</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üî• Trabajo (segundos)</label>
                            <input type="number" id="customWork" value="45" min="10" max="120" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üòÆ‚Äçüí® Descanso (segundos)</label>
                            <input type="number" id="customRest" value="15" min="5" max="60" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üîÑ Rondas</label>
                            <input type="number" id="customRounds" value="6" min="3" max="20" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">üéØ Ejercicios</h3>
                    <div id="customExercisesList">
                        <select class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white mb-2">
                            ${Object.keys(cardioExercises).map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        function generatePyramidConfig() {
            return `
                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">üìä Dise√±o de Pir√°mide</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Valor inicial (segundos)</label>
                            <input type="number" id="pyramidStart" value="40" min="20" max="60" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Incremento (segundos)</label>
                            <input type="number" id="pyramidIncrement" value="10" min="5" max="20" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Pico m√°ximo (segundos)</label>
                            <input type="number" id="pyramidPeak" value="60" min="30" max="120" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Descanso entre niveles</label>
                            <input type="number" id="pyramidRest" value="15" min="10" max="30" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">üéØ Ejercicio</h3>
                    <select id="pyramidExercise" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        ${Object.keys(cardioExercises).map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                    </select>
                </div>
            `;
        }

        function generateEMOMConfig() {
            return `
                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">‚öôÔ∏è Configuraci√≥n</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">‚è±Ô∏è Duraci√≥n del intervalo (segundos)</label>
                            <input type="number" id="emomInterval" value="60" min="30" max="120" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">üîÑ N√∫mero de rondas</label>
                            <input type="number" id="emomRounds" value="10" min="5" max="20" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                        </div>
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">üéØ Ejercicio</h3>
                    <select id="emomExercise" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white mb-3">
                        ${Object.keys(cardioExercises).map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                    </select>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">Repeticiones objetivo</label>
                        <input type="number" id="emomReps" value="15" min="5" max="50" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                    </div>
                </div>
            `;
        }

        function generateAMRAPConfig() {
            return `
                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">‚öôÔ∏è Configuraci√≥n</h3>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">‚è±Ô∏è Duraci√≥n total (minutos)</label>
                        <input type="number" id="amrapDuration" value="10" min="5" max="30" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">üéØ Circuito (Repetir tantas veces como sea posible)</h3>
                    <div id="amrapExercisesList" class="space-y-3">
                        ${generateExerciseItem(0, 'Burpees', 10, 'reps')}
                        ${generateExerciseItem(1, 'Mountain Climbers', 20, 'reps')}
                    </div>
                    <button onclick="addAMRAPExercise()" class="w-full mt-3 glass-card p-3 text-cyan-400 font-semibold rounded-lg active:scale-95 transition-transform">
                        + Agregar Ejercicio
                    </button>
                </div>
            `;
        }

        function generateForTimeConfig() {
            return `
                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">‚öôÔ∏è Configuraci√≥n</h3>
                    <div>
                        <label class="block text-sm text-gray-300 mb-2">üîÑ Rondas a completar</label>
                        <input type="number" id="fortimeRounds" value="5" min="3" max="10" class="w-full px-4 py-3 bg-dark-surface border border-white/10 rounded-lg text-white">
                    </div>
                </div>

                <div class="glass-card p-5">
                    <h3 class="text-lg font-bold text-white mb-4">üéØ Ejercicios por ronda</h3>
                    <div id="fortimeExercisesList" class="space-y-3">
                        ${generateExerciseItem(0, 'Burpees', 15, 'reps')}
                        ${generateExerciseItem(1, 'Jump Squats', 20, 'reps')}
                    </div>
                    <button onclick="addForTimeExercise()" class="w-full mt-3 glass-card p-3 text-cyan-400 font-semibold rounded-lg active:scale-95 transition-transform">
                        + Agregar Ejercicio
                    </button>
                </div>
            `;
        }

        function generateExerciseItem(index, name, target, type) {
            const exerciseOptions = Object.keys(cardioExercises).map(ex =>
                `<option value="${ex}" ${ex === name ? 'selected' : ''}>${ex}</option>`
            ).join('');

            return `
                <div class="glass-card p-4 border border-white/10">
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-white font-bold">${index + 1}.</span>
                        <button onclick="removeExercise(${index})" class="text-red-400 hover:text-red-300">
                            <i class="ph-bold ph-x text-xl"></i>
                        </button>
                    </div>
                    <select class="w-full px-3 py-2 bg-dark-surface border border-white/10 rounded-lg text-white mb-2" data-exercise-index="${index}">
                        ${exerciseOptions}
                    </select>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" value="${target}" min="5" max="100" placeholder="Cantidad" class="px-3 py-2 bg-dark-surface border border-white/10 rounded-lg text-white" data-target-index="${index}">
                        <select class="px-3 py-2 bg-dark-surface border border-white/10 rounded-lg text-white" data-type-index="${index}">
                            <option value="reps" ${type === 'reps' ? 'selected' : ''}>Reps</option>
                            <option value="time" ${type === 'time' ? 'selected' : ''}>Segundos</option>
                        </select>
                    </div>
                </div>
            `;
        }

        function addCircuitExercise() {
            const container = document.getElementById('circuitExercisesList');
            const count = container.children.length;
            container.insertAdjacentHTML('beforeend', generateExerciseItem(count, 'Jumping Jacks', 20, 'reps'));
        }

        function addAMRAPExercise() {
            const container = document.getElementById('amrapExercisesList');
            const count = container.children.length;
            container.insertAdjacentHTML('beforeend', generateExerciseItem(count, 'High Knees', 30, 'reps'));
        }

        function addForTimeExercise() {
            const container = document.getElementById('fortimeExercisesList');
            const count = container.children.length;
            container.insertAdjacentHTML('beforeend', generateExerciseItem(count, 'Mountain Climbers', 25, 'reps'));
        }

        function removeExercise(index) {
            // Implementar l√≥gica de eliminaci√≥n si es necesario
            console.log('Remove exercise', index);
        }

        // ==========================================
        // SISTEMA DE TIMER
        // ==========================================

        function startCardioTimer() {
            // Recoger configuraci√≥n seg√∫n el modo
            const config = collectConfiguration();
            if (!config) {
                alert('‚ö†Ô∏è Por favor completa la configuraci√≥n');
                return;
            }

            cardioState.config = config;
            cardioState.currentRound = 1;
            cardioState.currentExerciseIndex = 0;
            cardioState.totalTimeElapsed = 0;
            cardioState.workTimeTotal = 0;
            cardioState.restTimeTotal = 0;
            cardioState.startTime = Date.now();

            // Mostrar vista de timer
            document.getElementById('cardioSelectorView').classList.add('hidden');
            document.getElementById('cardioConfigView').classList.add('hidden');
            document.getElementById('cardioTimerView').classList.remove('hidden');
            document.getElementById('cardioSummaryView').classList.add('hidden');

            // Iniciar primera fase
            startNextPhase();
        }

        function collectConfiguration() {
            const mode = cardioState.mode;

            if (mode === 'circuit') {
                const exercises = [];
                const container = document.getElementById('circuitExercisesList');
                for (let i = 0; i < container.children.length; i++) {
                    const card = container.children[i];
                    const exerciseName = card.querySelector('[data-exercise-index]').value;
                    const target = parseInt(card.querySelector('[data-target-index]').value);
                    const type = card.querySelector('[data-type-index]').value;
                    exercises.push({ name: exerciseName, target, type });
                }

                return {
                    rounds: parseInt(document.getElementById('circuitRounds').value),
                    roundRest: parseInt(document.getElementById('circuitRest').value),
                    exercises
                };
            }

            if (mode === 'tabata') {
                return {
                    work: parseInt(document.getElementById('tabataWork').value),
                    rest: parseInt(document.getElementById('tabataRest').value),
                    rounds: parseInt(document.getElementById('tabataRounds').value),
                    exercise: document.getElementById('tabataExercise').value
                };
            }

            if (mode === 'custom') {
                return {
                    work: parseInt(document.getElementById('customWork').value),
                    rest: parseInt(document.getElementById('customRest').value),
                    rounds: parseInt(document.getElementById('customRounds').value),
                    exercise: document.querySelector('#customExercisesList select').value
                };
            }

            if (mode === 'pyramid') {
                const start = parseInt(document.getElementById('pyramidStart').value);
                const increment = parseInt(document.getElementById('pyramidIncrement').value);
                const peak = parseInt(document.getElementById('pyramidPeak').value);
                const rest = parseInt(document.getElementById('pyramidRest').value);

                // Generar niveles de pir√°mide
                const levels = [];
                for (let t = start; t <= peak; t += increment) levels.push(t);
                for (let t = peak - increment; t >= start; t -= increment) levels.push(t);

                return {
                    levels,
                    rest,
                    exercise: document.getElementById('pyramidExercise').value
                };
            }

            if (mode === 'emom') {
                return {
                    interval: parseInt(document.getElementById('emomInterval').value),
                    rounds: parseInt(document.getElementById('emomRounds').value),
                    exercise: document.getElementById('emomExercise').value,
                    reps: parseInt(document.getElementById('emomReps').value)
                };
            }

            if (mode === 'amrap') {
                const exercises = [];
                const container = document.getElementById('amrapExercisesList');
                for (let i = 0; i < container.children.length; i++) {
                    const card = container.children[i];
                    const exerciseName = card.querySelector('[data-exercise-index]').value;
                    const target = parseInt(card.querySelector('[data-target-index]').value);
                    const type = card.querySelector('[data-type-index]').value;
                    exercises.push({ name: exerciseName, target, type });
                }

                return {
                    duration: parseInt(document.getElementById('amrapDuration').value) * 60,
                    exercises
                };
            }

            if (mode === 'fortime') {
                const exercises = [];
                const container = document.getElementById('fortimeExercisesList');
                for (let i = 0; i < container.children.length; i++) {
                    const card = container.children[i];
                    const exerciseName = card.querySelector('[data-exercise-index]').value;
                    const target = parseInt(card.querySelector('[data-target-index]').value);
                    const type = card.querySelector('[data-type-index]').value;
                    exercises.push({ name: exerciseName, target, type });
                }

                return {
                    rounds: parseInt(document.getElementById('fortimeRounds').value),
                    exercises
                };
            }

            return null;
        }

        function startNextPhase() {
            const mode = cardioState.mode;
            const config = cardioState.config;

            if (mode === 'circuit') {
                if (cardioState.currentPhase === 'work') {
                    const exercise = config.exercises[cardioState.currentExerciseIndex];
                    if (exercise.type === 'time') {
                        runTimerPhase('work', exercise.target, exercise.name, exercise.target + ' segundos');
                    } else {
                        runManualPhase('work', exercise.name, exercise.target + ' repeticiones');
                    }
                } else if (cardioState.currentPhase === 'roundRest') {
                    runTimerPhase('rest', config.roundRest, 'Descanso entre rondas', '');
                }
            } else if (mode === 'tabata' || mode === 'custom') {
                if (cardioState.currentPhase === 'work') {
                    runTimerPhase('work', config.work, config.exercise, config.work + 's');
                } else {
                    runTimerPhase('rest', config.rest, 'Descanso', '');
                }
            } else if (mode === 'pyramid') {
                const levelIndex = cardioState.currentRound - 1;
                if (cardioState.currentPhase === 'work') {
                    runTimerPhase('work', config.levels[levelIndex], config.exercise, config.levels[levelIndex] + 's');
                } else {
                    runTimerPhase('rest', config.rest, 'Descanso', '');
                }
            } else if (mode === 'emom') {
                runTimerPhase('emom', config.interval, config.exercise, config.reps + ' reps');
            } else if (mode === 'amrap') {
                const exercise = config.exercises[cardioState.currentExerciseIndex];
                runManualPhase('work', exercise.name, exercise.target + (exercise.type === 'reps' ? ' reps' : 's'));
            } else if (mode === 'fortime') {
                const exercise = config.exercises[cardioState.currentExerciseIndex];
                runManualPhase('work', exercise.name, exercise.target + (exercise.type === 'reps' ? ' reps' : 's'));
            }
        }

        function runTimerPhase(phase, duration, exerciseName, target) {
            cardioState.timeRemaining = duration;
            cardioState.currentPhase = phase;

            updateTimerUI(exerciseName, target, phase);

            cardioState.timer = setInterval(() => {
                cardioState.timeRemaining--;
                cardioState.totalTimeElapsed++;

                if (phase === 'work' || phase === 'emom') {
                    cardioState.workTimeTotal++;
                } else {
                    cardioState.restTimeTotal++;
                }

                updateTimerDisplay();

                if (cardioState.timeRemaining <= 0) {
                    clearInterval(cardioState.timer);
                    advanceToNextPhase();
                }
            }, 1000);
        }

        function runManualPhase(phase, exerciseName, target) {
            cardioState.currentPhase = phase;
            updateTimerUI(exerciseName, target, phase);
            document.getElementById('timerDisplay').textContent = 'Manual';

            // Agregar bot√≥n de completar
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '‚úÖ Marcar como completado';
            nextBtn.className = 'w-full bg-green-600 text-white font-bold py-4 rounded-xl mt-4';
            nextBtn.onclick = () => {
                advanceToNextPhase();
                nextBtn.remove();
            };
            document.getElementById('timerDisplay').parentElement.appendChild(nextBtn);
        }

        function updateTimerUI(exercise, target, phase) {
            document.getElementById('timerExercise').textContent = exercise;
            document.getElementById('timerExerciseTarget').textContent = target;
            document.getElementById('timerPhase').textContent = phase === 'work' ? 'üî• TRABAJO' : 'üòÆ‚Äçüí® DESCANSO';

            const config = cardioState.config;
            let totalRounds = config.rounds || config.levels?.length || 1;
            document.getElementById('timerRoundInfo').textContent = `Ronda ${cardioState.currentRound}/${totalRounds}`;
        }

        function updateTimerDisplay() {
            const mins = Math.floor(cardioState.timeRemaining / 60);
            const secs = cardioState.timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            const totalDuration = cardioState.currentPhase === 'work' ? (cardioState.config.work || cardioState.config.interval || cardioState.config.levels?.[cardioState.currentRound - 1] || 60) : (cardioState.config.rest || cardioState.config.roundRest || 10);
            const progress = ((totalDuration - cardioState.timeRemaining) / totalDuration) * 100;
            document.getElementById('timerProgressBar').style.width = progress + '%';
        }

        function advanceToNextPhase() {
            const mode = cardioState.mode;
            const config = cardioState.config;

            if (mode === 'circuit') {
                if (cardioState.currentPhase === 'work') {
                    cardioState.currentExerciseIndex++;
                    if (cardioState.currentExerciseIndex >= config.exercises.length) {
                        // Ronda completada
                        cardioState.currentExerciseIndex = 0;
                        if (cardioState.currentRound < config.rounds) {
                            cardioState.currentRound++;
                            cardioState.currentPhase = 'roundRest';
                            startNextPhase();
                        } else {
                            finishCardioSession();
                        }
                    } else {
                        startNextPhase();
                    }
                } else {
                    cardioState.currentPhase = 'work';
                    startNextPhase();
                }
            } else if (mode === 'tabata' || mode === 'custom') {
                if (cardioState.currentPhase === 'work') {
                    cardioState.currentPhase = 'rest';
                    startNextPhase();
                } else {
                    cardioState.currentRound++;
                    if (cardioState.currentRound > config.rounds) {
                        finishCardioSession();
                    } else {
                        cardioState.currentPhase = 'work';
                        startNextPhase();
                    }
                }
            } else if (mode === 'pyramid') {
                if (cardioState.currentPhase === 'work') {
                    if (cardioState.currentRound < config.levels.length) {
                        cardioState.currentPhase = 'rest';
                        startNextPhase();
                    } else {
                        finishCardioSession();
                    }
                } else {
                    cardioState.currentRound++;
                    cardioState.currentPhase = 'work';
                    startNextPhase();
                }
            } else if (mode === 'emom') {
                cardioState.currentRound++;
                if (cardioState.currentRound > config.rounds) {
                    finishCardioSession();
                } else {
                    startNextPhase();
                }
            }
            // Otros modos se manejan de forma similar
        }

        function pauseCardioTimer() {
            if (cardioState.timer) {
                clearInterval(cardioState.timer);
                cardioState.isPaused = true;
                document.getElementById('btnPauseTimer').textContent = '‚ñ∂Ô∏è Reanudar';
                document.getElementById('btnPauseTimer').onclick = resumeCardioTimer;
            }
        }

        function resumeCardioTimer() {
            cardioState.isPaused = false;
            document.getElementById('btnPauseTimer').textContent = '‚è∏Ô∏è Pausar';
            document.getElementById('btnPauseTimer').onclick = pauseCardioTimer;

            // Reiniciar timer
            cardioState.timer = setInterval(() => {
                cardioState.timeRemaining--;
                cardioState.totalTimeElapsed++;

                if (cardioState.currentPhase === 'work') {
                    cardioState.workTimeTotal++;
                } else {
                    cardioState.restTimeTotal++;
                }

                updateTimerDisplay();

                if (cardioState.timeRemaining <= 0) {
                    clearInterval(cardioState.timer);
                    advanceToNextPhase();
                }
            }, 1000);
        }

        function stopCardioTimer() {
            if (confirm('¬øEst√°s seguro de que quieres terminar la sesi√≥n?')) {
                if (cardioState.timer) {
                    clearInterval(cardioState.timer);
                }
                finishCardioSession();
            }
        }

        function finishCardioSession() {
            if (cardioState.timer) {
                clearInterval(cardioState.timer);
            }

            // Mostrar resumen
            document.getElementById('cardioSelectorView').classList.add('hidden');
            document.getElementById('cardioConfigView').classList.add('hidden');
            document.getElementById('cardioTimerView').classList.add('hidden');
            document.getElementById('cardioSummaryView').classList.remove('hidden');

            // Llenar estad√≠sticas
            const totalMins = Math.floor(cardioState.totalTimeElapsed / 60);
            const totalSecs = cardioState.totalTimeElapsed % 60;
            const workMins = Math.floor(cardioState.workTimeTotal / 60);
            const workSecs = cardioState.workTimeTotal % 60;
            const restMins = Math.floor(cardioState.restTimeTotal / 60);
            const restSecs = cardioState.restTimeTotal % 60;

            document.getElementById('summaryTotalTime').textContent = `${totalMins}:${totalSecs.toString().padStart(2, '0')}`;
            document.getElementById('summaryWorkTime').textContent = `${workMins}:${workSecs.toString().padStart(2, '0')}`;
            document.getElementById('summaryRestTime').textContent = `${restMins}:${restSecs.toString().padStart(2, '0')}`;

            const config = cardioState.config;
            const totalRounds = config.rounds || config.levels?.length || cardioState.currentRound;
            document.getElementById('summaryRounds').textContent = `${cardioState.currentRound}/${totalRounds}`;

            // Estimaci√≥n de calor√≠as (aproximada)
            const estimatedCalories = Math.round((cardioState.workTimeTotal / 60) * 10);
            document.getElementById('summaryCalories').textContent = `${estimatedCalories} kcal`;

            // Mostrar ejercicios realizados
            const exercisesContainer = document.getElementById('summaryExercises');
            let exercisesHTML = '<h3 class="text-lg font-bold text-white mb-3">Ejercicios realizados:</h3><ul class="space-y-2 text-gray-300">';

            if (config.exercises) {
                config.exercises.forEach(ex => {
                    exercisesHTML += `<li>‚Ä¢ ${ex.name} (${ex.target} ${ex.type === 'reps' ? 'reps' : 's'})</li>`;
                });
            } else if (config.exercise) {
                exercisesHTML += `<li>‚Ä¢ ${config.exercise}</li>`;
            }

            exercisesHTML += '</ul>';
            exercisesContainer.innerHTML = exercisesHTML;
        }

        function saveCardioSession() {
            // Guardar en historial
            const session = {
                type: 'cardio',
                mode: cardioState.mode,
                date: new Date().toISOString(),
                config: cardioState.config,
                stats: {
                    totalTime: cardioState.totalTimeElapsed,
                    workTime: cardioState.workTimeTotal,
                    restTime: cardioState.restTimeTotal,
                    roundsCompleted: cardioState.currentRound,
                    calories: Math.round((cardioState.workTimeTotal / 60) * 10)
                }
            };

            const history = JSON.parse(localStorage.getItem('gymmate_history') || '[]');
            history.unshift(session);
            if (history.length > 50) history.length = 50;
            localStorage.setItem('gymmate_history', JSON.stringify(history));

            alert('‚úÖ Sesi√≥n de cardio guardada en el historial');
            showHome();
            loadHistory();
        }

        console.log('üöÄ GymMate v2.0 Initialized');
        console.log('‚úÖ Mobile-first responsive design');
        console.log('‚úÖ Dynamic muscle group display');
        console.log('‚úÖ Exercise GIFs from ExerciseDB');
        console.log('‚úÖ Rest timer with notifications');
        console.log('‚úÖ PR tracking system');
        console.log('‚úÖ Workout history');
        console.log('‚úÖ Dark mode support');
        console.log('‚úÖ PWA ready');
    </script>
</body>
</html>
